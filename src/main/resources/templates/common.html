<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<script th:src="@{/resource/js/common.js}"></script>

	<title>í˜ì´ì§€ ê¸°ë³¸ í‹€</title>
</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] font-sans">
	<div th:fragment="siteHeader" class="flex h-screen">
		<!-- Sidebar -->
		<aside class="w-20 flex flex-col items-center p-4">
			<img src="https://i.imgur.com/rcOcaL6.png" alt="Logo" class="w-12 mb-6"
				onclick="window.location.href = 'http://localhost:8080/'">

			<!-- í”„ë¡œí•„ ì›í˜• -->
			<div class="w-14 h-14 bg-white rounded-full shrink-0 overflow-hidden" id="memberPhoto">
				
			</div>

			<!-- ë©”ë‰´ ì•„ì´ì½˜ -->
			<div class="flex flex-col gap-10 justify-center h-4/5">

				<div class="menu-item relative group pet_page" data-page="pet">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">pet page</span>
				</div>

				<div class="menu-item relative group my_page" data-page="my">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">my page</span>
				</div>

				<div class="menu-item relative group crew_page" data-page="crew">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">crew page</span>
				</div>

				<div class="menu-item relative group qna_page" data-page="qna">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">qna page</span>
				</div>

				<div id="adminPage" class="menu-item relative group qna_page hidden" data-page="admin">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">ê´€ë¦¬ì í˜ì´ì§€</span>
				</div>
				<div id="vetPage" class="menu-item relative group qna_page hidden" data-page="vet">
					<div id="cat_hand"
						class="absolute top-0 left-[-90px] transition-all duration-500 z-10 pointer-events-none">
					</div>
					<button class="hamburger" id="hamburger-btn" aria-label="ë©”ë‰´ ì—´ê¸°">
						<span class="bar"></span>
						<span class="bar"></span>
						<span class="bar"></span>
					</button>
					<span class="tooltip group-hover:opacity-100">ë‹µë³€ í˜ì´ì§€</span>
				</div>
			</div>

			<!-- ì¶”ê°€ ì—¬ë°± -->

			<div id="alLamWrap" class="mt-auto cursor-pointer relative" onclick="alLamBtn()">
				<img src="https://i.imgur.com/OJI4yzC.png" alt="paw" class="w-8">
				<span id="notiCountBadge"
					class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">
					0
				</span>
				<div id="alLamModal" class="absolute h-[500px] aspect-[3/4] bg-white bottom-1 shadow-xl left-[200%] rounded-3xl 
					       opacity-0 scale-95 transition-all duration-300 pointer-events-none">
					<!-- ì•Œë¦¼ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë¨ -->
				</div>
			</div>




		</aside>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script th:src="@{/resource/js/common.js}"></script>
		<script>
			function alLamBtn() {
				const modal = document.getElementById("alLamModal");
				const badge = document.getElementById("notiCountBadge");

				const isOpen = modal.classList.contains("opacity-100");

				if (isOpen) {
					modal.classList.remove("opacity-100", "scale-100");
					modal.classList.add("opacity-0", "scale-95", "pointer-events-none");
					return;
				}

				// ëª¨ë‹¬ ì—´ê¸° ì• ë‹ˆë©”ì´ì…˜
				modal.classList.remove("opacity-0", "scale-95", "pointer-events-none");
				modal.classList.add("opacity-100", "scale-100");

				// fetch ì‹¤í–‰
				fetch("/adm/notification/list")
					.then(res => res.json())
					.then(data => {
						// âœ… ì—¬ê¸°ì„œ dataë¥¼ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
						if (!Array.isArray(data.notifications) || data.notifications.length === 0) {
							modal.innerHTML = `<div class="p-4 text-gray-500">ğŸ“­ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
							badge.classList.add("hidden");
							return;
						}

						// âœ… ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ
						const unreadCount = data.notifications.filter(n => !n.read).length;
						if (unreadCount > 0) {
							badge.innerText = unreadCount;
							badge.classList.remove("hidden");
						} else {
							badge.classList.add("hidden");
						}

						let html = `<div class="p-4 space-y-2 overflow-y-auto h-full">`;
						data.notifications.forEach(noti => {
							const timeAgo = calcTimeAgo(noti.regDate.time);
							html += `
								<div class="relative border rounded-lg p-3 shadow hover:bg-gray-50 transition">
									<a href="${noti.link}" data-id="${noti.id}" class="block text-black noti-link">
										<div class="font-semibold">${noti.title}</div>
										<div class="text-sm text-gray-400 mt-1">${timeAgo}</div>
									</a>
									<button data-id="${noti.id}" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 delete-btn">&times;</button>
								</div>`;
						});
						html += `</div>`;
						modal.innerHTML = html;

						// ì‚­ì œ ì²˜ë¦¬
						document.querySelectorAll('.delete-btn').forEach(btn => {
							btn.addEventListener('click', e => {
								e.stopPropagation();
								const id = btn.dataset.id;
								if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

								fetch(`/usr/notifications/delete`, {
									method: 'POST',
									headers: {'Content-Type': 'application/x-www-form-urlencoded'},
									body: new URLSearchParams({id})
								})
									.then(res => res.json())
									.then(json => {
										if (json.success) {
											btn.closest('div').remove();
										} else {
											alert('ì‚­ì œ ì‹¤íŒ¨');
										}
									});
							});
						});

						// ì½ìŒ ì²˜ë¦¬
						document.querySelectorAll('.noti-link').forEach(link => {
							link.addEventListener('click', e => {
								e.preventDefault();
								const id = link.dataset.id;
								const url = link.href;
								fetch(`/usr/notifications/markAsRead?id=${id}`, {method: 'POST'})
									.then(() => window.location.href = url);
							});
						});
					});
			}


			function calcTimeAgo(ms) {
				const diff = Date.now() - ms;
				const sec = Math.floor(diff / 1000);
				const min = Math.floor(sec / 60);
				const hr = Math.floor(min / 60);
				const day = Math.floor(hr / 24);

				if (day > 0) return `${day}ì¼ ì „`;
				if (hr > 0) return `${hr}ì‹œê°„ ì „`;
				if (min > 0) return `${min}ë¶„ ì „`;
				if (sec > 5) return `${sec}ì´ˆ ì „`;
				return 'ë°©ê¸ˆ ì „';
			}
			// ì£¼ê¸°ì ìœ¼ë¡œ ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
			function updateNotiBadge() {
				const badge = document.getElementById("notiCountBadge");

				fetch("/adm/notification/list")
					.then(res => res.json())
					.then(data => {
						if (!Array.isArray(data.notifications)) return;

						const unreadCount = data.notifications.filter(n => !n.read).length;

						if (unreadCount > 0) {
							badge.innerText = unreadCount;
							badge.classList.remove("hidden");
						} else {
							badge.classList.add("hidden");
						}
					})
					.catch(err => {
						console.error("ì•Œë¦¼ ë±ƒì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", err);
					});
			}

			// âœ… ìµœì´ˆ ì‹¤í–‰
			updateNotiBadge();

			// âœ… ì´í›„ 60ì´ˆë§ˆë‹¤ ìë™ ì‹¤í–‰
			setInterval(updateNotiBadge, 60000);
		</script>

		<script>
			document.addEventListener('click', function (e) {
				const modal = document.getElementById('alLamModal');
				const trigger = document.getElementById('alLamWrap');

				if (!trigger.contains(e.target)) {
					modal.classList.remove("opacity-100", "scale-100");
					modal.classList.add("opacity-0", "scale-95", "pointer-events-none");
				}
			});
		</script>
	</div>


</body>

</html>