<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>μ•λ¦Όν•¨</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<link rel="stylesheet" th:href="@{/resource/css/global.css}">

	<style>
		.scroll-box {
			max-height: 80%;
			overflow-y: auto;
		}
	</style>

</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9]">
	<div class="flex h-screen">
		<!-- Sidebar -->
		<div th:replace="common :: siteHeader"></div>

		<!-- Main content -->
		<main class="main_page min-h-screen flex-1 p-6 space-y-6">
			<div th:fragment="alarmModalContent">
				<div class="flex justify-between items-center">
					<h2 class="text-2xl font-bold text-gray-800">π“Ά μ•λ¦Όν•¨</h2>
					<div>
						<button id="markAllAsRead" class="px-2 py-1 rounded font-semibold
						         bg-transparent text-black 
						         hover:bg-[#bdd1c6] hover:text-white 
						         transition-colors duration-300">
							λ¨λ‘ μ½μ
						</button>
						<button id="deleteAll" class="px-2 py-1 rounded font-semibold
								bg-transparent text-black 
								hover:bg-[#1B475D] hover:text-white 
								transition-colors duration-300">
							λ¨λ‘ μ‚­μ 
						</button>
					</div>
				</div>
				<hr class="border-t border-yellow-400 mb-4 mt-2" />

				<div class="notification-list space-y-4">
					<div class="text-center text-gray-500" th:if="${#lists.isEmpty(notifications)}">
						π“­ μ•λ¦Όμ΄ μ—†μµλ‹λ‹¤.
					</div>

					<div th:each="noti : ${notifications}"
						th:class="'flex gap-3 p-4 rounded-2xl shadow-sm hover:shadow-md border transition-all group cursor-pointer ' + (${noti.read} ? 'bg-white opacity-70' : 'bg-[#FFFBE8]')"
						th:attr="data-id=${noti.id}">

						<!-- μ•„μ΄μ½ -->
						<div class="flex-shrink-0 w-8 h-8">
							<img th:src="@{/img/default-pet.png}" class="w-full h-full object-contain" />
						</div>

						<!-- λ³Έλ¬Έ -->
						<div class="flex-1">
							<a th:href="${noti.link}">
								<p class="text-sm text-gray-500 font-medium" th:text="${noti.title}">μ λ©</p>
								<div class="flex justify-between">
									<div class="text-xs text-gray-400 mt-2"
										th:text="${#dates.format(noti.regDate, 'yyyy.MM.dd HH:mm')}">1λ¶„ μ „</div>
									<div class="text-xs text-gray-400 mt-2 time-ago"
										th:attr="data-time=${noti.regDate.time}"></div>
								</div>
							</a>
						</div>

						<!-- λΉ¨κ°„ μ  (μ• μ½μ—μ„ κ²½μ°λ§ ν‘μ‹) -->
						<div th:if="${!noti.read}" class="w-2 h-2 bg-red-500 rounded-full mt-1"></div>
					</div>
				</div>

			</div>
		</main>
	</div>

	<script th:inline="javascript">
		const cp = /*[[${contextPath}]]*/ '';

		function calcTimeAgo(ms) {
			const diff = Date.now() - ms;
			const sec = Math.floor(diff / 1000);
			const min = Math.floor(sec / 60);
			const hr = Math.floor(min / 60);
			const day = Math.floor(hr / 24);
			if (day > 0) return day + 'μΌ μ „';
			if (hr > 0) return hr + 'μ‹κ°„ μ „';
			if (min > 0) return min + 'λ¶„ μ „';
			if (sec > 5) return sec + 'μ΄ μ „';
			return 'λ°©κΈ μ „';
		}

		function updateTimeAgo() {
			document.querySelectorAll('.time-ago').forEach(el => {
				const ms = parseInt(el.dataset.time, 10);
				if (!isNaN(ms)) {
					el.textContent = calcTimeAgo(ms);
				}
			});
		}

		document.addEventListener('DOMContentLoaded', () => {
			updateTimeAgo();
			setInterval(updateTimeAgo, 60 * 1000);

			document.querySelectorAll('.notification-link').forEach(link => {
				link.addEventListener('click', e => {
					e.preventDefault();
					const item = link.closest('[data-id]');
					const id = item.dataset.id;
					const url = link.href;

					fetch('/usr/notifications/markAsRead?notificationId=' + id, {
						method: 'POST'
					})

						.then(() => {
							item.classList.replace('bg-yellow-100', 'bg-white');
							item.classList.add('opacity-70');
							window.location.href = url;
						});
				});
			});

			document.querySelectorAll('.delete-btn').forEach(btn => {
				btn.addEventListener('click', e => {
					e.stopPropagation();
					const item = btn.closest('[data-id]');
					const id = item.dataset.id;

					if (!confirm('μ•λ¦Όμ„ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) return;

					fetch(`${cp}/usr/notifications/delete`, {
						method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
						body: new URLSearchParams({id})
					})
						.then(res => res.json())
						.then(json => {
							if (json.success) {
								item.remove();
							} else {
								alert(json.msg || 'μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
							}
						})
						.catch(() => {
							alert('μ„λ²„ μ—λ¬λ΅ μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
						});
				});
			});
		});

		document.getElementById('markAllAsRead')?.addEventListener('click', () => {
			if (!confirm('λ¨λ“  μ•λ¦Όμ„ μ½μ μ²λ¦¬ν•μ‹κ² μµλ‹κΉ?')) return;

			fetch('/usr/notifications/markAllAsRead', {
				method: 'POST'
			})
				.then(res => res.json())
				.then(json => {
					if (json.resultCode && json.resultCode.startsWith('S-')) {
						document.querySelectorAll('.notification-list [data-id]').forEach(item => {
							item.classList.replace('bg-yellow-100', 'bg-white');
							item.classList.add('opacity-70');
						});
					} else {
						alert(json.msg || 'μ²λ¦¬μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
					}
				})
				.catch(() => {
					alert('μ„λ²„ μ¤λ¥λ΅ μ²λ¦¬μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
				});
		});

		document.getElementById('deleteAll')?.addEventListener('click', () => {
			if (!confirm('λ¨λ“  μ•λ¦Όμ„ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) return;

			fetch('/usr/notifications/deleteAll', {
				method: 'POST'
			})
				.then(res => res.json())
				.then(json => {
					if (json.resultCode && json.resultCode.startsWith('S-')) {
						document.querySelectorAll('.notification-list [data-id]').forEach(item => item.remove());
						const emptyMessage = document.querySelector('.notification-list > div.text-center');
						if (emptyMessage) {
							emptyMessage.style.display = 'block';
						}
					} else {
						alert(json.msg || 'μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
					}
				})
				.catch(() => alert('μ„λ²„ μ¤λ¥λ΅ μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.'));
		});


	</script>

</body>

</html>