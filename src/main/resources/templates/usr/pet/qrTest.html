<!-- src/main/resources/templates/usr/pet/qr_button.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>QR ë§Œë“¤ê¸°</title>

	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<link rel="stylesheet" th:href="@{/resource/css/global.css}">

	<style>
		/* --- ì¹´ë“œ & ë ˆì´ì•„ì›ƒ --- */
		.aw-card { background: #fff; border: 1px solid #ececec; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
		.aw-chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; }
		.aw-divider { height:1px; background:linear-gradient(90deg,transparent,#eee,transparent); }

		/* --- ë²„íŠ¼ --- */
		.aw-btn { appearance:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid #e5e7eb; background:#111; color:#fff; border-radius:12px; padding:11px 16px; cursor:pointer; font-weight:600; }
		.aw-btn:disabled { opacity:.6; cursor:not-allowed; }
		.aw-btn-subtle { background:#fff; color:#111; }

		/* --- QR ë°•ìŠ¤ & ìŠ¤ì¼ˆë ˆí†¤ --- */
		.qr-box { width: 260px; height: 260px; border: 1px solid #ececec; border-radius: 14px; overflow: hidden; display:flex; align-items:center; justify-content:center; background:#fff; }
		.skeleton { position:relative; width:100%; height:100%; background:linear-gradient(90deg,#f4f4f5 25%, #e9ecef 37%, #f4f4f5 63%); background-size:400% 100%; animation:shimmer 1.2s infinite; }
		@keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

		/* --- í† ìŠ¤íŠ¸ --- */
		.toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 14px; background: #111; color:#fff; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.18); opacity:0; transform: translateY(8px); transition: .25s ease; pointer-events:none; }
		.toast.show { opacity:1; transform: translateY(0); }
		/* gradient buttons (match page bg) */
		.aw-btn-gradient{
			background: linear-gradient(135deg,#e4f0b9 0%,#fcdca9 100%);
			color:#0f172a;
			border:1px solid rgba(0,0,0,.06);
			box-shadow: 0 2px 0 rgba(0,0,0,.04), 0 10px 20px rgba(252,220,169,.35);
			transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
		}
		.aw-btn-gradient:hover{ filter: brightness(0.98); transform: translateY(-1px); }
		.aw-btn-gradient:active{ filter: brightness(0.97); transform: translateY(0); box-shadow: 0 1px 0 rgba(0,0,0,.04), 0 6px 14px rgba(252,220,169,.30); }
		.aw-btn-gradient:disabled{ opacity:.6; cursor:not-allowed; }
		.aw-btn-gradient svg{ opacity:.9; }
	</style>
</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] h-screen min-h-dvh min-w-[1400px] text-slate-900">
<div class="flex h-screen w-full">
	<!-- Sidebar (ìœ ì§€) -->
	<div th:replace="common :: siteHeader"></div>

	<!-- Main content (ìœ ì§€) -->
	<main class="main_page h-full overflow-y-auto flex-1 min-h-dvh box-border">
		<div class="mx-auto max-w-5xl px-6 pt-16 pb-16 md:pt-20 lg:pt-24 xl:pt-28">

			<!-- í—¤ë” ì˜ì—­ -->
			<header class="mb-6 flex items-center justify-between">
				<div class="flex items-center gap-4">
					<!-- QR ì•„ì´ì½˜ -->
					<svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M3 3h7v7H3zM14 3h7v7h-7zM3 14h7v7H3z"/>
						<path d="M14 14h3v3h-3zM18 14h3v7h-3zM14 18h3v3h-3z"/>
					</svg>
					<div>
						<h1 class="text-2xl font-extrabold leading-tight">QR ìƒì„±</h1>
						<p class="text-sm text-slate-600">ë°˜ë ¤ë³‘ì› ë‚´ì› ì‹œ, QRë§Œ ë³´ì—¬ì£¼ì„¸ìš” ğŸ¾ í•œ ì¥ì— ì •ë¦¬ëœ ë¦¬í¬íŠ¸ë¡œ ë¬¸ì§„ ì‹œê°„ì„ ì¤„ì—¬ìš”.</p>
					</div>
				</div>
				<div class="aw-chip" id="statusChip">
					<span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
					ì¤€ë¹„ ì™„ë£Œ
				</div>
			</header>

			<!-- ì½˜í…ì¸  ì¹´ë“œ -->
			<section class="aw-card p-6">
				<!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
				<div class="flex flex-wrap items-end gap-3">
					<div class="flex flex-col">
						<label class="text-xs text-slate-500 mb-1">Pet ID</label>
						<input id="petIdInput" type="text" inputmode="numeric" placeholder="ì˜ˆ: 1"
							   class="w-40 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" />
					</div>
					<div class="flex flex-col">
						<label class="text-xs text-slate-500 mb-1">QR í¬ê¸°</label>
						<select id="sizeSelect" class="w-36 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400">
							<option value="256">256 px</option>
							<option value="384">384 px</option>
							<option value="512" selected>512 px</option>
							<option value="768">768 px</option>
						</select>
					</div>

					<button id="btnMakeQr" class="aw-btn-gradient aw-btn ml-auto">
						<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
						QR ë§Œë“¤ê¸°
					</button>
				</div>

				<div class="my-6 aw-divider"></div>

				<!-- ë¯¸ë¦¬ë³´ê¸° & ì•¡ì…˜ -->
				<div class="grid grid-cols-1 md:grid-cols-[260px,1fr] gap-6 items-start">
					<!-- QR ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ -->
					<div class="flex flex-col items-center gap-3">
						<div class="qr-box" id="qrBox">
							<div id="skeleton" class="skeleton hidden" aria-hidden="true"></div>
							<img id="qrImg" alt="QR" class="w-full h-full object-contain hidden" />
						</div>
						<p id="qrHint" class="text-xs text-slate-500">ë²„íŠ¼ì„ ëˆŒëŸ¬ QR ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
					</div>

					<!-- ì•¡ì…˜ íŒ¨ë„ -->
					<div class="flex flex-col gap-3">
						<div class="flex flex-wrap gap-2">
							<a id="qrDownload" class="aw-btn aw-btn-subtle" download="aniwell-qr.png" title="QR ë‹¤ìš´ë¡œë“œ">
								<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3v12m0 0l-4-4m4 4l4-4"/><path d="M5 21h14"/></svg>
								ë‹¤ìš´ë¡œë“œ
							</a>
							<a id="qrOpen" class="aw-btn aw-btn-subtle" target="_blank" rel="noopener" title="ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°">
								<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 7h10v10H7z"/><path d="M14 7h3v3"/></svg>
								ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
							</a>
							<button id="qrCopy" class="aw-btn aw-btn-subtle" title="ë§í¬ ë³µì‚¬">
								<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="9" y="9" width="13" height="13" rx="2"/><rect x="2" y="2" width="13" height="13" rx="2"/></svg>
								ë§í¬ ë³µì‚¬
							</button>
						</div>

						<ul class="mt-3 text-sm text-slate-600 list-disc pl-5">
						</ul>
					</div>
				</div>
			</section>
		</div>
	</main>
</div>

<!-- ì„œë²„ì—ì„œ ë„˜ê¸´ ê°’ ì£¼ì… -->
<script th:inline="javascript">
	const PET_ID   = /*[[${petId}]]*/ null;
	const VISIT_ID = /*[[${visitId}]]*/ null;
</script>

<script type="module">
	// --- API BASE ê²°ì •: ?api=... ìš°ì„  ì ìš© (ë’·ìŠ¬ë˜ì‹œ ì œê±°) ---
	const pageQS = new URLSearchParams(location.search);
	const rawBase = (pageQS.get('api') || '').replace(/\/+$/, '');
	const API_BASE = rawBase || '';

	// base + path ì•ˆì „ ê²°í•©
	const join = (base, path) => {
		if (!base) return path;
		const b = base.replace(/\/+$/, '');
		const p = path.startsWith('/') ? path : `/${path}`;
		return `${b}${p}`;
	};

	// ì—˜ë¦¬ë¨¼íŠ¸ ë°”ì¸ë”©
	const btn = document.getElementById('btnMakeQr');
	const img = document.getElementById('qrImg');
	const box = document.getElementById('qrBox');
	const skel = document.getElementById('skeleton');
	const hint = document.getElementById('qrHint');
	const dl  = document.getElementById('qrDownload');
	const op  = document.getElementById('qrOpen');
	const cp  = document.getElementById('qrCopy');
	const sizeSel = document.getElementById('sizeSelect');
	const petInput = document.getElementById('petIdInput');
	const chip = document.getElementById('statusChip');

	// ì„œë²„ì—ì„œ petId ì£¼ì… ì‹œ ì…ë ¥ì°½ì— ë°˜ì˜
	if (typeof PET_ID !== 'undefined' && PET_ID !== null && String(PET_ID).trim() !== '') {
		petInput.value = PET_ID;
		petInput.disabled = true; // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ê°’ì´ë©´ ìˆ˜ì • ë¶ˆê°€
	}

	// ìƒíƒœì¹© ì—…ë°ì´íŠ¸
	const setChip = (text, color='emerald') => {
		chip.innerHTML = `<span class="inline-block w-2 h-2 rounded-full bg-${color}-500"></span>${text}`;
	};

	// í¬ë¡œìŠ¤ ë„ë©”ì¸ ë‹¤ìš´ë¡œë“œ í´ë°±(blob)
	async function makeDownloadable(href) {
		try {
			const res = await fetch(href, { mode: 'cors' });
			if (!res.ok) throw new Error('fetch failed');
			const blob = await res.blob();
			const url  = URL.createObjectURL(blob);
			dl.href = url;
			dl.download = 'aniwell-qr.png';
			dl.dataset.blob = '1';
		} catch {
			dl.href = href; // í´ë°± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë§í¬
			dl.removeAttribute('data-blob');
		}
	}

	// QR ìƒì„±
	btn.addEventListener('click', async () => {
		// petId í™•ë³´
		let pid = (petInput.value || '').trim();
		if (!pid && typeof PET_ID !== 'undefined' && PET_ID !== null) pid = String(PET_ID).trim();
		if (!pid) {
			petInput.focus();
			petInput.classList.add('ring-2','ring-rose-400');
			setTimeout(() => petInput.classList.remove('ring-2','ring-rose-400'), 1200);
			return;
		}

		const size = (sizeSel.value || '512').trim();

		btn.disabled = true;
		setChip('ìƒì„± ì¤‘â€¦', 'amber');
		hint.textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”.';

		// ìŠ¤ì¼ˆë ˆí†¤ on
		skel.classList.remove('hidden');
		img.classList.add('hidden');

		// ì¿¼ë¦¬ êµ¬ì„±
		const qs = new URLSearchParams({ petId: pid, size });
		if (typeof VISIT_ID !== 'undefined' && VISIT_ID !== null && String(VISIT_ID).trim() !== '') {
			qs.set('visitId', VISIT_ID);
		}

		const src = join(API_BASE, `/api/qr?${qs.toString()}`);

		// ê¸°ì¡´ blob URL ì •ë¦¬
		if (dl.dataset.blob === '1' && dl.href.startsWith('blob:')) {
			URL.revokeObjectURL(dl.href);
			dl.removeAttribute('data-blob');
		}

		// ì´ë¯¸ì§€ ë¡œë”©
		const done = () => { btn.disabled = false; };
		img.onload = async () => {
			skel.classList.add('hidden');
			img.classList.remove('hidden');
			hint.textContent = 'ìƒì„±ì´ ì™„ë£Œëì–´ìš”. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥/ê³µìœ í•  ìˆ˜ ìˆì–´ìš”.';
			setChip('ì¤€ë¹„ ì™„ë£Œ', 'emerald');
			await makeDownloadable(src);
			done();
		};
		img.onerror = () => {
			skel.classList.add('hidden');
			img.classList.add('hidden');
			hint.textContent = 'QR ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì‘ë‹µì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
			setChip('ì˜¤ë¥˜ ë°œìƒ', 'rose');
			done();
		};

		op.href = src;
		img.src = src;
	});

	// ë§í¬ ë³µì‚¬ + í† ìŠ¤íŠ¸
	const toast = document.createElement('div');
	toast.className = 'toast';
	toast.textContent = 'ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
	document.body.appendChild(toast);

	cp.addEventListener('click', async () => {
		const href = op.href;
		try {
			await navigator.clipboard.writeText(href);
			toast.classList.add('show');
			setTimeout(() => toast.classList.remove('show'), 1200);
		} catch { alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
	});

	// í˜ì´ì§€ ì´íƒˆ ì‹œ blob URL í•´ì œ
	window.addEventListener('beforeunload', () => {
		if (dl.dataset.blob === '1' && dl.href.startsWith('blob:')) {
			URL.revokeObjectURL(dl.href);
		}
	});
</script>

</body>
</html>
