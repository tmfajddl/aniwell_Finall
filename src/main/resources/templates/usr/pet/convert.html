<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aniwell QR Report</title>

    <!-- ìŠ¤íƒ€ì¼(ê°„ê²°/ì¼ê´€) -->
    <style>
        :root{ --bg:#FFF8F3; --card:#fff; --accent:#FFC4C4; --chip:#f6f6f6; --ok:#16a34a; --down:#ef4444; --muted:#6b7280; --border:#ececec;}
        html[data-theme="male"]{ --bg:#F3F8FF; --accent:#BFD9FF; --chip:#EEF4FF; }
        html[data-theme="female"]{ --bg:#FFF3F7; --accent:#FFC4DF; --chip:#FFF0F6; }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);font-family:system-ui,apple sd gothic neo,Segoe UI,sans-serif;display:flex;justify-content:center}
        .wrap{max-width:980px;width:100%;padding:24px 16px;display:grid;gap:16px}
        .pill{display:inline-block;background:var(--accent);padding:6px 12px;border-radius:999px;font-size:12px}
        h1{margin:10px 0 0}
        .card{background:var(--card);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
        .hero{display:flex;gap:18px;align-items:center}
        .hero img{width:110px;height:110px;border-radius:16px;object-fit:cover;border:6px solid #fff;box-shadow:0 6px 18px rgba(0,0,0,.08)}
        .kv{display:grid;grid-template-columns:110px 1fr;gap:6px 12px;font-size:14px}
        .muted{color:var(--muted)}

        .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
        .stat{border:1px solid var(--border);border-radius:14px;padding:14px}
        .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
        .delta.up{color:var(--ok)} .delta.down{color:var(--down)} .delta.same{color:var(--muted)}
        .delta b{font-weight:700}

        .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
        .btn:hover{box-shadow:0 6px 16px rgba(0,0,0,.06)}
        .chip{background:var(--chip);border-radius:999px;padding:6px 12px;font-size:12px;border:1px solid var(--border);cursor:pointer}
        .chip--active{background:#111;color:#fff;border-color:#111}

        .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
        .legend .item{display:flex;align-items:center;gap:6px;font-size:12px;color:#444;background:var(--chip);padding:4px 8px;border-radius:999px}
        .point-swatch{width:10px;height:10px;border:1px solid #bbb;border-radius:2px}
        .swatch-dry{border-radius:50%}
        .swatch-wet{border-radius:2px}
        .swatch-mix{clip-path:polygon(50% 0,0 100%,100% 100%)}

        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}

        /* ë°©ë¬¸ ì¹´ë“œ */
        .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
        .visit{border:1px solid var(--border);border-radius:14px;padding:14px;display:grid;gap:8px}

        /* ëª¨ë‹¬ */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
        .dialog{background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.25);width:min(840px,94vw);max-height:86vh;display:flex;flex-direction:column;overflow:hidden}
        .dialog .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between}
        .dialog .bd{padding:14px 16px;overflow:auto}
        .dialog .ft{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
        .close-x{border:none;background:transparent;font-size:20px;cursor:pointer}

        @media (max-width:760px){
            .cards{grid-template-columns:1fr}
            .hero{flex-direction:column;align-items:flex-start}
            .stats{grid-template-columns:1fr}
            .dialog{width:96vw}
        }

        .twins{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:8px}
        .mini{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
        .mini table{width:100%;border-collapse:collapse}
        .mini th,.mini td{padding:6px 8px;border:0;font-size:12px}

        @media (max-width:760px){
            .twins{grid-template-columns:1fr}
        }

    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
<div class="wrap">
    <div>
        <span class="pill">QR ë¦¬í¬íŠ¸</span>
        <h1 id="title">ë¡œë”© ì¤‘...</h1>
        <div class="muted" id="subtitle"></div>
    </div>

    <!-- í« ì •ë³´ -->
    <section class="card" id="petCard" hidden>
        <div class="hero">
            <img id="petPhoto" src="" alt="pet photo">
            <div>
                <h2 id="petName" style="margin:0 0 6px"></h2>
                <div class="kv">
                    <div class="muted">í’ˆì¢…</div><div id="petBreed">-</div>
                    <div class="muted">ì„±ë³„</div><div id="petGender">-</div>
                    <div class="muted">ìƒì¼</div><div id="petBirth">-</div>
                    <div class="muted">ëª¸ë¬´ê²Œ</div><div id="petWeight">-</div>
                    <div class="muted">ì‚¬ë£Œ</div><div id="petFeed">-</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ì´ë²ˆ ì£¼ ë³€í™”: ê¸‰ì‹/ê¸‰ìˆ˜/ë°°ë³€ -->
    <section class="card">
        <h3 style="margin:0 0 12px">ì´ë²ˆ ì£¼ ë³€í™”</h3>
        <div class="stats">
            <div class="stat">
                <div class="row"><b>ê¸‰ì‹ëŸ‰</b><div id="foodDelta" class="delta">-</div></div>
                <table style="margin-top:8px"><tbody>
                <tr><th>ì „ì£¼ í‰ê· </th><td id="foodPrev">-</td></tr>
                <tr><th>ì´ë²ˆì£¼ í‰ê· </th><td id="foodThis">-</td></tr>
                </tbody></table>
            </div>
            <div class="stat">
                <div class="row"><b>ê¸‰ìˆ˜ëŸ‰</b><div id="waterDelta" class="delta">-</div></div>
                <table style="margin-top:8px"><tbody>
                <tr><th>ì „ì£¼ í‰ê· </th><td id="waterPrev">-</td></tr>
                <tr><th>ì´ë²ˆì£¼ í‰ê· </th><td id="waterThis">-</td></tr>
                </tbody></table>
            </div>
            <div class="stat">
                <div class="row"><b>ë°°ë³€/ë°°ë‡¨</b></div>

                <!-- ë‘ ì¹¸ ë ˆì´ì•„ì›ƒ -->
                <div class="twins">
                    <!-- ì†Œë³€ -->
                    <div class="mini">
                        <div class="row">
                            <span>ğŸ’§ ì†Œë³€</span>
                            <div id="peeDelta" class="delta">-</div>
                        </div>
                        <table class="mini-table"><tbody>
                        <tr><th>ì „ì£¼</th><td id="peePrev">-</td></tr>
                        <tr><th>ì´ë²ˆì£¼</th><td id="peeThis">-</td></tr>
                        </tbody></table>
                    </div>

                    <!-- ëŒ€ë³€ -->
                    <div class="mini">
                        <div class="row">
                            <span>ğŸ’© ëŒ€ë³€</span>
                            <div id="poopDelta" class="delta">-</div>
                        </div>
                        <table class="mini-table"><tbody>
                        <tr><th>ì „ì£¼</th><td id="poopPrev">-</td></tr>
                        <tr><th>ì´ë²ˆì£¼</th><td id="poopThis">-</td></tr>
                        </tbody></table>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- ëª¸ë¬´ê²Œ & ë°°ë³€(ìš”ì•½/í•„í„°/ë”ë³´ê¸°) -->
    <section class="card" style="padding:18px">
        <h3 style="margin:0 0 12px">ëª¸ë¬´ê²Œ & ë°°ë³€</h3>

        <!-- ì»¨íŠ¸ë¡¤ë°” -->
        <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
            <!-- ê¸°ê°„ì¹©: ëª¸ë¬´ê²Œ -->
            <div style="display:flex;gap:6px;align-items:center">
                <span class="muted" style="font-size:12px">ëª¸ë¬´ê²Œ ê¸°ê°„</span>
                <button class="chip js-period" data-days="7">7ì¼</button>
                <button class="chip js-period chip--active" data-days="30">30ì¼</button>
                <button class="chip js-period" data-days="90">3ê°œì›”</button>
                <button class="chip js-period" data-days="0">ì „ì²´</button>
            </div>

            <!-- ë°°ë³€ í•„í„° -->
            <div style="display:flex;gap:6px;align-items:center;margin-left:auto">
                <button class="chip js-type chip--active" data-type="all">ìµœê·¼</button>
                <button class="chip js-type" data-type="pee">ğŸ’§ ì†Œë³€</button>
                <button class="chip js-type" data-type="poop">ğŸ’© ëŒ€ë³€</button>
                <button class="chip js-type" data-type="unknown">â“ ë¯¸ë¶„ë¥˜</button>
                <label class="chip" style="display:flex;align-items:center;gap:6px">
                    <input id="litAnom" type="checkbox" style="accent-color:#111"> ì´ìƒë§Œ
                </label>
            </div>
        </div>

        <div style="display:grid;grid-template-columns:500px 1fr;gap:16px;align-items:start">
            <!-- ì™¼ìª½: ëª¸ë¬´ê²Œ(ê°€ë¡œ ìŠ¤í¬ë¡¤, xë¼ë²¨ ì œê±°) -->
            <div>
                <div id="wtScroll" style="overflow-x:auto;border:1px solid var(--border);border-radius:14px;background:#fff;padding:10px">
                    <canvas id="wtChart" height="260"></canvas>
                </div>
                <div id="feedLegend" class="legend"></div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë°°ë³€ í‘œ(ìš”ì•½ ê¸°ë³¸, ë”ë³´ê¸°) -->
            <div>

                <div style="border:1px solid var(--border);border-radius:14px;background:#fff;height:300px;overflow:auto">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:170px">ì‹œê°„</th>
                            <th style="width:90px">ì¢…ë¥˜</th>
                            <th>íŠ¹ì´ì‚¬í•­</th>
                        </tr>
                        </thead>
                        <tbody id="litTbody"></tbody>
                    </table>
                </div>

                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                    <button id="btnMoreLitter" class="btn">ë”ë³´ê¸°</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ë°©ë¬¸ ê¸°ë¡ -->
    <section class="card">
        <h3 style="margin:0 0 12px">ë°©ë¬¸ ê¸°ë¡</h3>
        <div class="cards" id="visitCards"></div>
        <div id="visitEmpty" class="muted" style="padding:6px 2px" hidden>ë°©ë¬¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </section>
</div>

<!-- Visit Modal -->
<div class="modal" id="visitModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="visitTitle">
        <div class="hd">
            <div class="title" id="visitTitle">ë°©ë¬¸ ìƒì„¸</div>
            <div style="display:flex;gap:8px;align-items:center">
                <button class="btn" id="btnOpenDocs">ì›ë³¸ ë³´ê¸°</button>
                <button class="close-x" id="closeVisitModal" aria-label="ë‹«ê¸°">âœ•</button>
            </div>
        </div>
        <div class="bd" id="visitBody"></div>
        <div class="ft"><button class="btn" id="closeVisitModal2">ë‹«ê¸°</button></div>
    </div>
</div>

<!-- Docs Modal -->
<div class="modal" id="docsModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="docsTitle">
        <div class="hd">
            <div class="title" id="docsTitle">ì›ë³¸ ë¬¸ì„œ</div>
            <button class="close-x" id="closeDocsModal" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div class="bd" id="docsBody"></div>
        <div class="ft"><button class="btn" id="closeDocsModal2">ë‹«ê¸°</button></div>
    </div>
</div>

<script>
    /* ===== ê¸°ë³¸ ìœ í‹¸ ===== */
    const API_BASE = ''; // ê°™ì€ ë„ë©”ì¸ì´ë©´ ë¹ˆ ë¬¸ìì—´ ìœ ì§€
    const qs = new URLSearchParams(location.search);
    const petId = qs.get('petId');

    const $  = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const pad = n=>String(n).padStart(2,'0');
    const fmt = s => {
        const d = new Date(String(s).replace(' ','T'));
        if (isNaN(d)) return s;
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const safe = (v,d='-') => (v===null||v===undefined||v==='')?d:v;

    function startOfWeekMon(d0=new Date()){
        const d = new Date(d0); d.setHours(0,0,0,0);
        const wd = d.getDay(); const diff = (wd===0 ? -6 : 1 - wd);
        d.setDate(d.getDate()+diff); return d;
    }
    function inRange(ts, from, to){ return ts>=from.getTime() && ts<to.getTime(); }

    /* ===== í« ì¹´ë“œ/í…Œë§ˆ ===== */
    function applyThemeByGender(gender){
        const g = String(gender||'').toLowerCase();
        const male   = ['ìˆ˜ì»·','ë‚¨','ë‚¨ì•„','m','male'].some(k=>g.includes(k));
        const female = ['ì•”ì»·','ì—¬','ì—¬ì•„','f','female'].some(k=>g.includes(k));
        const root = document.documentElement;
        if (male) root.setAttribute('data-theme','male');
        else if (female) root.setAttribute('data-theme','female');
        else root.removeAttribute('data-theme');
    }
    function renderPet(p){
        $('#petCard').hidden = false;
        $('#petName').textContent = `${safe(p.name)} (${safe(p.species)})`;
        $('#petBreed').textContent = safe(p.breed);
        $('#petGender').textContent = safe(p.gender);
        $('#petBirth').textContent = safe(p.birthDate);
        $('#petWeight').textContent = p.weight!=null ? `${p.weight}` : '-';

        const feedType = p.feedType || p.foodType || null;
        const brand    = p.brand || p.feedBrand || null;
        const prod     = p.productName || p.product || null;
        const flavor   = p.flavor || null;
        const parts = [];
        if (feedType) parts.push(feedType);
        const name = [brand, prod].filter(Boolean).join(' / ');
        if (name) parts.push(name);
        if (flavor) parts.push(`(${flavor})`);
        $('#petFeed').textContent = parts.length ? parts.join(' Â· ') : '-';

        $('#petPhoto').src = p.photo || 'https://placehold.co/160x160?text=No+Photo';
        $('#subtitle').textContent = `ID #${p.id}`;
        applyThemeByGender(p.gender);
    }

    /* ===== ì´ë²ˆ ì£¼ ë³€í™”(ê¸‰ì‹/ê¸‰ìˆ˜) ===== */
    function weeklyAverages(logs, key){
        const now = new Date();
        const thisStart = startOfWeekMon(now);
        const nextStart = new Date(thisStart); nextStart.setDate(thisStart.getDate()+7);
        const prevStart = new Date(thisStart); prevStart.setDate(thisStart.getDate()-7);

        const pick = (from,to)=>{
            let sum=0, cnt=0;
            for(const l of (logs||[])){
                const v = (l[key]!==null && l[key]!==undefined) ? Number(l[key]) : null;
                if (v===null || isNaN(v)) continue;
                const when = l.logDate || l.date || l.createdAt;
                const t = new Date(String(when).replace(' ','T')).getTime();
                if (isNaN(t)) continue;
                if (inRange(t,from,to)){ sum+=v; cnt++; }
            }
            return cnt ? (sum/cnt) : null;
        };
        return { prev: pick(prevStart,thisStart), curr: pick(thisStart,nextStart) };
    }
    function renderDelta(el, prev, curr, unitText){
        let cls='same', txt='ë³€í™” ì—†ìŒ';
        if (prev===null && curr===null){ el.className='delta same'; el.textContent='ë°ì´í„° ì—†ìŒ'; return; }
        if (prev===null){ el.className='delta up'; el.innerHTML=`<b>ì´ë²ˆì£¼ ${curr.toFixed(2)}${unitText}</b>`; return; }
        if (curr===null){ el.className='delta same'; el.textContent='ì´ë²ˆì£¼ ë°ì´í„° ì—†ìŒ'; return; }
        const diff = curr - prev;
        if (Math.abs(diff) < 1e-9) { cls='same'; txt='ë³€í™” ì—†ìŒ'; }
        else if (diff > 0) { cls='up'; txt=`â–² ${diff.toFixed(2)}${unitText} (+${((diff/prev)*100).toFixed(1)}%)`; }
        else { cls='down'; txt=`â–¼ ${Math.abs(diff).toFixed(2)}${unitText} (${((diff/prev)*100).toFixed(1)}%)`; }
        el.className = 'delta ' + cls; el.innerHTML = `<b>${txt}</b>`;
    }

    /* ===== Chart: ëª¸ë¬´ê²Œ (xë¼ë²¨ ìˆ¨ê¹€ + ê°€ë¡œìŠ¤í¬ë¡¤, ê¸°ë³¸ 30ì¼) ===== */
    let wtChart;
    function feedPointStyle(ft){
        const s = String(ft||'').toLowerCase();
        if (s.includes('dry') || s.includes('ê±´')) return 'circle';
        if (s.includes('wet') || s.includes('ìŠµ') || s.includes('ìº”')) return 'rect';
        if (s.includes('mix') || s.includes('í˜¼')) return 'triangle';
        return 'triangle';
    }
    function renderFeedLegend(points){
        const box = $('#feedLegend'); box.innerHTML = '';
        if (!points?.length) return;
        const kinds = new Set(points.map(p=>feedPointStyle(p.feedType)));
        kinds.forEach(k=>{
            const sw = k==='circle' ? 'swatch-dry' : k==='rect' ? 'swatch-wet' : 'swatch-mix';
            const label = k==='circle' ? 'ê±´ì‹' : (k==='rect' ? 'ìŠµì‹' : 'í˜¼í•©');
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `<span class="point-swatch ${sw}"></span><span>${label}</span>`;
            box.appendChild(el);
        });
    }



    let wtRaw = [];            // ì„œë²„ì—ì„œ í•œë²ˆ ë°›ì•„ ë‘” ì „ì²´
    let wtPeriodDays = 30;     // ê¸°ë³¸ 30ì¼
    const DAY_MS = 24*60*60*1000;

    async function fetchWeightAll(){
        const url = `${API_BASE}/api/pet/weight-timeline?petId=${petId}`;
        const r = await fetch(url, { headers:{ 'Accept':'application/json' } });
        if (!r.ok){ renderWeight([]); return; }
        const js = await r.json();

        wtRaw = (Array.isArray(js.points) ? js.points : js)
            .map(p=>{
                const t = p.measuredAt || p.date || p.createdAt;
                const x = new Date(String(t).replace(' ','T'));
                const y = Number(p.weightKg ?? p.weight ?? p.kg ?? p.bodyWeight);
                const feedType = p.foodType || p.feedType || null;
                return (x instanceof Date && !isNaN(x) && isFinite(y)) ? { x, y, feedType } : null;
            })
            .filter(Boolean)
            .sort((a,b)=> a.x - b.x);

        renderWeight(applyWeightFilter());
    }

    function applyWeightFilter(){
        if (!wtPeriodDays || wtPeriodDays <= 0) return [...wtRaw]; // ì „ì²´
        const end = new Date(); end.setHours(23,59,59,999);
        const start = new Date(end - (wtPeriodDays-1)*DAY_MS); start.setHours(0,0,0,0);
        return wtRaw.filter(p => p.x >= start && p.x <= end);
    }

    function dateKey(d){
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function dedupLastPerDay(points){
        const byDay = new Map(); // key: YYYY-MM-DD -> point
        for (const p of (points || [])){
            if (!p?.x || isNaN(p.x)) continue;
            const key = dateKey(p.x);
            const prev = byDay.get(key);
            // ê¸°ì¡´ë³´ë‹¤ ì‹œê°„ì´ ê°™ê±°ë‚˜ ë” ëŠ¦ìœ¼ë©´ êµì²´(= 'ë§ˆì§€ë§‰' ê¸°ë¡ ìœ ì§€)
            if (!prev || p.x.getTime() >= prev.x.getTime()){
                byDay.set(key, p);
            }
        }
        return Array.from(byDay.values()).sort((a,b)=>a.x - b.x);
    }

    let wtResizeObs;
    function setupWeightResizeObserver(){
        const el = document.getElementById('wtScroll');
        if (!el) return;
        if (wtResizeObs) wtResizeObs.disconnect();
        wtResizeObs = new ResizeObserver(()=>{
            // ì»¨í…Œì´ë„ˆ í­ì´ ë³€í•˜ë©´ í˜„ì¬ ê¸°ê°„ì˜ ë°ì´í„°ë¡œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            renderWeight(applyWeightFilter());
        });
        wtResizeObs.observe(el);
    }


    function renderWeight(points){
        const scroll = document.getElementById('wtScroll');
        const canvas = document.getElementById('wtChart');

        // âœ… ê°™ì€ ë‚ ì§œ ì¤‘ ë§ˆì§€ë§‰ 1ê°œë§Œ ë‚¨ê¸´ë‹¤
        const pts = dedupLastPerDay(points);

        const pxPer = 40; // í¬ì¸íŠ¸ë‹¹ ê°€ë¡œí­
        const wantW = Math.max(scroll.clientWidth, (pts.length * pxPer) + 60);
        canvas.width = wantW;             // ì†ì„±ìœ¼ë¡œ ì§€ì •í•´ì•¼ ê°€ë¡œ ìŠ¤í¬ë¡¤ OK
        canvas.height = 260;

        if (wtChart) wtChart.destroy();

        const labels = pts.map(p => `${p.x.getFullYear()}-${String(p.x.getMonth()+1).padStart(2,'0')}-${String(p.x.getDate()).padStart(2,'0')}`);
        const data   = pts.map(p => p.y);

        wtChart = new Chart(canvas.getContext('2d'), {
            type:'line',
            data:{ labels, datasets:[{
                    label:'ëª¸ë¬´ê²Œ(kg)',
                    data,
                    borderWidth:2, borderColor:'#111', backgroundColor:'#111',
                    tension:.25, pointRadius:5, pointHoverRadius:6,
                    pointStyle:(ctx)=>feedPointStyle(pts[ctx.dataIndex]?.feedType)
                }]},
            options:{
                responsive:false, maintainAspectRatio:false,
                scales:{
                    x:{ ticks:{ display:false }, grid:{ display:false } }, // x ë¼ë²¨ ìˆ¨ê¹€
                    y:{ title:{ display:true, text:'kg' } }
                },
                plugins:{ legend:{ display:false } }
            }
        });

        // ë²”ë¡€ë„ ì¤‘ë³µ ì œê±°ëœ í¬ì¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ
        renderFeedLegend(pts);
    }



    /* ===== ë°°ë³€ í‘œ(ìµœê·¼ 14ì¼/20ê±´ ê¸°ë³¸ + í•„í„°/ì´ìƒë§Œ/ë”ë³´ê¸°) ===== */
    // ë°°ë³€ í‘œ ìƒíƒœ
    const litState = { limit:20, offset:0, days:14, types:['pee','poop','unknown'], anomaliesOnly:false, loading:false };
    // âœ… ì´ë¯¸ ì¶”ê°€í•œ í•­ëª© í‚¤(ì¤‘ë³µ ë°©ì§€ìš©)
    const litSeenKeys = new Set();

    // ê° ì´ë²¤íŠ¸ì˜ ê³ ìœ  í‚¤ ìƒì„±: idê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ë‚ ì§œ+ì¢…ë¥˜(+ë…¸íŠ¸ ì¼ë¶€)ë¡œ ëŒ€ì²´
    function litKey(it){
        if (it && it.id != null) return `id:${it.id}`;
        const t = it?.detectedAt || it?.createdAt || it?.time || '';
        const type = it?.type || '';
        const note = (normalizeNotesField(it?.notes) || '').slice(0,50); // ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ
        return `t:${t}|${type}|${note}`;
    }


    function mapType(t){ return t==='pee' ? 'ğŸ’§ ì†Œë³€' : t==='poop' ? 'ğŸ’© ëŒ€ë³€' : 'â“ ë¯¸ë¶„ë¥˜'; }
    function hasNotable(it){
        if (Array.isArray(it.anomalies) && it.anomalies.length) return true;
        const n = (it.notes||'');
        return /(ìƒ‰=.+ì´ìƒ|ì²´ë¥˜=ê¸¸ë‹¤|í˜ì£¼ê¸°|ê³¼ë„í•œ íŒŒê¸°|í˜ˆ|ê²€ë¶‰|ë…¹ìƒ‰|ê±°í’ˆ|ì ì•¡)/.test(n);
    }
    async function fetchLitter({append=false}={}){
        if (litState.loading) return;             // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        litState.loading = true;
        const moreBtn = document.getElementById('btnMoreLitter');
        moreBtn.disabled = true;                  // ë¡œë”© ì¤‘ ì ê¹ ë¹„í™œì„±í™”
        moreBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

        // append=falseë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ
        if (!append) {
            litRaw = [];
            litSeenKeys.clear();
            litState.offset = 0;
        }

        const q = new URLSearchParams();
        q.set('petId', petId);
        q.set('limit', litState.limit);
        q.set('offset', litState.offset);
        if (litState.days) q.set('days', litState.days);
        if (litState.types.length && litState.types.length < 3){
            q.set('type',  litState.types.join(','));
            q.set('types', litState.types.join(','));
        }
        if (litState.anomaliesOnly) q.set('anomaliesOnly','true');

        let r = await fetch(`${API_BASE}/api/litter/events?${q}`, { headers:{'Accept':'application/json'} });
        if (!r.ok) r = await fetch(`${API_BASE}/api/litter/recent?${q}`, { headers:{'Accept':'application/json'} });
        if (!r.ok) {
            moreBtn.disabled = false;
            moreBtn.textContent = 'ë”ë³´ê¸°';
            litState.loading = false;
            return;
        }

        const js = await r.json();
        const list = Array.isArray(js.data) ? js.data : (Array.isArray(js) ? js : []);

        // âœ… ì¤‘ë³µ ì œê±°í•˜ì—¬ litRawì—ë§Œ ì¶”ê°€
        const before = litSeenKeys.size;
        for (const it of list) {
            const k = litKey(it);
            if (!litSeenKeys.has(k)) {
                litSeenKeys.add(k);
                litRaw.push(it);
            }
        }
        const added = litSeenKeys.size - before;

        // í™”ë©´ ê°±ì‹ (í•­ìƒ ë¡œì»¬ í•„í„° ì ìš©)
        renderLitter(applyLitterFilters());

        // í˜ì´ì§€ ì´ë™/ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
        if (append) {
            if (added === 0) {
                // ì„œë²„ê°€ ê°™ì€ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë³´ëƒˆê±°ë‚˜ ë” ì´ìƒ ì—†ìŒ
                moreBtn.disabled = true;
                moreBtn.textContent = 'ë” ì´ìƒ ì—†ìŒ';
            } else {
                // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì „ì§„
                litState.offset += litState.limit;
                moreBtn.disabled = false;
                moreBtn.textContent = 'ë”ë³´ê¸°';
            }
        } else {
            // ì²« ë¡œë“œ
            litState.offset = list.length ? litState.limit : 0;
            moreBtn.disabled = list.length < litState.limit;
            moreBtn.textContent = moreBtn.disabled ? 'ë” ì´ìƒ ì—†ìŒ' : 'ë”ë³´ê¸°';
        }

        litState.loading = false;
    }



    // â–¼ ì •ìƒ/ë¶ˆí•„ìš” ë¬¸êµ¬ ì œê±° + ì´ìƒ í‚¤ì›Œë“œë§Œ ë‚¨ê¸°ê¸°
    const BAD_RE = /(í˜ˆ|í”¼|ê²€ë¶‰|ì ìƒ‰|ë…¹ìƒ‰|ê²€ì€|í‘ìƒ‰|ê±°í’ˆ|ì ì•¡|ì„¤ì‚¬|ë¬½|ë”±ë”±|ì•…ì·¨|ì¥ì‹œê°„|ì˜¤ë˜|>\s*\d+\s*ì´ˆ|ë¶„|ë¬´ë…¸ì¶œ|ë°°ë‡¨ì—†ìŒ|ë°°ë³€ì—†ìŒ|ì†ŒëŸ‰|ê³¼ë‹¤|í˜ì£¼ê¸°)/;

    function tryParseJSON(s){ try{ return JSON.parse(s); } catch { return null; } }

    function normalizeNotesField(n){
        if (n == null) return '';
        if (Array.isArray(n)) return n.join('; ');
        if (typeof n === 'object') return Object.values(n).join('; ');
        if (typeof n === 'string'){
            const t = n.trim();
            const parsed = (t.startsWith('[') || t.startsWith('{')) ? tryParseJSON(t) : null;
            if (Array.isArray(parsed)) return parsed.join('; ');
            if (parsed && typeof parsed === 'object') return Object.values(parsed).join('; ');
            return t.replace(/^\[|\]$/g,'').replace(/['"]/g,''); // bracket/quote ì œê±°
        }
        return String(n);
    }

    function onlyAbnormal(text){
        if (!text) return '';
        const tokens = text
            .replace(/ê·¼ê±°\s*:\s*/gi,'')
            .replace(/íŠ¹ì´ì‚¬í•­\s*:\s*/gi,'')
            .split(/[;,Â·]/)                  // ì„¸ë¯¸ì½œë¡ /ì½¤ë§ˆ/ì¤‘ì  ê¸°ì¤€ ë¶„ë¦¬
            .map(s => s.trim())
            .filter(Boolean)
            .filter(s => BAD_RE.test(s) && !/ì •ìƒ|ë³´í†µ|ê²½ë¯¸|ì—†ìŒ/.test(s))  // ì •ìƒ/ë³´í†µ/ê²½ë¯¸ ì œì™¸
            .map(s => s.replace('=', ': ')); // ë³´ê¸° ì¢‹ê²Œ
        return tokens.join(' Â· ');
    }

    function summarizeNotes(it){
        // 1) anomalies ìš°ì„ 
        let an = it.anomalies;
        if (typeof an === 'string') { const p = tryParseJSON(an); if (p) an = p; }
        if (Array.isArray(an) && an.length){
            const txt = onlyAbnormal(an.map(a => typeof a === 'string' ? a : (a.desc||a.name||a.type||'')).join('; '));
            if (txt) return txt;
        }
        // 2) notes ë³´ì¡°
        const txt2 = onlyAbnormal(normalizeNotesField(it.notes));
        return txt2 || '-';
    }

    function applyLitterFilters(){
        let list = [...litRaw];

        // íƒ€ì… í•„í„°
        if (litState.types.length && litState.types.length < 3){
            list = list.filter(x => litState.types.includes(x.type));
        }
        // ì´ìƒë§Œ
        if (litState.anomaliesOnly){
            list = list.filter(x => summarizeNotes(x) !== '-');
        }
        return list;
    }

    function renderLitter(list){
        list = [...list].sort((a,b)=>{
            const ta = new Date(String(a.detectedAt||a.createdAt).replace(' ','T')).getTime() || 0;
            const tb = new Date(String(b.detectedAt||b.createdAt).replace(' ','T')).getTime() || 0;
            return tb - ta; // ìµœì‹  ìš°ì„ 
        });
        const tb = document.getElementById('litTbody');
        tb.innerHTML = '';
        list.forEach(it=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${fmt(it.detectedAt)}</td>
      <td>${it.type==='pee'?'ğŸ’§ ì†Œë³€':it.type==='poop'?'ğŸ’© ëŒ€ë³€':'â“ ë¯¸ë¶„ë¥˜'}</td>
      <td>${summarizeNotes(it)}</td>
    `;
            tb.appendChild(tr);
        });
    }


    // í•„í„°ì¹©
    // íƒ€ì… ì¹©
    $$('.js-type').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            $$('.js-type').forEach(b=>b.classList.remove('chip--active'));
            btn.classList.add('chip--active');
            const t = btn.dataset.type;
            litState.types = (t==='all') ? ['pee','poop','unknown'] : [t];
            // ì„œë²„ ì¬ìš”ì²­ X, ì¦‰ì‹œ ë°˜ì˜
            renderLitter(applyLitterFilters());
        });
    });

    $$('.js-period').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            $$('.js-period').forEach(b=>b.classList.remove('chip--active'));
            btn.classList.add('chip--active');
            wtPeriodDays = Number(btn.dataset.days || 0);  // 0 = ì „ì²´
            renderWeight(applyWeightFilter());             // ì¦‰ì‹œ ë°˜ì˜
        });
    });


    // ì´ìƒë§Œ ì²´í¬
    document.getElementById('litAnom').addEventListener('change', e=>{
        litState.anomaliesOnly = !!e.target.checked;
        // ì„œë²„ ì¬ìš”ì²­ X, ì¦‰ì‹œ ë°˜ì˜
        renderLitter(applyLitterFilters());
    });

    // ë”ë³´ê¸°(ì¶”ê°€ ë¡œë“œë§Œ ì„œë²„ í˜¸ì¶œ)
    document.getElementById('btnMoreLitter').addEventListener('click', ()=>{
        litState.offset += litState.limit;
        fetchLitter({ append:true });
    });


    /* ===== ë°©ë¬¸ ì¹´ë“œ(ê°„ë‹¨) ===== */
    let _visits = [];
    function visitCardHTML(v){
        const date = fmt(v.visitDate);
        const pCount = Array.isArray(v.prescriptions)? v.prescriptions.length : 0;
        const lCount = Array.isArray(v.labResults)? v.labResults.length : 0;
        return `
      <div class="row" style="justify-content:space-between">
        <div><b>${safe(v.hospital,'(ë³‘ì› ë¯¸ì…ë ¥)')}</b></div>
        <div class="muted">ë°©ë¬¸ì¼ Â· ${date}</div>
      </div>
      <div class="muted">${safe(v.diagnosis,'ì§„ë‹¨ ë¯¸ì…ë ¥')}</div>
      <div class="row" style="margin-top:8px;gap:8px">
        <span class="chip ${pCount?'':'chip--muted'}">ì²˜ë°© ${pCount}ê±´</span>
        <span class="chip ${lCount?'':'chip--muted'}">ê²€ì‚¬ ${lCount}ê±´</span>
        <button class="btn btn-detail" data-id="${v.id}" style="margin-left:auto">ìƒì„¸ë³´ê¸°</button>
      </div>
    `;
    }

    function bindVisitClickHandler(){
        const box = $('#visitCards');
        if (!box || box.dataset.bound === '1') return; // ì´ë¯¸ ë°”ì¸ë”© ë¨

        box.addEventListener('click', (e)=>{
            const btn = e.target.closest('.btn-detail');
            if (!btn) return;
            const id = Number(btn.dataset.id);
            const v = _visits.find(x => String(x.id) === String(id));
            if (v) openVisitModal(v);
        }); // âŒ once:true ì œê±°!

        box.dataset.bound = '1';
    }

    function renderVisits(visits){
        const box = $('#visitCards'); box.innerHTML = '';
        if (!Array.isArray(visits)||!visits.length){ $('#visitEmpty').hidden=false; return; }
        $('#visitEmpty').hidden = true;
        visits.sort((a,b)=>{
            const da = a.visitDate ? new Date(String(a.visitDate).replace(' ','T')).getTime() : 0;
            const db = b.visitDate ? new Date(String(b.visitDate).replace(' ','T')).getTime() : 0;
            return db - da;
        });
        _visits = visits;
        visits.forEach(v=>{
            const card = document.createElement('div');
            card.className = 'visit';
            card.innerHTML = visitCardHTML(v);
            box.appendChild(card);
        });
        bindVisitClickHandler();
    }
    function prescriptionsTableHTML(list){
        if (!Array.isArray(list)||!list.length) return `<div class="muted">ì²˜ë°©ì „ ì—†ìŒ</div>`;
        const rows = list.map(p=>`
      <tr><td>${safe(p.drugName)}</td><td>${doseStr(p)}</td><td>${safe(p.notes)}</td></tr>`).join('');
        return `<table><thead><tr><th style="width:40%">ì•½í’ˆëª…</th><th style="width:40%">ìš©ë²•/ìš©ëŸ‰</th><th>ë¹„ê³ </th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    function doseStr(p){
        const v = (p.doseValue!=null ? p.doseValue : null);
        const unit = p.doseUnit ? p.doseUnit : '';
        const f = (p.freqPerDay!=null ? `${p.freqPerDay}íšŒ/ì¼` : null);
        const d = (p.durationDays!=null ? `${p.durationDays}ì¼` : null);
        return [v!=null?`${v}${unit? ' '+unit:''}`:null, f, d].filter(Boolean).join(' Â· ') || '-';
    }
    function labsTableHTML(list){
        if (!Array.isArray(list)||!list.length) return `<div class="muted">ê²€ì‚¬ ê²°ê³¼ ì—†ìŒ</div>`;
        const rows = list.map(l=>{
            const ref = (l.refLow!=null || l.refHigh!=null) ? `${l.refLow??''} ~ ${l.refHigh??''}` : '-';
            const flag = (l.flag||'N').toUpperCase();
            const cls = flag==='H'?'color:#b91c1c;font-weight:700' : flag==='L'?'color:#1d4ed8;font-weight:700' : 'color:#16a34a;font-weight:700';
            return `<tr>
        <td>${safe(l.testName)}</td>
        <td>${l.resultValue!=null?l.resultValue:'-'} ${safe(l.unit,'')}</td>
        <td>${ref}</td>
        <td style="${cls}">${flag}</td>
        <td>${safe(l.notes)}</td>
      </tr>`;
        }).join('');
        return `<table><thead><tr><th style="width:28%">ê²€ì‚¬ í•­ëª©</th><th style="width:22%">ê²°ê³¼</th><th style="width:22%">ì°¸ê³ ë²”ìœ„</th><th style="width:8%">Flag</th><th>ë¹„ê³ </th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    function openVisitModal(v){
        $('#visitTitle').textContent = `${safe(v.hospital)} Â· ë°©ë¬¸ì¼ ${fmt(v.visitDate)}`;
        $('#visitBody').innerHTML = `
      <div class="chip">ì˜ì‚¬: ${safe(v.doctor)}</div>
      <div class="chip">ì§„ë‹¨: ${safe(v.diagnosis)}</div>
      <h4 style="margin:10px 0 6px">ì²˜ë°©ì „</h4>
      ${prescriptionsTableHTML(v.prescriptions||[])}
      <h4 style="margin:14px 0 6px">ê²€ì‚¬ ê²°ê³¼</h4>
      ${labsTableHTML(v.labResults||[])}
    `;
        $('#btnOpenDocs').onclick = ()=> openDocsModal(v);
        $('#closeVisitModal').onclick = ()=> closeModal('#visitModal');
        $('#closeVisitModal2').onclick = ()=> closeModal('#visitModal');
        $('#visitModal').onclick = (e)=>{ if(e.target.id==='visitModal') closeModal('#visitModal'); };
        openModal('#visitModal');
    }
    function docsGridHTML(docs){
        if (!Array.isArray(docs)||!docs.length) return `<div class="muted">ì›ë³¸ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
        const isImg = u=>/\.(png|jpe?g|webp|gif)$/i.test(u||'');
        const isPdf = u=>/\.pdf$/i.test(u||'');
        const items = docs.map(d=>{
            const u = d.fileUrl || d.url || '';
            const t = (d.docType||'ë¬¸ì„œ');
            if (isImg(u)){
                return `<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fafafa">
          <img src="${u}" alt="${t}" style="width:100%;height:160px;object-fit:cover;display:block">
          <div style="padding:8px;font-size:12px;color:#555;display:flex;justify-content:space-between;gap:8px;align-items:center">
            <span>${t}</span><a href="${u}" target="_blank" rel="noopener">ìƒˆ ì°½</a>
          </div>
        </div>`;
            } else if (isPdf(u)){
                return `<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fafafa">
          <div style="height:160px;display:grid;place-items:center;color:#666">PDF</div>
          <div style="padding:8px;font-size:12px;color:#555;display:flex;justify-content:space-between;gap:8px;align-items:center">
            <span>${t}</span><a href="${u}" target="_blank" rel="noopener">ì—´ê¸°</a>
          </div>
        </div>`;
            } else {
                return `<div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fafafa">
          <div style="height:160px;display:grid;place-items:center;color:#666">íŒŒì¼</div>
          <div style="padding:8px;font-size:12px;color:#555;display:flex;justify-content:space-between;gap:8px;align-items:center">
            <span>${t}</span><a href="${u}" target="_blank" rel="noopener">ë‹¤ìš´ë¡œë“œ</a>
          </div>
        </div>`;
            }
        }).join('');
        return `<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">${items}</div>`;
    }
    function openDocsModal(v){
        $('#docsTitle').textContent = `ì›ë³¸ ë¬¸ì„œ Â· ë°©ë¬¸ #${safe(v.id)}`;
        $('#docsBody').innerHTML = docsGridHTML(v.documents||[]);
        $('#closeDocsModal').onclick = ()=> closeModal('#docsModal');
        $('#closeDocsModal2').onclick = ()=> closeModal('#docsModal');
        $('#docsModal').onclick = (e)=>{ if(e.target.id==='docsModal') closeModal('#docsModal'); };
        openModal('#docsModal');
    }
    function openModal(sel){ $(sel).style.display='flex'; document.body.style.overflow='hidden'; }
    function closeModal(sel){ $(sel).style.display='none'; document.body.style.overflow=''; }

    /* ===== ì´ë²ˆ ì£¼ ë³€í™”(ë°°ë³€ ìš”ì•½) ===== */
    function weeklyCountsFromEvents(events){
        const thisStart = startOfWeekMon(new Date());
        const nextStart = new Date(thisStart); nextStart.setDate(thisStart.getDate()+7);
        const prevStart = new Date(thisStart); prevStart.setDate(thisStart.getDate()-7);
        const pick = (from,to)=>{
            let pee=0, poop=0;
            for(const e of (events||[])){
                const t = new Date(String(e.detectedAt).replace(' ','T')).getTime();
                if (isNaN(t)) continue;
                if (!inRange(t,from,to)) continue;
                if (e.type==='pee') pee++;
                else if (e.type==='poop') poop++;
            }
            return { pee, poop };
        };
        return { prev: pick(prevStart,thisStart), curr: pick(thisStart,nextStart) };
    }
    function renderLitterDeltas(prev, curr){
        // ê°œë³„(pee, poop) ìˆ«ì ì±„ìš°ê¸°
        $('#peePrev').textContent  = prev ? prev.pee  : '-';
        $('#peeThis').textContent  = curr ? curr.pee  : '-';
        $('#poopPrev').textContent = prev ? prev.poop : '-';
        $('#poopThis').textContent = curr ? curr.poop : '-';

        // í•©ê³„ ê¸°ì¤€ ë¸íƒ€
        const pPrev = prev ? (prev.pee + prev.poop) : null;
        const pCurr = curr ? (curr.pee + curr.poop) : null;
        const el = $('#litterDelta');

        let cls='same', txt='ë³€í™” ì—†ìŒ';
        if (pPrev===null && pCurr===null){ el.className='delta same'; el.textContent='ë°ì´í„° ì—†ìŒ'; return; }
        if (pPrev===null){ el.className='delta up'; el.innerHTML=`<b>ì´ë²ˆì£¼ ${pCurr}ê±´</b>`; return; }
        if (pCurr===null){ el.className='delta same'; el.textContent='ì´ë²ˆì£¼ ë°ì´í„° ì—†ìŒ'; return; }
        const diff = pCurr - pPrev;
        if (diff===0){ cls='same'; txt='ë³€í™” ì—†ìŒ'; }
        else if (diff>0){ cls='up'; txt=`â–² ${diff}ê±´`; }
        else { cls='down'; txt=`â–¼ ${Math.abs(diff)}ê±´`; }
        el.className = 'delta ' + cls; el.innerHTML = `<b>${txt}</b>`;
    }

    /* ===== ì´ˆê¸° ë¡œë“œ ===== */
    (async function init(){
        if (!petId){ $('#title').textContent='petIdê°€ í•„ìš”í•©ë‹ˆë‹¤'; return; }

        // 1) ê¸°ë³¸ ë¦¬í¬íŠ¸
        const url = `${API_BASE}/api/pet/report?petId=${petId}`;
        try{
            const r = await fetch(url,{headers:{'Accept':'application/json'}});
            if(!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();
            const pet = data.pet || {};
            const visits = data.visits || [];
            const logs = data.logs || [];

            const displayName = (pet.name && pet.name.trim()) ? pet.name : `í« #${petId}`;
            $('#title').textContent = `${displayName} ë¦¬í¬íŠ¸`;
            document.title = `${displayName} ë¦¬í¬íŠ¸`;

            renderPet(pet);

            // ê¸‰ì‹/ê¸‰ìˆ˜ ë¸íƒ€
            const food  = weeklyAverages(logs,'foodWeight');
            const water = weeklyAverages(logs,'waterWeight');
            $('#foodPrev').textContent  = (food.prev==null ? '-' : `${food.prev.toFixed(2)} g`);
            $('#foodThis').textContent  = (food.curr==null ? '-' : `${food.curr.toFixed(2)} g`);
            $('#waterPrev').textContent = (water.prev==null ? '-' : `${water.prev.toFixed(2)} mL`);
            $('#waterThis').textContent = (water.curr==null ? '-' : `${water.curr.toFixed(2)} mL`);
            renderDelta($('#foodDelta'),  food.prev,  food.curr,  ' g');
            renderDelta($('#waterDelta'), water.prev, water.curr, ' mL');

            renderVisits(visits);
        } catch(e){
            $('#title').textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
            alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}\nìš”ì²­: ${url}`);
        }

        // 2) ëª¸ë¬´ê²Œ(ê¸°ë³¸ 30ì¼)
        wtPeriodDays = 30;
        await fetchWeightAll();
        setupWeightResizeObserver();

        // 3) ë°°ë³€ í‘œ ê¸°ë³¸(ìµœê·¼ 14ì¼ 20ê±´)
        litState.limit=20; litState.offset=0; litState.days=14;
        fetchLitter();

        // 4) â€œì´ë²ˆ ì£¼ ë³€í™”â€ ë°°ë³€ ìš”ì•½(ì „ì£¼/ì´ë²ˆì£¼ ë¹„êµ)
        //    ë¹„êµë¥¼ ìœ„í•´ ìµœì†Œ 21ì¼ ì •ë„ ì¡°íšŒ
        try{
            const q = new URLSearchParams({petId, days:'21', limit:'100'});
            let r = await fetch(`${API_BASE}/api/litter/events?${q}`,{headers:{'Accept':'application/json'}});
            if (!r.ok) r = await fetch(`${API_BASE}/api/litter/recent?${q}`,{headers:{'Accept':'application/json'}});
            if (r.ok){
                const js = await r.json();
                const list = Array.isArray(js.data) ? js.data : (Array.isArray(js) ? js : []);
                const {prev, curr} = weeklyCountsFromEvents(list);
                renderLitterDeltas(prev, curr);
            }
        } catch{ /* ë¬´ì‹œ: ë°°ë³€ ì¹´ë“œë§Œ ë¹„ì–´ìˆìŒ */ }
    })();
</script>
</body>
</html>