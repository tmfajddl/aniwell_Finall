<!DOCTYPE html>
<html lang="ko">

<head>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Aniwell Dashboard</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" th:href="@{/resource/css/petPage.css}">
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<link rel="stylesheet" th:href="@{/resource/css/global.css}">
	<script th:src="@{/resource/js/calendar.js}"></script>

	<style>
		#activityTimeline .bar-row {
			position: relative;
			height: 50px;
			background: #fff;
		}

		#activityTimeline .bars {
			height: 30px;
			border-radius: 20px;
			position: absolute;
		}

		#activityTimeline .time-label {
			position: absolute;
			font-size: 12px;
			color: #666;
			top: 0;
			transform: translateX(-50%);
		}

		#activityTimeline .bars:hover::after {
			content: attr(data-tooltip);
			position: absolute;
			top: -35px;
			left: 0;
			white-space: nowrap;
			background: #444;
			color: #fff;
			padding: 5px 8px;
			border-radius: 5px;
			font-size: 12px;
			z-index: 10;
		}
	</style>


</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] h-screen min-h-dvh min-w-[1400px]">
	<div class="flex h-screen w-full">
		<!-- Sidebar -->
		<div th:replace="common :: siteHeader" class=""></div>

		<!-- Main content -->
		<!-- Main content -->
		<main class="main_page h-full overflow-y-auto min-h-dvh box-border grid-cols-12 flex-1 p-6 pt-8 grid  gap-8">

			<!-- ì™¼ìª½ 8ì¹¸: ì°¨íŠ¸ + ê°ì •ë¶„ì„ + ìº˜ë¦°ë” -->
			<section class="col-span-12 xl:col-span-8 flex flex-col gap-2  w-full">
				<!-- ê°ì •ë¶„ì„ ì¹´ë“œ -->
				<div class="grid grid-cols-2 gap-2">
					<div class="relative group overflow-hidden bg-gradient-to-r from-[#DFF8E5] to-[#F4FBCC] rounded-xl p-4 text-center shadow hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer w-full"
						onclick="openEmotionPanel()">

						<!-- âœ… ë°°ê²½ ì´ë¯¸ì§€ -->
						<div
							class="absolute p-3 pr-6 inset-0 z-0 flex justify-end items-end pointer-events-none transition-all duration-300 group-hover:opacity-60 group-hover:scale-95">
							<img src="/img/emo-cat.png" alt="ê°ì • ì•„ì´ì½˜"
								class="h-32 select-none transition-all duration-300 transform" />
						</div>

						<!-- âœ… í…ìŠ¤íŠ¸ -->
						<div class="relative z-10 text-left text-3xl font-bold text-black leading-snug">
							ìš°ë¦¬ì•„ì´
							<br />
							ê°ì •ë¶„ì„í•˜ê¸°
						</div>

					</div>

					<!-- ìŠ¬ë¼ì´ë“œ ê°ì • ë¶„ì„ íŒ¨ë„ -->
					<div id="emotionPanel"
						class="fixed row-span-3 top-0 right-0 w-[95%] h-full bg-[white] shadow-xl z-50 transform translate-x-full transition-transform duration-300 rounded-l-[40px] flex flex-col p-6">

						<!-- ë‹«ê¸° ë²„íŠ¼ -->
						<button onclick="closeEmotionPanel()"
							class="absolute top-4 left-4 text-3xl text-gray-500 hover:text-black font-bold">Ã—</button>

						<!-- ì œëª© -->
						<h2 class="text-xl font-bold text-gray-700 text-center mb-4 mt-10">ê°ì • ë¶„ì„í•˜ê¸°</h2>

						<button id="retryButton" onclick="resetEmotionPanel()"
							class="hidden mt-6 mx-auto px-6 py-2 rounded-full bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition">
							ğŸ” ë‹¤ì‹œ ë¶„ì„í•˜ê¸°</button>

						<!-- ğŸ¶ ë™ë¬¼ ì¢… ì„ íƒ -->
						<div class="flex justify-center gap-4 mb-4">
							<button onclick="selectSpecies('ê°•ì•„ì§€')"
								class="species-btn px-4 py-2 rounded-full border border-yellow-400 text-yellow-600 font-semibold bg-white hover:bg-yellow-100">ğŸ¶
								ê°•ì•„ì§€</button>
							<button onclick="selectSpecies('ê³ ì–‘ì´')"
								class="species-btn px-4 py-2 rounded-full border border-yellow-400 text-yellow-600 font-semibold bg-white hover:bg-yellow-100">ğŸ±
								ê³ ì–‘ì´</button>
						</div>

						<!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
						<div id="imageContainer"
							class="w-[100%] h-[80%] mx-auto rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center">
							<img id="emotionPreview" class="w-full h-full object-cover">
						</div>

						<!-- íŒŒì¼ ì—…ë¡œë“œ -->
						<label class="upload-label mt-4 mx-auto text-sm text-gray-600 cursor-pointer hover:text-black">
							â¬†ï¸ ì‚¬ì§„ ì—…ë¡œë“œ
							<input type="file" accept="image/*" onchange="previewImage(event)" class="hidden">
						</label>

						<!-- ê°ì • ë¶„ì„ ë²„íŠ¼ -->
						<button
							class="analyze-btn mt-6 mx-auto px-6 py-2 rounded-full bg-yellow-300 text-white font-semibold hover:bg-yellow-400 transition"
							onclick="analyzeEmotion()">ê°ì • ë¶„ì„í•˜ê¸°</button>

						<!-- ë¶„ì„ ê²°ê³¼ -->
						<!-- ğŸ¾ ê²°ê³¼ í‘œì‹œ ì˜ì—­ (ì²˜ìŒì—ëŠ” hidden) -->
						<div id="resultArea" class="hidden flex mt-6 w-full gap-6 justify-center items-center">
							<!-- ğŸ“¸ ì™¼ìª½: ì´ë¯¸ì§€ -->
							<div class="w-1/2 max-w-[300px]">
								<img id="resultImage" class="w-full rounded-xl shadow-lg border-4 border-yellow-100">
							</div>

							<!-- ğŸ“Š ì˜¤ë¥¸ìª½: í…ìŠ¤íŠ¸ + ì°¨íŠ¸ -->
							<div class="w-1/2 max-w-[300px] text-center">
								<div id="resultText" class="font-semibold text-gray-800 mb-2 text-lg"></div>
								<canvas id="emotionChart" width="200" height="200" class="mx-auto mt-2"></canvas>
							</div>
						</div>

					</div>


					<div id="summaryCardMain"
						class="relative bg-gradient-to-r from-[#DFF8E5] to-[#F4FBCC] rounded-xl p-4 text-center shadow hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer">
						<a href="./detailPage.html">
							ìƒì„¸ ê¸°ì…ë€
						</a>
					</div>

				</div>


				<!-- ì£¼ë³€ í«ì‚´ ë³´ê¸° -->
				<div class="flex gap-2 w-full grid-cols-2 ">
					<a th:href="@{/usr/pet/explain(petId=${pet.id})}"
						class="flex-1 hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer shadow block bg-gradient-to-r from-[#EEE8CD] to-[#F4FBCC] rounded-xl p-3 text-sm text-center font-semibold transition">
						ê²€ì‚¬ ê²°ê³¼ ë¶„ì„</a>
					<a th:href="@{/usr/pet/qr(petId=${pet.id})}"
						class="flex-1 hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer shadow block bg-gradient-to-r from-[#EEE8CD] to-[#F4FBCC] rounded-xl p-3 text-sm text-center font-semibold transition">
						QR ë ˆí¬íŠ¸</a>
					<a th:href="@{/usr/pet/ocr(petId=${pet.id})}"
						class="flex-1 hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer shadow block bg-gradient-to-r from-[#EEE8CD] to-[#F4FBCC] rounded-xl p-3 text-sm text-center font-semibold transition">
						OCR ì½ê¸° </a>
					<a th:href="@{/usr/pet/petPlace}"
						class="flex-1 hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer shadow block bg-gradient-to-r from-[#EEE8CD] to-[#F4FBCC] rounded-xl p-3 text-sm text-center font-semibold transition">
						ì£¼ë³€ í«ìƒµ ì•Œì•„ë³´ê¸° </a>
					<a th:href="@{/usr/pet/daily(petId=${pet.id})}"
						class="flex-1 hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer shadow block bg-gradient-to-r from-[#EEE8CD] to-[#F4FBCC] rounded-xl p-3 text-sm text-center font-semibold transition">
						ê°ì • ì¼ê¸° </a>

				</div>



				<div class=" bg-white h-1/3 flex ">
					<div class="w-full rounded-xl p-2 shadow overflow-x-auto">
						<canvas id="myChart" class="w-full h-full"></canvas>
					</div>

					<div id="feedingPanel" class="fixed top-0 right-0 
					w-[95%] h-full bg-white shadow-xl 
					z-40 transform translate-x-full 
					transition-transform duration-300 
					rounded-l-[40px] flex flex-col p-6 overflow-auto">

						<!-- ë‹«ê¸° ë²„íŠ¼ -->
						<button onclick="closeFeedingPanel()"
							class="absolute top-4 left-4 text-3xl text-gray-500 hover:text-black font-bold">Ã—</button>

						<h2 class="text-xl font-bold text-gray-700 text-center mb-6 mt-10">ğŸ“ í•˜ë£¨ ê±´ê°• ë¦¬í¬íŠ¸</h2>

						<!-- ë‚ ì§œ ì„ íƒ -->
						<div class="text-center mb-4">
							<input type="date" id="datePicker" class="border rounded px-3 py-2 shadow-sm" />
						</div>

						<!-- 1. ì‚¬ë£Œ ì°¨íŠ¸ -->
						<div class="h-[200px] mb-10 w-full px-4">
							<h3 class="text-lg font-bold text-gray-800 mb-2">ğŸš ì‚¬ë£Œ</h3>
							<div class="w-full h-full bg-white rounded-xl shadow p-4">
								<canvas id="weightChart" class="w-full h-full"></canvas>
							</div>
						</div>

						<!-- 2. ë¬¼ ì„­ì·¨ëŸ‰ ì°¨íŠ¸ -->
						<div class="h-[200px] mb-10 w-full px-4">
							<h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’§ ë¬¼</h3>
							<div class="w-full h-full bg-white rounded-xl shadow p-4">
								<canvas id="waterChart" class="w-full h-full"></canvas>
							</div>
						</div>

						<!-- 3. ë°°ë³€ íšŸìˆ˜ -->
						<div class="h-[300px]">
							<h3 class="text-lg font-bold text-gray-800 mb-2">ğŸš½ ë°°ë³€</h3>
							<div class="overflow-y-auto max-h-[250px]">
								<table class="w-full max-w-2xl mx-auto text-sm border border-gray-300 rounded-lg">
									<thead class="bg-gray-100">
										<tr>
											<th class="p-2 border">ì‹œê°„</th>
											<th class="p-2 border">ë°°ë³€ ì¢…ë¥˜</th>
										</tr>
									</thead>
									<tbody id="poopTableBody">
										<!-- JavaScriptë¡œ í–‰ ì¶”ê°€ë¨ -->
									</tbody>
								</table>
							</div>
						</div>
					</div>



				</div>


				<div class="bg-white p-4 rounded-xl shadow min-h-content flex relative ">
					<!-- â›³ï¸ ê¸°ì¡´: <canvas id="myChart_Sc" ...> ì œê±° -->
					<!-- âœ… í™œë™ íƒ€ì„ë¼ì¸ ì‹œì‘ -->
					<div id="activityTimeline" class="w-full">
						<div class="flex items-center justify-between mb-2">
							<h3 class="text-lg font-bold text-gray-800">ğŸ•’ í™œë™ íƒ€ì„ë¼ì¸</h3>
							<!-- íŒ¨ë„ì— ì´ë¯¸ #datePicker ê°€ ìˆìœ¼ë‹ˆ ì—¬ê¸°ì„  ì•ˆ ë„£ìŠµë‹ˆë‹¤ -->
						</div>
						<!-- âœ… ë²”ë¡€ -->
						<div id="activityLegend" class="flex items-center gap-6 text-gray-600 text-sm mb-1"></div>

						<div id="activityChartWrapper"
							class="overflow-x-auto mt-2 border-t border-dashed border-gray-300">
							<!-- ì‹œê°„ ëˆˆê¸ˆ -->
							<div id="activityTimeGrid" class="relative h-5 border-b border-dashed min-w-[1920px]"></div>
							<!-- ë°” ì°¨íŠ¸ í–‰ë“¤ì´ ë“¤ì–´ê°ˆ ì˜ì—­ -->
							<div id="activityChartArea" class="min-w-[1920px] flex flex-col gap-2 py-4"></div>
						</div>

					</div>
					<div id="activityNoData" class="hidden text-center text-gray-500 left-[45%] top-[45%] absolute">
						ì˜¤ëŠ˜ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤
					</div>
				</div>
				<!-- âœ… í™œë™ íƒ€ì„ë¼ì¸ ë -->



			</section>

			<!-- ì˜¤ë¥¸ìª½ 4ì¹¸: ê³ ì–‘ì´ ì •ë³´ + ì£¼ë³€ í«ì‚´ -->
			<div class="col-span-4 hidden xl:flex min-w-[150px] h-full flex flex-col gap-2 min-h-0 overflow-hidden">


				<!-- ì™¼ìª½: ì¼ì •/ë²„íŠ¼ -->
				<div
					class="flex min-w-[150px] h-1/4 flex-1 rounded-xl flex-col gap-2 w-full shadow relative bg-gradient-to-b from-[#FFFFFF] to-[#FFFCEF]">
					<!-- ìƒë‹¨ + ë²„íŠ¼ í¬í•¨í•œ í—¤ë” -->

					<!-- ì¼ì • ëª©ë¡ -->
					<div class="w-full py-3">
						<!-- ğŸ¾ ë¦¬ìŠ¤íŠ¸ í—¤ë” -->
						<div class="px-4 py-1 font-bold text-gray-700">
							<div class="flex pb-1 mb-1 justify-between items-center border-b-2 border-gray-200">
								<span id="current-month-label" class="pl-6 text-lg font-bold"></span>
								<button
									class="mr-3 shadow hover:shadow-md transition-shadow duration-300 font-semibold cursor-pointer w-8 h-6 rounded-full bg-[#fdf6c2] shadow flex items-center justify-center text-lg font-bold"
									onclick="openTodayVaccineModal()">+</button>

							</div>
							ì˜ˆë°©ì ‘ì¢… ë¦¬ìŠ¤íŠ¸
						</div>
					</div>
					<!-- âœ… ì‹¤ì œ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë“¤ì–´ê° -->
					<div id="monthly-vaccine-list" class="px-4 pt-2 space-y-2 overflow-y-auto h-[80%]">
						<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ appendChildë¡œ ì¶”ê°€ë¨ -->
					</div>

				</div>
				<!-- ìº˜ë¦°ë” -->
				<div class="flex gap-2 flex-1">

					<!-- ì˜¤ë¥¸ìª½: ìº˜ë¦°ë” -->
					<div
						class=" min-w-[170px] h-[325px] bg-gradient-to-r from-[#F4FBCC] to-[#FDF7DA] rounded-xl p-4 flex-1 shadow">
						<div id="calendar-container" class="w-full"></div>
					</div>

				</div>
			</div>



			<!-- ë°±ì‹  ë“±ë¡ ëª¨ë‹¬ -->
			<div id="vaccineModal"
				class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
				<div class="bg-white rounded-2xl p-6 w-[400px] relative shadow-lg">
					<!-- ë‹«ê¸° ë²„íŠ¼ -->
					<button onclick="closeVaccineModal()"
						class="absolute top-3 right-3 text-gray-500 hover:text-red-500 text-xl">Ã—</button>

					<h2 class="text-xl font-bold mb-4 text-yellow-700 text-center">ğŸ¾ ë°±ì‹  ë“±ë¡</h2>

					<form id="vaccineForm">
						<input type="hidden" name="petId" th:value="${petId}" />

						<div class="mb-4">
							<label class="block font-semibold text-sm mb-1">ë°±ì‹  ì´ë¦„</label>
							<select name="vaccineName" required class="w-full border px-3 py-2 rounded">
								<option value="">ì„ íƒí•˜ì„¸ìš”</option>
								<option value="Rabies">Rabies</option>
								<option value="Parvovirus">Parvovirus</option>
								<option value="Distemper">Distemper</option>
								<option value="Feline Distemper">Feline Distemper</option>
								<option value="Feline Leukemia">Feline Leukemia</option>
								<option value="Leptospirosis">Leptospirosis</option>
								<option value="Bordetella">Bordetella</option>
								<option value="Feline Panleukopenia">Feline Panleukopenia</option>
								<option value="FIP">FIP</option>
							</select>
						</div>

						<div class="mb-4">
							<label class="block font-semibold text-sm mb-1">ì ‘ì¢… ë‚ ì§œ</label>
							<input type="date" name="injectionDate" id="injectionDateInput" required
								class="w-full border px-3 py-2 rounded" />
						</div>

						<div class="mb-4">
							<label class="block font-semibold text-sm mb-1">ë¹„ê³ </label>
							<textarea name="notes" rows="3" class="w-full border px-3 py-2 rounded"></textarea>
						</div>

						<div class="flex justify-between mt-6">
							<button type="submit"
								class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded">ğŸ’¾
								ë“±ë¡</button>
							<button type="button" onclick="closeVaccineModal()"
								class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">âŒ
								ì·¨ì†Œ</button>
						</div>
					</form>
				</div>
			</div>

			<!-- âœ… ë°±ì‹  ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
			<div id="vaccineDetailModal"
				class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
				<div class="bg-white p-6 rounded-2xl w-[400px] relative">
					<button onclick="closeVaccineDetailModal()"
						class="absolute top-3 right-3 text-gray-500 hover:text-red-500">Ã—</button>

					<div id="vaccineDetailView">
						<h2 class="text-lg font-bold text-center mb-4">ğŸ’‰ ë°±ì‹  ìƒì„¸ì •ë³´</h2>
						<p>
							<b>ì´ë¦„:</b>
							<span id="detailName"></span>
						</p>
						<p>
							<b>ì ‘ì¢…ì¼:</b>
							<span id="detailDate"></span>
						</p>
						<p>
							<b>ë¹„ê³ :</b>
							<span id="detailNotes"></span>
						</p>

						<div class="flex justify-between mt-4">
							<button id="editBtn" onclick="enterEditMode()"
								class="bg-yellow-400 px-3 py-2 rounded text-white">âœ ìˆ˜ì •</button>
							<button id="deleteBtn" onclick="deleteVaccination()"
								class="bg-red-400 px-3 py-2 rounded text-white">ğŸ—‘
								ì‚­ì œ</button>
						</div>

					</div>

					<form id="vaccineEditForm" class="hidden mt-4">
						<input type="hidden" name="vaccinationId" />
						<label class="block mt-2">ì´ë¦„</label>
						<input type="text" name="vaccineName" class="border w-full px-2 py-1 rounded" required />

						<label class="block mt-2">ì ‘ì¢…ì¼</label>
						<input type="date" name="injectionDate" class="border w-full px-2 py-1 rounded" required />

						<label class="block mt-2">ë¹„ê³ </label>
						<textarea name="notes" rows="3" class="border w-full px-2 py-1 rounded"></textarea>

						<div class="flex justify-between mt-4">
							<button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">ğŸ’¾ ì €ì¥</button>
							<button type="button" onclick="cancelEdit()"
								class="bg-gray-400 text-white px-4 py-2 rounded">ì·¨ì†Œ</button>
						</div>
					</form>
				</div>
			</div>


			<div id="multiEventModal"
				class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden">
				<div class="bg-white rounded-lg p-4 w-80">
					<h2 class="font-bold text-lg mb-2">ğŸ’‰ ë°±ì‹  ì ‘ì¢… ë¦¬ìŠ¤íŠ¸</h2>
					<div class="event-list space-y-2"></div>
					<div class="text-right mt-4">
						<button onclick="document.getElementById('multiEventModal').classList.add('hidden')"
							class="text-sm text-gray-500 hover:underline">ë‹«ê¸°</button>
					</div>
				</div>
			</div>



		</main>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>


		<script th:inline="javascript">
			const todayStr = new Date().toISOString().split("T")[0];
			const dateInput = document.getElementById("datePicker");

			const labels = [], deltas = [], bgColors = [], tooltipLabels = [], rawData = [];

			const waterLabels = [], waterDeltas = [], waterBgColors = [], waterTooltipLabels = [];

			let weightChart = null;
			let waterChart = null;
			let stompClient = null;
			let subscription = null;

			function renderFeedingCharts(data) {
				if (!window.Chart) { console.error('Chart.js ë¡œë“œ ì‹¤íŒ¨'); return; }

				// ì „ì—­ ë°°ì—´/ì°¸ì¡° ì‚¬ìš©
				labels.length = deltas.length = bgColors.length = tooltipLabels.length = 0;
				waterLabels.length = waterDeltas.length = waterBgColors.length = waterTooltipLabels.length = 0;
				rawData.length = 0;

				if (!Array.isArray(data)) {
					try { weightChart?.destroy(); } catch {}
					try { waterChart?.destroy(); } catch {}
					weightChart = null; waterChart = null;
					showEmptyState('weightChart', 'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
					showEmptyState('waterChart',  'ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
					return;
				}

				rawData.push(...data);
				data.sort((a, b) => new Date(a.logDate) - new Date(b.logDate));

				for (const cur of data) {
					const t = cur?.logDate ? new Date(cur.logDate).toTimeString().slice(0,5) : null;

					if (t !== null && cur.foodWeight !== null && cur.foodWeight !== undefined && !Number.isNaN(+cur.foodWeight)) {
						const v = +(+cur.foodWeight).toFixed(2);
						labels.push(t);
						deltas.push(v);
						bgColors.push('rgba(255, 193, 7, 0.4)');
						tooltipLabels.push(`ì‚¬ë£Œ ì„­ì·¨ëŸ‰: ${v}g`);
					}
					if (t !== null && cur.waterWeight !== null && cur.waterWeight !== undefined && !Number.isNaN(+cur.waterWeight)) {
						const v = +(+cur.waterWeight).toFixed(2);
						waterLabels.push(t);
						waterDeltas.push(v);
						waterBgColors.push('rgba(30, 144, 255, 0.4)');
						waterTooltipLabels.push(`ë¬¼ ì„­ì·¨ëŸ‰: ${v}g`);
					}
				}

				const hasFood  = labels.length > 0;
				const hasWater = waterLabels.length > 0;

				let foodCtx = null, waterCtx = null;
				try { foodCtx  = sizeCanvasAndGetCtx('weightChart'); } catch (e) { console.warn(e); }
				try { waterCtx = sizeCanvasAndGetCtx('waterChart'); } catch (e) { console.warn(e); }

				if (!hasFood) {
					try { weightChart?.destroy(); } catch {}
					weightChart = null; showEmptyState('weightChart', 'ì‚¬ë£Œ ë°ì´í„°ê°€ ì—†ì–´ìš”');
				} else {
					clearEmptyState('weightChart');
				}
				if (!hasWater) {
					try { waterChart?.destroy(); } catch {}
					waterChart = null; showEmptyState('waterChart', 'ë¬¼ ë°ì´í„°ê°€ ì—†ì–´ìš”');
				} else {
					clearEmptyState('waterChart');
				}

				const yFoodMin  = hasFood  ? Math.min(0, Math.min(...deltas)) : 0;
				const yFoodMax  = hasFood  ? Math.max(0, Math.max(...deltas)) : 0;
				const yWaterMin = hasWater ? Math.min(0, Math.min(...waterDeltas)) : 0;
				const yWaterMax = hasWater ? Math.max(0, Math.max(...waterDeltas)) : 0;

				if (hasFood && foodCtx) {
					if (!weightChart) {
						weightChart = new Chart(foodCtx, {
							type: 'bar',
							data: {
								labels,
								datasets: [{
									label: 'ì‚¬ë£Œ ì„­ì·¨ëŸ‰',
									data: deltas,
									backgroundColor: bgColors,
									borderColor: bgColors.map(c => c.replace('0.4', '1')),
									borderWidth: 1
								}]
							},
							options: {
								responsive: false,
								maintainAspectRatio: false,
								scales: {
									y: {
										beginAtZero: false,
										suggestedMin: yFoodMin - Math.abs(yFoodMax - yFoodMin) * 0.1,
										suggestedMax: yFoodMax + Math.abs(yFoodMax - yFoodMin) * 0.1,
										title: { display: true, text: 'g' }
									},
									x: { title: { display: true, text: 'ì‹œê°„ (HH:MM)' } }
								},
								plugins: { tooltip: { callbacks: { label: ctx => tooltipLabels[ctx.dataIndex] } } }
							}
						});
					} else {
						weightChart.data.labels = labels;
						weightChart.data.datasets[0].data = deltas;
						weightChart.data.datasets[0].backgroundColor = bgColors;
						weightChart.data.datasets[0].borderColor = bgColors.map(c => c.replace('0.4', '1'));
						weightChart.options.scales.y.suggestedMin = yFoodMin - Math.abs(yFoodMax - yFoodMin) * 0.1;
						weightChart.options.scales.y.suggestedMax = yFoodMax + Math.abs(yFoodMax - yFoodMin) * 0.1;
						weightChart.update();
						setTimeout(() => { try { weightChart.resize(); } catch {} }, 0);
					}
				}

				if (hasWater && waterCtx) {
					if (!waterChart) {
						waterChart = new Chart(waterCtx, {
							type: 'bar',
							data: {
								labels: waterLabels,
								datasets: [{
									label: 'ë¬¼ ì„­ì·¨ëŸ‰',
									data: waterDeltas,
									backgroundColor: waterBgColors,
									borderColor: waterBgColors.map(c => c.replace('0.4', '1')),
									borderWidth: 1
								}]
							},
							options: {
								responsive: false,
								maintainAspectRatio: false,
								scales: {
									y: {
										beginAtZero: false,
										suggestedMin: yWaterMin - Math.abs(yWaterMax - yWaterMin) * 0.1,
										suggestedMax: yWaterMax + Math.abs(yWaterMax - yWaterMin) * 0.1,
										title: { display: true, text: 'g' }
									},
									x: { title: { display: true, text: 'ì‹œê°„ (HH:MM)' } }
								},
								plugins: { tooltip: { callbacks: { label: ctx => waterTooltipLabels[ctx.dataIndex] } } }
							}
						});
					} else {
						waterChart.data.labels = waterLabels;
						waterChart.data.datasets[0].data = waterDeltas;
						waterChart.data.datasets[0].backgroundColor = waterBgColors;
						waterChart.data.datasets[0].borderColor = waterBgColors.map(c => c.replace('0.4', '1'));
						waterChart.options.scales.y.suggestedMin = yWaterMin - Math.abs(yWaterMax - yWaterMin) * 0.1;
						waterChart.options.scales.y.suggestedMax = yWaterMax + Math.abs(yWaterMax - yWaterMin) * 0.1;
						waterChart.update();
						setTimeout(() => { try { waterChart.resize(); } catch {} }, 0);
					}
				}
			}


			function openFeedingPanel(e) {
				if (e) e.stopPropagation();
				const panel = document.getElementById('feedingPanel');

				// ë³´ì´ê²Œ ë§Œë“¤ê³  ìŠ¬ë¼ì´ë“œ ì‹œì‘
				panel.classList.remove('invisible', 'pointer-events-none');
				panel.getBoundingClientRect();                 // reflow
				panel.classList.remove('translate-x-full');    // ìŠ¬ë¼ì´ë“œ

				let fired = false;
				const afterOpen = async () => {
					if (fired) return; fired = true;

					// íŒ¨ë„ì´ í¼ì³ì ¸ ë¶€ëª¨ width/heightê°€ ìƒê¸¸ ë•Œê¹Œì§€ ëŒ€ê¸°
					await waitForCanvasReady('weightChart');
					await waitForCanvasReady('waterChart');

					// ë‚ ì§œ ê¸°ë³¸ê°’ + ë°ì´í„° ë¡œë“œ
					if (dateInput) {
						dateInput.value = todayStr;
						loadDataAndDraw(todayStr);
						loadLitterEvents(todayStr);
						loadLitterSummary(todayStr);

						if (!dateInput.__bound) {
							dateInput.addEventListener('change', () => {
								disconnectWebSocket();
								loadDataAndDraw(dateInput.value);
								loadLitterEvents(dateInput.value);
								loadLitterSummary(dateInput.value);
							});
							dateInput.__bound = true;
						}
					}

					// í˜¹ì‹œ ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ì´ì¦ˆ ì¬ê³„ì‚°
					setTimeout(() => {
						try { weightChart && weightChart.resize(); } catch {}
						try { waterChart && waterChart.resize(); } catch {}
					}, 0);
				};

				panel.addEventListener('transitionend', afterOpen, { once: true });
				setTimeout(afterOpen, 500); // transition ì´ë²¤íŠ¸ ëˆ„ë½ ëŒ€ë¹„
			}




			// ì°½ í¬ê¸° ë°”ë€Œë©´ ë‹¤ì‹œ ë§ì¶”ê¸°
			window.addEventListener('resize', () => {
				try { weightChart && weightChart.resize(); } catch {}
				try { waterChart && waterChart.resize(); } catch {}
			});

			function connectWebSocket() {
				const socket = new SockJS('/ws');
				stompClient = Stomp.over(socket);
				stompClient.connect({}, () => {
					console.log('ğŸ”Œ WebSocket ì—°ê²°ë¨');
					subscription = stompClient.subscribe(`/topic/health/${petId}`, (message) => {
						const newLog = JSON.parse(message.body);
						updateChartWithNewLog(newLog);
					});
				});
			}

			function disconnectWebSocket() {
				if (subscription) subscription.unsubscribe();
				if (stompClient) stompClient.disconnect();
			}

			function updateChartWithNewLog(newLog) {
				const timeLabel = new Date(newLog.logDate).toTimeString().slice(0, 5);
				rawData.push(newLog);

				if (newLog.foodWeight !== null) {
					const foodValue = parseFloat(newLog.foodWeight).toFixed(2);
					labels.push(timeLabel);
					deltas.push(foodValue);
					bgColors.push('rgba(255, 193, 7, 0.4)');
					tooltipLabels.push(`ì‚¬ë£Œ ë‚¨ì€ ì–‘: ${foodValue}g`);
					weightChart.options.scales.x.display = true;
					weightChart.update();
				}

				if (newLog.waterWeight !== null) {
					const waterValue = parseFloat(newLog.waterWeight).toFixed(2);
					waterLabels.push(timeLabel);
					waterDeltas.push(waterValue);
					waterBgColors.push('rgba(30, 144, 255, 0.4)');
					waterTooltipLabels.push(`ë¬¼ ë‚¨ì€ ì–‘: ${waterValue}g`);
					waterChart.options.scales.x.display = true;
					waterChart.update();
				}
			}

			function sizeCanvasAndGetCtx(id) {
				const c = document.getElementById(id);
				if (!c) throw new Error(`#${id} ìº”ë²„ìŠ¤ ì—†ìŒ`);

				// ìº”ë²„ìŠ¤ëŠ” blockìœ¼ë¡œ
				c.style.display = 'block';

				const parent = c.parentElement;
				if (!parent) throw new Error(`#${id} ë¶€ëª¨ ì—†ìŒ`);

				// ë¶€ëª¨ê°€ translateë¡œ í™”ë©´ ë°–ì´ê±°ë‚˜ ì•„ì§ ë ˆì´ì•„ì›ƒ 0ì¼ ìˆ˜ ìˆìŒ â†’ ì•ˆì „í•œ ìµœì†Œê°’
				const box = parent.getBoundingClientRect();
				const safeW = Math.max(240, Math.floor(box.width  || 0));
				const safeH = Math.max(160, Math.floor(box.height || 0));

				// ì†ì„±(width/height)ë¡œ ì§€ì •í•´ì•¼ Chart.jsê°€ ì •í™•íˆ ê·¸ë¦¼
				c.width  = safeW;
				c.height = safeH;

				const ctx = c.getContext('2d');
				if (!ctx) throw new Error(`#${id} 2D ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ`);
				return ctx;
			}


			function loadDataAndDraw(dateStr) {
				if (!dateStr) dateStr = todayStr;

				// ìºì‹œ ë°©ì§€ ì¿¼ë¦¬(_=timestamp) + no-store
				const url = `/usr/pet/health/logs?petId=${petId}&date=${dateStr}&_=${Date.now()}`;
				console.log('[LOAD]', dateStr, url);

				fetch(url, { cache: 'no-store', headers: { 'Accept': 'application/json' } })
						.then(res => {
							if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${res.status}`);
							return res.json();
						})
						.then(data => {
							// ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ë©´ ì‹¤ì‹œê°„, ì•„ë‹ˆë©´ ëŠê¸°
							if (dateStr === todayStr) connectWebSocket();
							else disconnectWebSocket();

							// í•­ìƒ â€œíŒŒê´´ í›„ ì¬ìƒì„±â€ ì „ëµì„ ì“°ë„ë¡ renderChartê°€ destroy â†’ create í•˜ê²Œ êµ¬í˜„ë˜ì–´ ìˆìŒ
							renderFeedingCharts(data)
						})
						.catch(err => {
							console.error("ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
							renderFeedingCharts([]) // ë¹„ì–´ë„ ì¶•/í”„ë ˆì„ì€ ë³´ì´ê²Œ
						});
			}

		</script>

		<script>

			async function waitForCanvasReady(id, tries = 40){
				// 40íšŒ Ã— 25ms â‰ˆ 1ì´ˆ ëŒ€ê¸°
				for (let i = 0; i < tries; i++) {
					const c = document.getElementById(id);
					const p = c?.parentElement;
					if (c && p) {
						const r = p.getBoundingClientRect();
						// translate-x-full ì´ë©´ widthê°€ 0ì— ê°€ê¹ìŠµë‹ˆë‹¤
						if (r.width > 20 && r.height > 20) return true;
					}
					await new Promise(r => setTimeout(r, 25));
				}
				return false;
			}


			function showEmptyState(canvasId, text){
				const c = document.getElementById(canvasId);
				if(!c) return;
				const parent = c.parentElement;
				if(!parent) return;

				// ì˜¤ë²„ë ˆì´ ê¸°ì¤€ì 
				const cs = getComputedStyle(parent);
				if (cs.position === 'static') parent.style.position = 'relative';

				// ê¸°ì¡´ íŒíŠ¸ ì œê±°
				parent.querySelector('[data-empty-hint="1"]')?.remove();

				const hint = document.createElement('div');
				hint.setAttribute('data-empty-hint', '1');
				hint.style.position = 'absolute';
				hint.style.inset = '0';
				hint.style.display = 'flex';
				hint.style.alignItems = 'center';
				hint.style.justifyContent = 'center';
				hint.style.fontSize = '14px';
				hint.style.color = '#6b7280';
				hint.style.pointerEvents = 'none'; // ì°¨íŠ¸ ë™ì‘ ë°©í•´ X
				hint.textContent = text || 'ë°ì´í„° ì—†ìŒ';
				parent.appendChild(hint);
			}
			function clearEmptyState(canvasId){
				const parent = document.getElementById(canvasId)?.parentElement;
				parent?.querySelector('[data-empty-hint="1"]')?.remove();
			}



			async function debugFeedingPanel() {
				const foodC  = document.getElementById('weightChart');
				const waterC = document.getElementById('waterChart');

				// 1) DOM/ì‚¬ì´ì¦ˆ í™•ì¸ + ê°•ì œ ì„¸íŒ…
				function forceSize(c) {
					if (!c) return;
					const box = c.parentElement.getBoundingClientRect();
					c.width  = Math.max(120, Math.floor(box.width  || 0));
					c.height = Math.max(160, Math.floor(box.height || 0));
				}
				forceSize(foodC);
				forceSize(waterC);

				console.log('[DEBUG] feeding panel canvases:',
						{ foodW: foodC?.width, foodH: foodC?.height, waterW: waterC?.width, waterH: waterC?.height });

				// 2) API ì‹¤ì œ ì‘ë‹µ í™•ì¸
				try {
					const r = await fetch(`/usr/pet/health/logs?petId=${petId}&date=${dateInput?.value || todayStr}`, {
						cache: 'no-store', headers: { 'Accept': 'application/json' }
					});
					console.log('[DEBUG] fetch status:', r.status);
					const js = await r.json();
					console.log('[DEBUG] api json length:', Array.isArray(js) ? js.length : 'N/A');

					if (Array.isArray(js) && js.length) {
						renderFeedingCharts(js);              // âœ… ì‹¤ì œ ë°ì´í„°ë¡œ ë°”ë¡œ ë Œë”
					} else {
						// âœ… ë°ì´í„° ì—†ìŒ â†’ ì°¨íŠ¸ íŒŒê´´ + íŒíŠ¸
						try { weightChart && weightChart.destroy(); } catch {}
						try { waterChart  && waterChart.destroy(); } catch {}
						weightChart = null; waterChart = null;
						showEmptyState('weightChart', 'ì‚¬ë£Œ ë°ì´í„°ê°€ ì—†ì–´ìš”');
						showEmptyState('waterChart',  'ë¬¼ ë°ì´í„°ê°€ ì—†ì–´ìš”');
					}
				} catch (e) {
					console.error('[DEBUG] fetch/json error:', e);
					try { weightChart && weightChart.destroy(); } catch {}
					try { waterChart  && waterChart.destroy(); } catch {}
					weightChart = null; waterChart = null;
					showEmptyState('weightChart', 'ë°ì´í„° ì‘ë‹µ ì˜¤ë¥˜');
					showEmptyState('waterChart',  'ë°ì´í„° ì‘ë‹µ ì˜¤ë¥˜');
				}
			}

		</script>


		<script>
			// íŒ¨ë„ ì—´ê¸°: ì™„ì „íˆ ì—´ë¦° ë’¤ load + ë Œë”
			function openFeedingPanel(e) {
				// URLì— ?debugCharts=1 ìˆì„ ë•Œë§Œ ë””ë²„ê·¸ í˜¸ì¶œ
				if (new URLSearchParams(location.search).get('debugCharts') === '1') {
					setTimeout(debugFeedingPanel, 0);
				}

				if (e) e.stopPropagation();
				const panel = document.getElementById('feedingPanel');

				// ì²˜ìŒì—” í´ë¦­ ë§‰ê³  ìˆ¨ê¹€ ìƒíƒœ í•´ì œ
				panel.classList.remove('invisible', 'pointer-events-none');
				panel.getBoundingClientRect();                 // reflow
				panel.classList.remove('translate-x-full');    // ìŠ¬ë¼ì´ë“œ ì‹œì‘

				let fired = false;
				const afterOpen = () => {
					if (fired) return; fired = true;

					// ë‚ ì§œ ê¸°ë³¸ê°’ + ë°ì´í„° ë¡œë“œ
					if (dateInput) {
						dateInput.value = todayStr;
						loadDataAndDraw(todayStr);
						loadLitterEvents(todayStr);
						loadLitterSummary(todayStr);

						if (!dateInput.__bound) {
							dateInput.addEventListener('change', () => {
								disconnectWebSocket();
								loadDataAndDraw(dateInput.value);
								loadLitterEvents(dateInput.value);
								loadLitterSummary(dateInput.value);
							});
							dateInput.__bound = true;
						}
					}

					// í˜¹ì‹œ ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ì´ì¦ˆ ì¬ê³„ì‚°
					setTimeout(() => {
						try { weightChart && weightChart.resize(); } catch {}
						try { waterChart && waterChart.resize(); } catch {}
					}, 0);
				};

				panel.addEventListener('transitionend', afterOpen, { once: true });
				setTimeout(afterOpen, 400); // transition ì´ë²¤íŠ¸ ëˆ„ë½ ëŒ€ë¹„ í´ë°±
			}

			// íŒ¨ë„ ë‹«ê¸° ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ë„ OK (ì›í•˜ë©´ invisible/pointer-events-none ì¶”ê°€)
			function closeFeedingPanel() {
				const panel = document.getElementById('feedingPanel');
				panel.classList.add('translate-x-full');
				const onEnd = () => {
					panel.removeEventListener('transitionend', onEnd);
					panel.classList.add('invisible', 'pointer-events-none');
					disconnectWebSocket();
					if (window.__reloadActivityTimeline) window.__reloadActivityTimeline();
				};
				panel.addEventListener('transitionend', onEnd, { once: true });
			}

		</script>

		<script th:inline="javascript">
			/*<![CDATA[*/
			var events = [[${eventsJson}]];
			/*]]>*/
		</script>


		<script>
			var urlParams = new URLSearchParams(window.location.search);
			var petId = urlParams.get("petId");
		</script>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				fetch('/usr/pet/vaccination/events?petId=' + petId)
					.then(res => res.json())
					.then(freshEvents => {
						renderMiniCalendar('calendar-container', freshEvents, new Date());
					});
			});

		</script>

		<script>
			function openVaccineModal(petId, dateStr) {
				document.getElementById('injectionDateInput').value = dateStr;

				// ğŸ‘‰ ì—¬ê¸°ê°€ ì¤‘ìš”!
				const petInput = document.querySelector('#vaccineForm input[name="petId"]');
				if (petInput) {
					petInput.value = petId;
				}

				document.getElementById('vaccineModal').classList.remove('hidden');
			}

			function closeVaccineModal() {
				document.getElementById('vaccineModal').classList.add('hidden');
			}

			function openVaccineDetailModal(data) {
				document.getElementById('vaccineDetailModal').classList.remove('hidden');

				document.getElementById('detailName').textContent = data.title;
				document.getElementById('detailDate').textContent = data.start;
				document.getElementById('detailNotes').textContent = data.notes || 'ì—†ìŒ';

				// ìˆ˜ì •ìš© hidden ê°’ ì„¸íŒ…
				const form = document.getElementById('vaccineEditForm');
				form.vaccinationId.value = data.id;
				form.vaccineName.value = data.title.replace(' ì ‘ì¢…', '');
				form.injectionDate.value = data.start;
				form.notes.value = data.notes || '';

				// ğŸ”½ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
				const editBtn = document.getElementById('editBtn');
				const deleteBtn = document.getElementById('deleteBtn');

				if (data.title.includes("ì˜ˆì •")) {
					editBtn.classList.add('hidden');
					deleteBtn.classList.add('hidden');
				} else {
					editBtn.classList.remove('hidden');
					deleteBtn.classList.remove('hidden');
				}
			}


			function closeVaccineDetailModal() {
				document.getElementById('vaccineDetailModal').classList.add('hidden');
				cancelEdit();
			}

			function enterEditMode() {
				document.getElementById('vaccineDetailView').classList.add('hidden');
				document.getElementById('vaccineEditForm').classList.remove('hidden');
			}

			function cancelEdit() {
				document.getElementById('vaccineEditForm').classList.add('hidden');
				document.getElementById('vaccineDetailView').classList.remove('hidden');
			}

			document.getElementById('vaccineEditForm').addEventListener('submit', function (e) {
				e.preventDefault();

				const formData = new FormData(this);

				fetch('/usr/pet/vaccination/doModify', {
					method: 'POST',
					body: formData
				})
					.then(res => res.json())
					.then(result => {
						if (result.success) {
							closeVaccineDetailModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar(); // âœ… ë‹¬ë ¥ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
						} else {
							alert(result.msg);
						}
					});
			});

			function deleteVaccination() {
				const id = document.querySelector('#vaccineEditForm input[name="vaccinationId"]').value;
				if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

				fetch('/usr/pet/vaccination/delete?vaccinationId=' + id)
					.then(res => res.json())
					.then(result => {
						if (result.resultCode?.startsWith('S-')) {
							closeVaccineDetailModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar();         // ë‹¬ë ¥ ìƒˆë¡œ ê·¸ë¦¬ê¸°
						} else {
							alert("âš ï¸ ì‚­ì œ ì‹¤íŒ¨: " + (result.msg || ''));
						}
					})
					.catch(err => {
						console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
						alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
					});

			}

			function refreshCalendar() {
				fetch('/usr/pet/vaccination/events?petId=' + petId)
					.then(res => res.json())
					.then(freshEvents => {
						renderMiniCalendar('calendar-container', freshEvents); // ìµœì‹  ë°ì´í„°ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
					});
			}

			function openEventListModal(events) {
				const modal = document.getElementById('multiEventModal');
				const container = modal.querySelector('.event-list');
				container.innerHTML = '';

				events.forEach(e => {
					const btn = document.createElement('button');
					btn.textContent = `${e.title} (${e.start})`;
					btn.className = 'block w-full text-left px-4 py-2 hover:bg-yellow-100';
					btn.onclick = () => {
						modal.classList.add('hidden');
						openVaccineDetailModal(e);
					};
					container.appendChild(btn);
				});

				modal.classList.remove('hidden');
			}
		</script>

		<script>
			document.getElementById("vaccineForm").addEventListener("submit", function (e) {
				e.preventDefault();

				const form = e.target;
				const formData = new FormData(form);

				// FormDataì— ì‹¤ì œ ë°ì´í„° ì°ì–´ë³´ê¸° (ë””ë²„ê¹…ìš©)
				console.log("ğŸ” ì „ì†¡ ë°ì´í„°:");
				for (const [key, value] of formData.entries()) {
					console.log(`${key}: ${value}`);
				}

				fetch("/usr/pet/vaccination/doRegistration", {
					method: "POST",
					body: formData
				})
					.then(res => {
						if (!res.ok) throw new Error(`HTTP ${res.status}`);
						return res.json();
					})
					.then(data => {
						console.log("âœ… ì‘ë‹µ:", data);

						if (data.resultCode?.startsWith("S-")) {
							form.reset();
							closeVaccineModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar(); // âœ… ë‹¬ë ¥ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
							// âœ… í•„ìš”ì‹œ ë‹¬ë ¥ ë¦¬ë Œë” ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
						} else {
							alert("âš ï¸ ë“±ë¡ ì‹¤íŒ¨: " + (data.msg || ""));
						}
					})
					.catch(err => {
						console.error("âŒ ì˜¤ë¥˜:", err);
						alert("âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
					});
			});

			function updateVaccinationList(year, month) {
				var monthStr = (month + 1 < 10 ? '0' : '') + (month + 1);
				var target = document.getElementById('monthly-vaccine-list');
				target.innerHTML = ''; // ì´ˆê¸°í™”

				var yearMonth = year + '-' + monthStr;

				fetch('/usr/pet/vaccination/monthly?petId=' + petId + '&yearMonth=' + yearMonth)
					.then(function (res) {
						return res.json();
					})
					.then(function (data) {
						if (data.length === 0) {
							target.innerHTML = '<div class="text-gray-500">ë“±ë¡ëœ ì ‘ì¢… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
							return;
						}

						data.forEach(function (item) {
							var div = document.createElement('div');
							div.className = 'bg-white p-2 rounded shadow border-l-4 border-yellow-400 text-sm';
							div.innerHTML =
								'ğŸ’‰ <b>' + item.vaccineName + '</b> (' + item.injectionDate + ')<br>' +
								'<span class="text-xs text-gray-500">ë‹¤ìŒ ì ‘ì¢…: ' + (item.nextDueDate || 'ë¯¸ì •') + '</span>';
							div.onclick = function () {
								openVaccineDetailModal({
									id: item.id,
									title: item.vaccineName + ' ì ‘ì¢…',
									start: item.injectionDate,
									notes: item.notes
								});
							};
							target.appendChild(div);
						});
					});
			}

			function openTodayVaccineModal() {
				const today = new Date();

				const year = today.getFullYear();
				const month = today.getMonth() + 1;
				const day = today.getDate();

				const monthStr = month < 10 ? '0' + month : '' + month;
				const dayStr = day < 10 ? '0' + day : '' + day;

				const dateStr = `${year}-${monthStr}-${dayStr}`;

				openVaccineModal(petId, dateStr); // ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
			}


		</script>

		<script>
			let selectedSpecies = null;  // ê°•ì•„ì§€/ê³ ì–‘ì´ ì„ íƒ
			let uploadedFile = null;     // ì—…ë¡œë“œëœ íŒŒì¼
			let emotionChart = null;     // Chart.js ì¸ìŠ¤í„´ìŠ¤

			// ì¢… ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
			function selectSpecies(species) {
				selectedSpecies = species;

				document.querySelectorAll('.species-btn').forEach(btn => {
					btn.classList.remove('bg-yellow-300', 'text-white');
				});

				const selectedBtn = Array.from(document.querySelectorAll('.species-btn'))
					.find(btn => btn.textContent.includes(species));

				if (selectedBtn) {
					selectedBtn.classList.add('bg-yellow-300', 'text-white');
				}
			}

			// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸°
			function previewImage(event) {
				console.log("âœ… previewImage í˜¸ì¶œë¨");

				const file = event.target.files[0];
				if (!file) return;

				uploadedFile = file;

				const reader = new FileReader();
				reader.onload = function (e) {
					const previewImg = document.getElementById('emotionPreview');
					previewImg.src = e.target.result;

					// âœ… ê¼­ í•„ìš”: ì´ë¯¸ì§€ê°€ ìˆ¨ê²¨ì ¸ ìˆì—ˆë‹¤ë©´ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
					previewImg.classList.remove('hidden');
				};
				reader.readAsDataURL(file);
			}



			// ê°ì • ë¶„ì„ ìš”ì²­
			function analyzeEmotion() {
				if (!selectedSpecies) {
					alert("ğŸ¾ ê°•ì•„ì§€ ë˜ëŠ” ê³ ì–‘ì´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
					return;
				}

				if (!uploadedFile) {
					alert("ğŸ“· ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
					return;
				}

				const petId = new URLSearchParams(window.location.search).get('petId'); // URLì—ì„œ petId ì¶”ì¶œ
				if (!petId) {
					alert("âŒ petIdê°€ ì—†ìŠµë‹ˆë‹¤.");
					return;
				}

				const formData = new FormData();
				formData.append("petId", petId);
				formData.append("species", selectedSpecies);
				formData.append("imageFile", uploadedFile);

				fetch("/usr/pet/analysis/do", {
					method: "POST",
					body: formData
				})
					.then(res => {
						if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
						return res.json();
					})
					.then(data => {

						// ë¶„ì„ ì´ë¯¸ì§€ í‘œì‹œ
						document.getElementById('resultImage').src = data.imagePath;

						document.querySelectorAll('.species-btn, .upload-label, .analyze-btn')
							.forEach(el => el.classList.add('hidden'));

						document.getElementById('imageContainer').classList.add('hidden');

						document.getElementById('emotionPreview').classList.add('hidden');
						document.getElementById('resultArea').classList.remove('hidden');
						document.getElementById('retryButton').classList.remove('hidden');

						// í…ìŠ¤íŠ¸ í‘œì‹œ
						const probs = data.probabilities;
						const labels = Object.keys(probs);
						const values = Object.values(probs).map(v => parseFloat((v).toFixed(2)));

						const labelMap = {
							"happy": "ğŸ˜Š í–‰ë³µ",
							"relaxed": "ğŸ˜Œ í‰ì˜¨",
							"angry": "ğŸ˜  í™”ë‚¨",
							"sad": "ğŸ˜¿ ìŠ¬í””",
							"scared": "ğŸ˜¨ ë‘ë ¤ì›€"
						};

						const maxIdx = values.indexOf(Math.max(...values));
						const displayLabel = labelMap[labels[maxIdx]] || labels[maxIdx];
						document.getElementById('resultText').textContent = `ê°€ì¥ ë†’ì€ ê°ì •: ${displayLabel} (${values[maxIdx]}%)`;

						// ì°¨íŠ¸ ê·¸ë¦¬ê¸°
						if (emotionChart) emotionChart.destroy();
						const ctx = document.getElementById('emotionChart').getContext('2d');
						emotionChart = new Chart(ctx, {
							type: 'pie',
							data: {
								labels: labels.map(l => labelMap[l] || l),
								datasets: [{
									data: values,
									backgroundColor: ['#f9c74f', '#90be6d', '#f8961e', '#43aa8b', '#577590']
								}]
							},
							options: {
								plugins: {
									legend: {position: 'bottom'},
									title: {display: true, text: 'ê°ì • ë¹„ìœ¨ ë¶„ì„'}
								}
							}
						});
					})

					.catch(err => {
						console.error("âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", err);
						alert("ë¶„ì„ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					});
			}

			function resetEmotionPanel() {
				document.querySelectorAll('.species-btn, .upload-label, .analyze-btn')
					.forEach(el => el.classList.remove('hidden'));

				document.getElementById('imageContainer').classList.remove('hidden');
				document.getElementById('resultArea').classList.add('hidden');
				document.getElementById('retryButton').classList.add('hidden');

				document.getElementById('emotionPreview').src = '';
				document.getElementById('resultText').textContent = '';

				if (emotionChart) {
					emotionChart.destroy();
					emotionChart = null;
				}

				uploadedFile = null;

				// âœ… ì™„ì „íˆ ìƒˆë¡œìš´ input ìƒì„± í›„ ë‹¤ì‹œ label ì•ˆì— ì‚½ì…
				const uploadLabel = document.querySelector('.upload-label');
				const newInput = document.createElement('input');
				newInput.type = 'file';
				newInput.accept = 'image/*';
				newInput.className = 'hidden';
				newInput.onchange = previewImage;

				// ê¸°ì¡´ input ì œê±°í•˜ê³  ìƒˆ input ì‚½ì…
				const oldInput = uploadLabel.querySelector('input[type="file"]');
				if (oldInput) oldInput.remove();
				uploadLabel.appendChild(newInput);
			}









			// ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
			function closeEmotionPanel() {
				document.getElementById("emotionPanel").classList.add("translate-x-full");
			}

			// ìŠ¬ë¼ì´ë“œ ì—´ê¸° (í•„ìš”í•œ ê²½ìš°)
			function openEmotionPanel() {
				document.getElementById("emotionPanel").classList.remove("translate-x-full");
			}
		</script>

		<script>
			const ctx = document.getElementById('myChart').getContext('2d');

			const myChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'], // ì´ˆê¸°ê°’
					datasets: [
						{
							label: 'ì‹ì‚¬ëŸ‰',
							data: [], // ì„œë²„ì—ì„œ ì±„ì›€
							backgroundColor: 'rgba(244, 211, 94, 0.8)',
							borderRadius: {topLeft: 100, bottomRight: 40},
							barPercentage: 0.6,
							borderSkipped: false,
							categoryPercentage: 0.7
						},
						{
							label: 'ë¬¼ ì„­ì·¨ëŸ‰',
							data: [],
							backgroundColor: 'rgba(127, 176, 105, 0.8)',
							borderRadius: {topLeft: 100, bottomRight: 40},
							barPercentage: 0.6,
							borderSkipped: false,
							categoryPercentage: 0.7
						},
						{
							label: 'ìµœì¢… ì ìˆ˜',
							data: [],
							backgroundColor: 'rgba(79, 109, 122, 0.8)',
							borderRadius: {topLeft: 100, bottomRight: 40},
							borderSkipped: false,
							barPercentage: 0.6,
							categoryPercentage: 0.7
						}
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: {position: 'top'},
						title: {display: false}
					},
					scales: {
						y: {
							beginAtZero: true,
							max: 20
						}
					}
				}
			});

			// âœ… ì‹¤ì œ ë°ì´í„° fetch ë° ì ìš©
			fetch(`/usr/pet/health/week-stats?petId=${petId}`)
				.then(res => res.json())
				.then(data => {
					myChart.data.labels = data.labels;
					myChart.data.datasets[0].data = data.food;
					myChart.data.datasets[1].data = data.water;
					myChart.data.datasets[2].data = data.score;
					myChart.update();

					const todayIdx = new Date().getDay();
					const yesterdayIdx = (todayIdx + 6) % 7;

					const foodDiff = (data.food[todayIdx] ?? 0) - (data.food[yesterdayIdx] ?? 0);
					const waterDiff = (data.water[todayIdx] ?? 0) - (data.water[yesterdayIdx] ?? 0);
					const scoreDiff = (data.score[todayIdx] ?? 0) - (data.score[yesterdayIdx] ?? 0);

					const diffs = [
						{
							type: 'water',
							label: 'ë¬¼ì„',
							value: waterDiff,
							unit: 'ml',
							upText: 'ë” ë§ˆì…¨ì–´ìš”',
							downText: 'ëœ ë§ˆì…¨ì–´ìš”'
						},
						{
							type: 'food',
							label: 'ì‚¬ë£Œë¥¼',
							value: foodDiff,
							unit: 'g',
							upText: 'ë” ë¨¹ì—ˆì–´ìš”',
							downText: 'ëœ ë¨¹ì—ˆì–´ìš”'
						},
						{
							type: 'score',
							label: 'ì ìˆ˜ê°€',
							value: scoreDiff,
							unit: 'ì ',
							upText: 'ì˜¬ëì–´ìš”',
							downText: 'ë‚´ë ¤ê°”ì–´ìš”'
						}
					];

					const maxDiff = diffs.reduce((prev, curr) => {
						return Math.abs(curr.value) > Math.abs(prev.value) ? curr : prev;
					});

					let summary = '';
					if (maxDiff.value === 0) {
						summary = `ì˜¤ëŠ˜ì€ ${maxDiff.label} ì–´ì œì™€ ê°™ì•„ìš”!`;
					} else {
						const amount = Math.abs(maxDiff.value).toFixed(1);
						const direction = maxDiff.value > 0 ? maxDiff.upText : maxDiff.downText;
						summary = `ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤ ${maxDiff.label} ${amount}${maxDiff.unit} ${direction}`;
					}


					document.getElementById("summaryCardMain").innerHTML = `
					${summary}<br>
					<button class="text-blue-600 mt-6 underline flex mx-auto"
					        onclick="event.stopPropagation(); openFeedingPanel(event)">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"
							                  className="w-6 h-6 text-gray-700 hover:text-yellow-400 transition-colors">
							                <path
							                        d="M19,10.5H10.207l2.439-2.439a1.5,1.5,0,0,0-2.121-2.122L6.939,9.525a3.505,3.505,0,0,0,0,4.95l3.586,3.586a1.5,1.5,0,0,0,2.121-2.122L10.207,13.5H19a1.5,1.5,0,0,0,0-3Z"/>
							             </svg><p>ìƒì„¸ë³´ê¸°</p>
					</button>

				`;
				})
				.catch(err => {
					console.error("ğŸš¨ ìš”ì•½ ë°ì´í„° ì‹¤íŒ¨:", err);
				});



		</script>


		<script th:inline="javascript">
			// DOM ì°¸ì¡°
			const legendEl = document.getElementById('activityLegend');
			const timeGrid = document.getElementById('activityTimeGrid');
			const chartArea = document.getElementById('activityChartArea');
			const noDataEl = document.getElementById('activityNoData');

			// ìƒ‰ìƒ/ìƒìˆ˜
			const COLORS = {"ê±°ì‹¤": "#fff8b5", "ì¹¨ì‹¤": "#d3f8e2", "ê¸°íƒ€": "#e0eafc"};
			const PX_PER_HOUR = 80;
			const MIN_BAR_PX = 4;

			// í¬ë§·í„°
			const pad2 = n => String(n).padStart(2, '0');
			const fmtTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
			const fmtDuration = sec => {
				sec = Math.max(0, sec | 0);
				const m = Math.floor(sec / 60), s = sec % 60;
				return `${m}ë¶„ ${s}ì´ˆ ë¨¸ë¬¾`;
			};

			// ì‹œê°„ ëˆˆê¸ˆ
			function renderTimeGrid() {
				timeGrid.innerHTML = '';
				for (let h = 0; h <= 24; h++) {
					const label = document.createElement('div');
					label.className = 'absolute text-xs text-gray-600 -translate-x-1/2';
					label.style.left = `${h * PX_PER_HOUR}px`;
					label.textContent = `${pad2(h)}:00`;
					timeGrid.appendChild(label);
				}
			}

			// ë²”ë¡€
			function renderLegend(zones) {
				legendEl.innerHTML = '';
				const ORDER = ['ê±°ì‹¤', 'ì¹¨ì‹¤', 'ê¸°íƒ€'];
				const sorted = ORDER.filter(z => zones.includes(z)).concat(zones.filter(z => !ORDER.includes(z)));
				sorted.forEach(z => {
					const item = document.createElement('div');
					item.className = 'flex items-center gap-2';
					const swatch = document.createElement('span');
					swatch.className = 'inline-block w-8 h-3 rounded';
					swatch.style.backgroundColor = COLORS[z] || COLORS['ê¸°íƒ€'];
					const label = document.createElement('span');
					label.textContent = z;
					item.appendChild(swatch);
					item.appendChild(label);
					legendEl.appendChild(item);
				});
			}

			// ì»¤ìŠ¤í…€ íˆ´íŒ
			const tooltipEl = (() => {
				const el = document.createElement('div');
				el.id = 'activityTooltip';
				el.className = 'hidden fixed z-50 bg-gray-900/95 text-white text-xs px-2.5 py-2 rounded-lg shadow-lg pointer-events-none';
				document.body.appendChild(el);
				return el;
			})();
			function showTip(evt, html) {
				tooltipEl.innerHTML = html;
				tooltipEl.classList.remove('hidden');
				const offset = 14;
				tooltipEl.style.left = `${evt.clientX + offset}px`;
				tooltipEl.style.top = `${evt.clientY - offset}px`;
			}
			function hideTip() {tooltipEl.classList.add('hidden');}

			// ì°¨íŠ¸ ë Œë” (ì¡´ë³„ 1ì¤„)
			function renderChart(list) {
				chartArea.innerHTML = '';
				const wrapper = document.getElementById('activityChartWrapper'); // âœ… ì¶”ê°€

				if (!Array.isArray(list) || list.length === 0) {
					noDataEl?.classList.remove('hidden');
					wrapper?.classList.add('hidden');      // âœ… ê·¸ë¦¬ë“œ/ëˆˆê¸ˆ ìˆ¨ê¹€
					renderLegend([]);
					return;
				}
				noDataEl?.classList.add('hidden');
				wrapper?.classList.remove('hidden');

				list.sort((a, b) => new Date(a.enteredAt) - new Date(b.enteredAt));
				const SOD = new Date(); SOD.setHours(0,0,0,0);

				const ORDER = ['ê±°ì‹¤', 'ì¹¨ì‹¤', 'ê¸°íƒ€'];
				const zones = Array.from(new Set(list.map(x => x.zoneName)))
					.sort((a, b) => {
						const ai = ORDER.indexOf(a), bi = ORDER.indexOf(b);
						return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
					});

				renderLegend(zones);

				zones.forEach(() => {
					const row = document.createElement('div');
					row.className = 'relative h-[44px] bg-white';
					chartArea.appendChild(row);
				});

				list.forEach(it => {
					const zIdx = zones.indexOf(it.zoneName);
					if (zIdx < 0) return;
					const rowEl = chartArea.children[zIdx];

					const entered = new Date(it.enteredAt);
					const exited = new Date(it.exitedAt);
					const durSec = Math.max(0, (exited - entered) / 1000);
					const offSec = Math.max(0, (entered - SOD) / 1000);

					const leftPx = (offSec / 3600) * PX_PER_HOUR;
					const widthPx = Math.max((durSec / 3600) * PX_PER_HOUR, MIN_BAR_PX);

					const bar = document.createElement('div');
					bar.className = 'absolute h-[26px] rounded-[16px] z-10';
					bar.style.top = '9px';
					bar.style.left = `${leftPx}px`;
					bar.style.width = `${widthPx}px`;
					bar.style.backgroundColor = COLORS[it.zoneName] || COLORS['ê¸°íƒ€'];

					const tipHtml = `
		        <div class="font-medium">${it.zoneName}</div>
		        <div class="opacity-80">${fmtTime(entered)} ~ ${fmtTime(exited)}</div>
		        <div class="opacity-80">${fmtDuration(durSec)}</div>
		      `;
					bar.addEventListener('mouseenter', (e) => showTip(e, tipHtml));
					bar.addEventListener('mousemove', (e) => showTip(e, tipHtml));
					bar.addEventListener('mouseleave', hideTip);

					rowEl.appendChild(bar);
				});
			}

			// ì„œë²„ í˜¸ì¶œ
			// ìµœì†Œ ë¨¸ë¬¸ ì‹œê°„(ì´ˆ) â€” í•„ìš”í•˜ë©´ 60, 120 ë“±ìœ¼ë¡œ ì¡°ì ˆ
			const MIN_DUR_SEC = 30;

			function normalizeRow(x) {
				const s = new Date(x.enteredAt);
				let e = x.exitedAt ? new Date(x.exitedAt) : null;

				if (!e || e < s) {
					if (x.durationSec && !Number.isNaN(+x.durationSec)) {
						e = new Date(s.getTime() + (+x.durationSec) * 1000);
					} else {
						e = new Date(s.getTime() + 60 * 1000); // ìµœì†Œ 1ë¶„ì§œë¦¬ë¡œ ê°€ë“œ
					}
				}
				return { ...x, _in: s, _out: e };
			}

			function startOfDayLocal(d){
				const x = new Date(d);
				x.setHours(0,0,0,0);
				return x;
			}
			function endOfDayLocal(d){
				const x = new Date(d);
				x.setHours(23,59,59,999);
				return x;
			}

			async function loadActivities() {
				try {
					const pid = window.petId ?? (Number(localStorage.getItem('selectedPetId')) || null);
					const url = `/usr/petJ/activity${pid ? `?petId=${pid}` : ''}`;
					const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
					if (!res.ok) throw new Error(`HTTP ${res.status}`);
					const json = await res.json();

					// ì˜¤ëŠ˜ 0~24ì‹œ
					const SOD = new Date(); SOD.setHours(0,0,0,0);
					const EOD = new Date(); EOD.setHours(23,59,59,999);

					let list = [];
					if (Array.isArray(json?.data1)) list = json.data1;
					else if (typeof json?.data2 === 'string' && json.data2.trim()) {
						try { list = JSON.parse(json.data2); } catch {}
					}

					list = (list || [])
							.filter(x => x?.zoneName && x?.enteredAt)       // ìµœì†Œ í•„ë“œ
							.map(normalizeRow)                               // ì¢…ë£Œì‹œê° ë³´ì •
							.filter(x => x._out > SOD && x._in < EOD)        // âœ… ì˜¤ëŠ˜ê³¼ 'ê²¹ì¹˜ë©´' í†µê³¼
							// ì˜¤ëŠ˜ ë²”ìœ„ë¡œ í´ë¨í”„
							.map(x => {
								const cin  = x._in  < SOD ? new Date(SOD) : x._in;
								const cout = x._out > EOD ? new Date(EOD) : x._out;
								return { ...x, enteredAt: cin.toISOString(), exitedAt: cout.toISOString() };
							})
							// ìµœì†Œ ì§€ì†ì‹œê°„(ë³´ì • í›„ ê¸°ì¤€)
							.filter(x => (new Date(x.exitedAt) - new Date(x.enteredAt)) / 1000 >= MIN_DUR_SEC);

					renderChart(list);
				} catch (e) {
					console.error('[loadActivities] error:', e);
					renderChart([]);
				}
			}


			(function initActivityTimeline() {
				const run = () => {
					renderTimeGrid();
					loadActivities();
					// íŒ¨ë„ ë‹«ì„ ë•Œ ìƒˆë¡œê³ ì¹¨ìš©
					window.__reloadActivityTimeline = loadActivities;
				};
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', run);
				} else {
					run();
				}
			})();

		</script>

		<script>
			// í•œê¸€ ë¼ë²¨ ë§¤í•‘
			const TYPE_LABEL = { pee: 'ì†Œë³€', poop: 'ëŒ€ë³€', unknown: 'ë¯¸í™•ì¸' };

			function fmtTimeHHMM(iso) {
				const d = new Date(iso);
				return d.toTimeString().slice(0,5);
			}

			async function loadLitterEvents(dateStr) {
				const tbody = document.getElementById('poopTableBody');
				tbody.innerHTML = '<tr><td class="p-2 border text-gray-500" colspan="2">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

				try {
					const url = `/api/litter/events?petId=${petId}&date=${dateStr}&_=${Date.now()}`;
					const res = await fetch(url, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
					if (!res.ok) throw new Error(`HTTP ${res.status}`);
					const list = await res.json();

					if (!Array.isArray(list) || list.length === 0) {
						tbody.innerHTML = '<tr><td class="p-2 border text-gray-500 text-center" colspan="2">ê¸°ë¡ ì—†ìŒ</td></tr>';
						return;
					}

					// ë Œë”ë§
					tbody.innerHTML = list.map(ev => {
						const t = TYPE_LABEL[ev.type] ?? ev.type;
						return `
          <tr>
            <td class="p-2 border">${fmtTimeHHMM(ev.detectedAt)}</td>
            <td class="p-2 border">${t}</td>
          </tr>
        `;
					}).join('');
				} catch (e) {
					console.error('[loadLitterEvents] error:', e);
					tbody.innerHTML = '<tr><td class="p-2 border text-red-500 text-center" colspan="2">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>';
				}
			}

			async function loadLitterSummary(dateStr) {
				try {
					const url = `/api/litter/summary?petId=${petId}&date=${dateStr}&_=${Date.now()}`;
					const res = await fetch(url, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
					if (!res.ok) throw new Error(`HTTP ${res.status}`);
					const sum = await res.json();
					// í•„ìš”í•˜ë‹¤ë©´ ì–´ë””ì—ë“  í‘œì‹œí•˜ì„¸ìš”. ì˜ˆ) ì½˜ì†”/ë°°ì§€ ë“±
					console.log('ğŸš½ ìš”ì•½:', sum); // {date, pee, poop, unknown, total}
				} catch (e) {
					console.error('[loadLitterSummary] error:', e);
				}
			}
		</script>







		<script th:src="@{/resource/js/calendar.js}"></script>



</body>

</html>