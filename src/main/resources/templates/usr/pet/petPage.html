<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Aniwell Dashboard</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" th:href="@{/resource/css/petPage.css}">
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<script th:src="@{/resource/js/calendar.js}"></script>


</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] font-sans">
	<div class="flex h-screen">
		<!-- Sidebar -->
		<div th:replace="common :: siteHeader"></div>

		<!-- Main content -->
		<main class="main_page min-h-screen flex-1 p-6 grid grid-cols-12 gap-4">

			<!-- ì™¼ìª½ 8ì¹¸: ì°¨íŠ¸ + ê°ì •ë¶„ì„ + ìº˜ë¦°ë” -->
			<section class="col-span-8 flex flex-col gap-4 h-full">

				<!-- ì°¨íŠ¸ -->
				<div class="bg-white p-4 rounded-xl shadow h-60">
					<canvas id="myChart" class="w-full h-full"></canvas>
				</div>

				<!-- ê°ì •ë¶„ì„ ì¹´ë“œ -->
				<div class="grid grid-cols-2 gap-4 h-3/5">
					<!-- ë¶„ì„ ë²„íŠ¼ -->
					<div class="bg-[#e0eadf] rounded-xl p-4 text-center font-semibold cursor-pointer"
						 onclick="openEmotionPanel()">
						ìš°ë¦¬ì•„ì´ ê°ì •ë¶„ì„í•˜ê¸°
					</div>

					<!-- ìŠ¬ë¼ì´ë“œ ê°ì • ë¶„ì„ íŒ¨ë„ -->
					<div id="emotionPanel"
						 class="fixed top-0 right-0 w-[92%] h-full bg-[white] shadow-xl z-50 transform translate-x-full transition-transform duration-300 rounded-l-[40px] flex flex-col p-6">

						<!-- ë‹«ê¸° ë²„íŠ¼ -->
						<button onclick="closeEmotionPanel()"
								class="absolute top-4 left-4 text-3xl text-gray-500 hover:text-black font-bold">Ã—</button>

						<!-- ì œëª© -->
						<h2 class="text-xl font-bold text-gray-700 text-center mb-4 mt-10">ê°ì • ë¶„ì„í•˜ê¸°</h2>

						<button id="retryButton"
								onclick="resetEmotionPanel()"
								class="hidden mt-6 mx-auto px-6 py-2 rounded-full bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition">
							ğŸ” ë‹¤ì‹œ ë¶„ì„í•˜ê¸°
						</button>

						<!-- ğŸ¶ ë™ë¬¼ ì¢… ì„ íƒ -->
						<div class="flex justify-center gap-4 mb-4">
							<button onclick="selectSpecies('ê°•ì•„ì§€')"
									class="species-btn px-4 py-2 rounded-full border border-yellow-400 text-yellow-600 font-semibold bg-white hover:bg-yellow-100">ğŸ¶ ê°•ì•„ì§€</button>
							<button onclick="selectSpecies('ê³ ì–‘ì´')"
									class="species-btn px-4 py-2 rounded-full border border-yellow-400 text-yellow-600 font-semibold bg-white hover:bg-yellow-100">ğŸ± ê³ ì–‘ì´</button>
						</div>

						<!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
						<div id="imageContainer" class="w-[100%] h-[80%] mx-auto rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center">
							<img id="emotionPreview" class="w-full h-full object-cover">
						</div>

						<!-- íŒŒì¼ ì—…ë¡œë“œ -->
						<label class="upload-label mt-4 mx-auto text-sm text-gray-600 cursor-pointer hover:text-black">
							â¬†ï¸ ì‚¬ì§„ ì—…ë¡œë“œ
							<input type="file" accept="image/*" onchange="previewImage(event)" class="hidden">
						</label>

						<!-- ê°ì • ë¶„ì„ ë²„íŠ¼ -->
						<button
								class="analyze-btn mt-6 mx-auto px-6 py-2 rounded-full bg-yellow-300 text-white font-semibold hover:bg-yellow-400 transition"
								onclick="analyzeEmotion()">
							ê°ì • ë¶„ì„í•˜ê¸°
						</button>

						<!-- ë¶„ì„ ê²°ê³¼ -->
						<!-- ğŸ¾ ê²°ê³¼ í‘œì‹œ ì˜ì—­ (ì²˜ìŒì—ëŠ” hidden) -->
						<div id="resultArea" class="hidden flex mt-6 w-full gap-6 justify-center items-center">
							<!-- ğŸ“¸ ì™¼ìª½: ì´ë¯¸ì§€ -->
							<div class="w-1/2 max-w-[300px]">
								<img id="resultImage" class="w-full rounded-xl shadow-lg border-4 border-yellow-100">
							</div>

							<!-- ğŸ“Š ì˜¤ë¥¸ìª½: í…ìŠ¤íŠ¸ + ì°¨íŠ¸ -->
							<div class="w-1/2 max-w-[300px] text-center">
								<div id="resultText" class="font-semibold text-gray-800 mb-2 text-lg"></div>
								<canvas id="emotionChart" width="200" height="200" class="mx-auto mt-2"></canvas>
							</div>
						</div>

					</div>


					<div class="bg-[#e0eadf] rounded-xl p-4 text-sm text-center">
						ì–´ì œë³´ë‹¤ ì˜¤ëŠ˜ ë¬¼ì„ <span class="font-bold">3ml</span> ë” ë¨¹ì—ˆì–´ìš”!<br>
						<button class="text-blue-600 mt-2 underline">í–‰ë™ë¶„ì„ë³´ê¸° &gt;</button>
					</div>
				</div>

				<!-- ìº˜ë¦°ë” -->
				<div class="flex gap-4">

					<!-- ì™¼ìª½: ì¼ì •/ë²„íŠ¼ -->
					<div class="flex flex-col gap-4 w-[300px] relative">
						<!-- ìƒë‹¨ + ë²„íŠ¼ í¬í•¨í•œ í—¤ë” -->
						<div class="flex justify-between items-center absoiute">
							<span id="current-month-label" class="text-sm font-bold">JULY 5</span>
							<button
									class="w-6 h-6 rounded-full bg-[#fdf6c2] shadow flex items-center justify-center text-lg font-bold"
									onclick="openTodayVaccineModal()">+</button>

						</div>

						<!-- ì¼ì • ëª©ë¡ -->
						<div class="bg-[#fdf6c2] rounded-xl shadow text-sm h-full py-3">
							<!-- ğŸ¾ ë¦¬ìŠ¤íŠ¸ í—¤ë” -->
							<div class="px-4 py-2 font-bold text-gray-700">
								ì˜ˆë°©ì ‘ì¢… ë¦¬ìŠ¤íŠ¸
							</div>
							<!-- âœ… ì‹¤ì œ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë“¤ì–´ê° -->
							<div id="monthly-vaccine-list"
								 class="px-4 pt-2 space-y-2 overflow-y-auto"
								 style="max-height: 200px;">
								<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ appendChildë¡œ ì¶”ê°€ë¨ -->
							</div>
						</div>

					</div>

					<!-- ì˜¤ë¥¸ìª½: ìº˜ë¦°ë” -->
					<div class="bg-[#fdf6c2] rounded-xl p-4 flex-1 shadow">
						<div id="calendar-container" class="w-full"></div>
					</div>

				</div>


			</section>

			<!-- ì˜¤ë¥¸ìª½ 4ì¹¸: ê³ ì–‘ì´ ì •ë³´ + ì£¼ë³€ í«ì‚´ -->
			<aside class="col-span-4 flex flex-col gap-4">

				<!-- ê³ ì–‘ì´ ì¼ëŸ¬ìŠ¤íŠ¸ -->
				<div class="tD_ani bg-white rounded-xl p-4 flex flex-col items-center shadow h-full">
					<p class="text-sm text-gray-600 mb-2">ë˜¥ëƒ¥ì´!</p>
					<img src="https://i.imgur.com/qYhSSXR.png" alt="cat" class="w-24">
				</div>

				<!-- ë“±ë¡ì¦ -->
				<div class="ani-card w-full bg-white rounded-xl max-w-4xl p-6 shadow">
					<!-- ì œëª© -->
					<h2 class="text-2xl font-bold flex items-center gap-1 mb-4 justify-center">
						<span class="text-3xl">ğŸ¾</span> ë°˜ë ¤ë™ë¬¼ë“±ë¡ì¦
					</h2>

					<!-- 3ì—´ Grid -->
					<div class="grid grid-cols-3">

						<!-- 1ì—´ -->
						<div>
							<div class="space-y-1 text-sm">
								<div><span class="font-semibold mr-2">ì´ë¦„:</span> <span th:text="${pet.name}">ë–¡ê±¸ë£©</span>
								</div>
								<div><span class="font-semibold mr-2">ë²ˆí˜¸:</span> <span
										th:text="${pet.id}">12345</span></div>
								<div><span class="font-semibold mr-2">í’ˆì¢…:</span> <span
										th:text="${pet.breed}">ì½”ë¦¬ì•ˆìˆí—¤ì–´</span></div>
								<div><span class="font-semibold mr-2">ì„±ë³„:</span> <span th:text="${pet.gender}">ì•”ì»·</span>
								</div>
							</div>

							<!-- íŠ¹ì§•: grid ë°–ì— ìœ„ì¹˜ -->
							<div class="mt-1 text-sm">
								<span class="font-semibold mr-2">íŠ¹ì§•:</span>
								<span th:text="${pet.species}">ê²ì´ ë§ê³  ë†’ì€ ë°ë¥¼ ì•„ì£¼ ì¢‹ì•„í•´ìš”</span>
							</div>
						</div>

						<!-- 2ì—´ -->
						<div class="space-y-1 text-sm">
							<div><span class="font-semibold mr-2">ìƒì¼:</span> <span
									th:text="${pet.birthDate}">2020.01.01</span></div>
							<div><span class="font-semibold mr-2">ì¤‘ì„±í™”:</span> <span>ì™„ë£Œ</span>
							</div>
						</div>

						<!-- 3ì—´: ì‚¬ì§„ -->
						<div class="flex justify-center items-start">
							<img src="https://i.imgur.com/vTaaRnh.png" alt="cat"
								class="w-30 h-30 object-cover rounded-xl border" />
						</div>
					</div>

					<!-- ë“±ë¡ì¼ -->
					<div class="createdAt text-right text-xs text-gray-500 mt-2">2025.07.05</div>
				</div>


				<!-- ì£¼ë³€ í«ì‚´ ë³´ê¸° -->
				<div class="grid grid-row-3 gap-2 h-full">
					<div class="bg-gray-300 rounded-xl p-2 text-sm">ì£¼ë³€ í«ì‚´ ì•Œì•„ë³´ê¸°</div>
					<div class="bg-gray-200 rounded-xl p-2 text-sm">123</div>
					<div class="bg-gray-200 rounded-xl p-2 text-sm">123</div>
				</div>
			</aside>


		</main>


		<!-- ë°±ì‹  ë“±ë¡ ëª¨ë‹¬ -->
		<div id="vaccineModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
			<div class="bg-white rounded-2xl p-6 w-[400px] relative shadow-lg">
				<!-- ë‹«ê¸° ë²„íŠ¼ -->
				<button onclick="closeVaccineModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-500 text-xl">Ã—</button>

				<h2 class="text-xl font-bold mb-4 text-yellow-700 text-center">ğŸ¾ ë°±ì‹  ë“±ë¡</h2>

				<form id="vaccineForm">
					<input type="hidden" name="petId" th:value="${petId}" />

					<div class="mb-4">
						<label class="block font-semibold text-sm mb-1">ë°±ì‹  ì´ë¦„</label>
						<select name="vaccineName" required class="w-full border px-3 py-2 rounded">
							<option value="">ì„ íƒí•˜ì„¸ìš”</option>
							<option value="Rabies">Rabies</option>
							<option value="Parvovirus">Parvovirus</option>
							<option value="Distemper">Distemper</option>
							<option value="Feline Distemper">Feline Distemper</option>
							<option value="Feline Leukemia">Feline Leukemia</option>
							<option value="Leptospirosis">Leptospirosis</option>
							<option value="Bordetella">Bordetella</option>
							<option value="Feline Panleukopenia">Feline Panleukopenia</option>
							<option value="FIP">FIP</option>
						</select>
					</div>

					<div class="mb-4">
						<label class="block font-semibold text-sm mb-1">ì ‘ì¢… ë‚ ì§œ</label>
						<input type="date" name="injectionDate" id="injectionDateInput" required class="w-full border px-3 py-2 rounded" />
					</div>

					<div class="mb-4">
						<label class="block font-semibold text-sm mb-1">ë¹„ê³ </label>
						<textarea name="notes" rows="3" class="w-full border px-3 py-2 rounded"></textarea>
					</div>

					<div class="flex justify-between mt-6">
						<button type="submit" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded">ğŸ’¾ ë“±ë¡</button>
						<button type="button" onclick="closeVaccineModal()" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">âŒ ì·¨ì†Œ</button>
					</div>
				</form>
			</div>
		</div>

		<!-- âœ… ë°±ì‹  ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
		<div id="vaccineDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
			<div class="bg-white p-6 rounded-2xl w-[400px] relative">
				<button onclick="closeVaccineDetailModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-500">Ã—</button>

				<div id="vaccineDetailView">
					<h2 class="text-lg font-bold text-center mb-4">ğŸ’‰ ë°±ì‹  ìƒì„¸ì •ë³´</h2>
					<p><b>ì´ë¦„:</b> <span id="detailName"></span></p>
					<p><b>ì ‘ì¢…ì¼:</b> <span id="detailDate"></span></p>
					<p><b>ë¹„ê³ :</b> <span id="detailNotes"></span></p>

					<div class="flex justify-between mt-4">
						<button onclick="enterEditMode()" class="bg-yellow-400 px-3 py-2 rounded text-white">âœ ìˆ˜ì •</button>
						<button onclick="deleteVaccination()" class="bg-red-400 px-3 py-2 rounded text-white">ğŸ—‘ ì‚­ì œ</button>
					</div>
				</div>

				<form id="vaccineEditForm" class="hidden mt-4">
					<input type="hidden" name="vaccinationId" />
					<label class="block mt-2">ì´ë¦„</label>
					<input type="text" name="vaccineName" class="border w-full px-2 py-1 rounded" required />

					<label class="block mt-2">ì ‘ì¢…ì¼</label>
					<input type="date" name="injectionDate" class="border w-full px-2 py-1 rounded" required />

					<label class="block mt-2">ë¹„ê³ </label>
					<textarea name="notes" rows="3" class="border w-full px-2 py-1 rounded"></textarea>

					<div class="flex justify-between mt-4">
						<button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">ğŸ’¾ ì €ì¥</button>
						<button type="button" onclick="cancelEdit()" class="bg-gray-400 text-white px-4 py-2 rounded">ì·¨ì†Œ</button>
					</div>
				</form>
			</div>
		</div>


		<div id="multiEventModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden">
			<div class="bg-white rounded-lg p-4 w-80">
				<h2 class="font-bold text-lg mb-2">ğŸ’‰ ë°±ì‹  ì ‘ì¢… ë¦¬ìŠ¤íŠ¸</h2>
				<div class="event-list space-y-2"></div>
				<div class="text-right mt-4">
					<button onclick="document.getElementById('multiEventModal').classList.add('hidden')" class="text-sm text-gray-500 hover:underline">ë‹«ê¸°</button>
				</div>
			</div>
		</div>



	</div>


	<script th:inline="javascript">
		/*<![CDATA[*/
		var events = [[${eventsJson}]];
		/*]]>*/
	</script>


	<script>
		var urlParams = new URLSearchParams(window.location.search);
		var petId = urlParams.get("petId");
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			fetch('/usr/pet/vaccination/events?petId=' + petId)
					.then(res => res.json())
					.then(freshEvents => {
						renderMiniCalendar('calendar-container', freshEvents, new Date());
					});
		});

	</script>

	<script>
		function openVaccineModal(petId, dateStr) {
			document.getElementById('injectionDateInput').value = dateStr;

			// ğŸ‘‰ ì—¬ê¸°ê°€ ì¤‘ìš”!
			const petInput = document.querySelector('#vaccineForm input[name="petId"]');
			if (petInput) {
				petInput.value = petId;
			}

			document.getElementById('vaccineModal').classList.remove('hidden');
		}

		function closeVaccineModal() {
			document.getElementById('vaccineModal').classList.add('hidden');
		}

		function openVaccineDetailModal(data) {
			document.getElementById('vaccineDetailModal').classList.remove('hidden');

			document.getElementById('detailName').textContent = data.title;
			document.getElementById('detailDate').textContent = data.start;
			document.getElementById('detailNotes').textContent = data.notes || 'ì—†ìŒ';

			// ìˆ˜ì •ìš© hidden ê°’ ì„¸íŒ…
			const form = document.getElementById('vaccineEditForm');
			form.vaccinationId.value = data.id;
			form.vaccineName.value = data.title.replace(' ì ‘ì¢…', '');
			form.injectionDate.value = data.start;
			form.notes.value = data.notes || '';
		}

		function closeVaccineDetailModal() {
			document.getElementById('vaccineDetailModal').classList.add('hidden');
			cancelEdit();
		}

		function enterEditMode() {
			document.getElementById('vaccineDetailView').classList.add('hidden');
			document.getElementById('vaccineEditForm').classList.remove('hidden');
		}

		function cancelEdit() {
			document.getElementById('vaccineEditForm').classList.add('hidden');
			document.getElementById('vaccineDetailView').classList.remove('hidden');
		}

		document.getElementById('vaccineEditForm').addEventListener('submit', function(e) {
			e.preventDefault();

			const formData = new FormData(this);

			fetch('/usr/pet/vaccination/doModify', {
				method: 'POST',
				body: formData
			})
					.then(res => res.json())
					.then(result => {
						if (result.success) {
							closeVaccineDetailModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar(); // âœ… ë‹¬ë ¥ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
						} else {
							alert(result.msg);
						}
					});
		});

		function deleteVaccination() {
			const id = document.querySelector('#vaccineEditForm input[name="vaccinationId"]').value;
			if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

			fetch('/usr/pet/vaccination/delete?vaccinationId=' + id)
					.then(res => res.json())
					.then(result => {
						if (result.resultCode?.startsWith('S-')) {
							closeVaccineDetailModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar();         // ë‹¬ë ¥ ìƒˆë¡œ ê·¸ë¦¬ê¸°
						} else {
							alert("âš ï¸ ì‚­ì œ ì‹¤íŒ¨: " + (result.msg || ''));
						}
					})
					.catch(err => {
						console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
						alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
					});

		}

		function refreshCalendar() {
			fetch('/usr/pet/vaccination/events?petId=' + petId)
					.then(res => res.json())
					.then(freshEvents => {
						renderMiniCalendar('calendar-container', freshEvents); // ìµœì‹  ë°ì´í„°ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
					});
		}

		function openEventListModal(events) {
			const modal = document.getElementById('multiEventModal');
			const container = modal.querySelector('.event-list');
			container.innerHTML = '';

			events.forEach(e => {
				const btn = document.createElement('button');
				btn.textContent = `${e.title} (${e.start})`;
				btn.className = 'block w-full text-left px-4 py-2 hover:bg-yellow-100';
				btn.onclick = () => {
					modal.classList.add('hidden');
					openVaccineDetailModal(e);
				};
				container.appendChild(btn);
			});

			modal.classList.remove('hidden');
		}
	</script>

	<script>
		document.getElementById("vaccineForm").addEventListener("submit", function (e) {
			e.preventDefault();

			const form = e.target;
			const formData = new FormData(form);

			// FormDataì— ì‹¤ì œ ë°ì´í„° ì°ì–´ë³´ê¸° (ë””ë²„ê¹…ìš©)
			console.log("ğŸ” ì „ì†¡ ë°ì´í„°:");
			for (const [key, value] of formData.entries()) {
				console.log(`${key}: ${value}`);
			}

			fetch("/usr/pet/vaccination/doRegistration", {
				method: "POST",
				body: formData
			})
					.then(res => {
						if (!res.ok) throw new Error(`HTTP ${res.status}`);
						return res.json();
					})
					.then(data => {
						console.log("âœ… ì‘ë‹µ:", data);

						if (data.resultCode?.startsWith("S-")) {
							alert("ğŸ’‰ ë°±ì‹  ë“±ë¡ ì„±ê³µ!");
							closeVaccineModal(); // ëª¨ë‹¬ ë‹«ê¸°
							refreshCalendar(); // âœ… ë‹¬ë ¥ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
							// âœ… í•„ìš”ì‹œ ë‹¬ë ¥ ë¦¬ë Œë” ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
						} else {
							alert("âš ï¸ ë“±ë¡ ì‹¤íŒ¨: " + (data.msg || ""));
						}
					})
					.catch(err => {
						console.error("âŒ ì˜¤ë¥˜:", err);
						alert("âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
					});
		});

		function updateVaccinationList(year, month) {
			var monthStr = (month + 1 < 10 ? '0' : '') + (month + 1);
			var target = document.getElementById('monthly-vaccine-list');
			target.innerHTML = ''; // ì´ˆê¸°í™”

			var yearMonth = year + '-' + monthStr;

			fetch('/usr/pet/vaccination/monthly?petId=' + petId + '&yearMonth=' + yearMonth)
					.then(function(res) {
						return res.json();
					})
					.then(function(data) {
						if (data.length === 0) {
							target.innerHTML = '<div class="text-gray-500">ë“±ë¡ëœ ì ‘ì¢… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
							return;
						}

						data.forEach(function(item) {
							var div = document.createElement('div');
							div.className = 'bg-white p-2 rounded shadow border-l-4 border-yellow-400 text-sm';
							div.innerHTML =
									'ğŸ’‰ <b>' + item.vaccineName + '</b> (' + item.injectionDate + ')<br>' +
									'<span class="text-xs text-gray-500">ë‹¤ìŒ ì ‘ì¢…: ' + (item.nextDueDate || 'ë¯¸ì •') + '</span>';
							div.onclick = function () {
								openVaccineDetailModal({
									id: item.id,
									title: item.vaccineName + ' ì ‘ì¢…',
									start: item.injectionDate,
									notes: item.notes
								});
							};
							target.appendChild(div);
						});
					});
		}

		function openTodayVaccineModal() {
			const today = new Date();

			const year = today.getFullYear();
			const month = today.getMonth() + 1;
			const day = today.getDate();

			const monthStr = month < 10 ? '0' + month : '' + month;
			const dayStr = day < 10 ? '0' + day : '' + day;

			const dateStr = `${year}-${monthStr}-${dayStr}`;

			openVaccineModal(petId, dateStr); // ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
		}


	</script>

	<script>
		let selectedSpecies = null;  // ê°•ì•„ì§€/ê³ ì–‘ì´ ì„ íƒ
		let uploadedFile = null;     // ì—…ë¡œë“œëœ íŒŒì¼
		let emotionChart = null;     // Chart.js ì¸ìŠ¤í„´ìŠ¤

		// ì¢… ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
		function selectSpecies(species) {
			selectedSpecies = species;

			document.querySelectorAll('.species-btn').forEach(btn => {
				btn.classList.remove('bg-yellow-300', 'text-white');
			});

			const selectedBtn = Array.from(document.querySelectorAll('.species-btn'))
					.find(btn => btn.textContent.includes(species));

			if (selectedBtn) {
				selectedBtn.classList.add('bg-yellow-300', 'text-white');
			}
		}

		// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸°
		function previewImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			uploadedFile = file;

			const reader = new FileReader();
			reader.onload = function (e) {
				document.getElementById('emotionPreview').src = e.target.result;
			};
			reader.readAsDataURL(file);
		}

		// ê°ì • ë¶„ì„ ìš”ì²­
		function analyzeEmotion() {
			if (!selectedSpecies) {
				alert("ğŸ¾ ê°•ì•„ì§€ ë˜ëŠ” ê³ ì–‘ì´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
				return;
			}

			if (!uploadedFile) {
				alert("ğŸ“· ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
				return;
			}

			const petId = new URLSearchParams(window.location.search).get('petId'); // URLì—ì„œ petId ì¶”ì¶œ
			if (!petId) {
				alert("âŒ petIdê°€ ì—†ìŠµë‹ˆë‹¤.");
				return;
			}

			const formData = new FormData();
			formData.append("petId", petId);
			formData.append("species", selectedSpecies);
			formData.append("imageFile", uploadedFile);

			fetch("/usr/pet/analysis/do", {
				method: "POST",
				body: formData
			})
					.then(res => {
						if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
						return res.json();
					})
					.then(data => {

						// ë¶„ì„ ì´ë¯¸ì§€ í‘œì‹œ
						document.getElementById('resultImage').src = data.imagePath;

						document.querySelectorAll('.species-btn, .upload-label, .analyze-btn')
								.forEach(el => el.classList.add('hidden'));

						document.getElementById('imageContainer').classList.add('hidden');

						document.getElementById('emotionPreview').classList.add('hidden');
						document.getElementById('resultArea').classList.remove('hidden');
						document.getElementById('retryButton').classList.remove('hidden');

						// í…ìŠ¤íŠ¸ í‘œì‹œ
						const probs = data.probabilities;
						const labels = Object.keys(probs);
						const values = Object.values(probs).map(v => parseFloat((v).toFixed(2)));

						const labelMap = {
							"happy": "ğŸ˜Š í–‰ë³µ",
							"relaxed": "ğŸ˜Œ í‰ì˜¨",
							"angry": "ğŸ˜  í™”ë‚¨",
							"sad": "ğŸ˜¿ ìŠ¬í””",
							"scared": "ğŸ˜¨ ë‘ë ¤ì›€"
						};

						const maxIdx = values.indexOf(Math.max(...values));
						const displayLabel = labelMap[labels[maxIdx]] || labels[maxIdx];
						document.getElementById('resultText').textContent = `ê°€ì¥ ë†’ì€ ê°ì •: ${displayLabel} (${values[maxIdx]}%)`;

						// ì°¨íŠ¸ ê·¸ë¦¬ê¸°
						if (emotionChart) emotionChart.destroy();
						const ctx = document.getElementById('emotionChart').getContext('2d');
						emotionChart = new Chart(ctx, {
							type: 'pie',
							data: {
								labels: labels.map(l => labelMap[l] || l),
								datasets: [{
									data: values,
									backgroundColor: ['#f9c74f', '#90be6d', '#f8961e', '#43aa8b', '#577590']
								}]
							},
							options: {
								plugins: {
									legend: { position: 'bottom' },
									title: { display: true, text: 'ê°ì • ë¹„ìœ¨ ë¶„ì„' }
								}
							}
						});
					})

					.catch(err => {
						console.error("âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", err);
						alert("ë¶„ì„ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					});
		}

		function resetEmotionPanel() {
			document.querySelectorAll('.species-btn, .upload-label, .analyze-btn')
					.forEach(el => el.classList.remove('hidden'));

			document.getElementById('imageContainer').classList.remove('hidden');

			document.getElementById('resultArea').classList.add('hidden');
			document.getElementById('retryButton').classList.add('hidden');

			document.getElementById('emotionPreview').src = '';
			document.getElementById('resultText').textContent = '';
			if (emotionChart) {
				emotionChart.destroy();
				emotionChart = null;
			}
		}




		// ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
		function closeEmotionPanel() {
			document.getElementById("emotionPanel").classList.add("translate-x-full");
		}

		// ìŠ¬ë¼ì´ë“œ ì—´ê¸° (í•„ìš”í•œ ê²½ìš°)
		function openEmotionPanel() {
			document.getElementById("emotionPanel").classList.remove("translate-x-full");
		}
	</script>





	<script>
		const ctx = document.getElementById('myChart').getContext('2d');
		const myChart = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
				datasets: [
					{
						label: 'ì‹ì‚¬ëŸ‰',
						data: [4, 5, 3, 4.5, 5, 6, 4.8],
						backgroundColor: 'rgba(244, 211, 94, 0.8)',
						borderRadius: {
							topLeft: 100,
							bottomRight: 40
						},
						barPercentage: 0.6,
						borderSkipped: false,
						categoryPercentage: 0.7
					},
					{
						label: 'ë¬¼ ì„­ì·¨ëŸ‰',
						data: [3, 2.5, 4, 3.5, 4, 5, 4.2],
						backgroundColor: 'rgba(127, 176, 105, 0.8)',
						borderRadius: {
							topLeft: 100,
							bottomRight: 40
						},
						barPercentage: 0.6,
						borderSkipped: false,
						categoryPercentage: 0.7
					},
					{
						label: 'ìµœì¢… ì ìˆ˜',
						data: [7, 7.5, 7, 8, 9, 10, 9],
						backgroundColor: 'rgba(79, 109, 122, 0.8)',
						borderRadius: {
							topLeft: 100,
							bottomRight: 40
						},
						borderSkipped: false,
						barPercentage: 0.6,
						categoryPercentage: 0.7
					}
				]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: {
						position: 'top'
					},
					title: {
						display: false
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						max: 10
					}
				}
			}
		});

	</script>
	<script th:src="@{/resource/js/calendar.js}"></script>



</body>

</html>