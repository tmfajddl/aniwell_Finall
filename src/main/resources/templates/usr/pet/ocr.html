<!-- templates/usr/pet/ocr.html -->
<!-- âœ… í…ŒìŠ¤íŠ¸ ì—…ë¡œë“œ í˜ì´ì§€: íŒŒì¼ ì„ íƒ â†’ /api/ocr/extract ë¡œ POST ì „ì†¡ -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>OCR í…ŒìŠ¤íŠ¸</title>

<!-- âœ… (ê¶Œì¥) Spring Security CSRF ëŒ€ì‘: POST í˜¸ì¶œ ì‹œ í† í° í—¤ë”ë¡œ ì „ì†¡ -->
<!-- ğŸ”§ [ë³€ê²½] Security 6.x í™˜ê²½ì—ì„œ _csrfê°€ nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, í´ë˜ìŠ¤ëª…ìœ¼ë¡œ ì•ˆì „ ì ‘ê·¼ + ì¡°ê±´ë¶€ ë Œë”ë§ -->
<th:block th:with="csrf=${#request.getAttribute('org.springframework.security.web.csrf.CsrfToken')}"
	th:if="${csrf != null}">
	<meta name="_csrf" th:content="${csrf.token}" />
	<meta name="_csrf_header" th:content="${csrf.headerName}" />
</th:block>
<!-- ì°¸ê³ : ìœ„ ë¸”ë¡ì€ _csrfê°€ ì—†ì„ ë•ŒëŠ” ì•„ë¬´ê²ƒë„ ë Œë”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ Thymeleaf íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. -->

<style>
body {
	font-family: system-ui, Arial, sans-serif;
	padding: 16px;
}

#out {
	white-space: pre-wrap;
	border: 1px solid #ddd;
	padding: 12px;
	margin-top: 12px;
}
</style>
</head>
<body>
	<h2>ì˜ìˆ˜ì¦ OCR í…ŒìŠ¤íŠ¸</h2>

	<!-- âœ… íŒŒì¼ ì—…ë¡œë“œ UI (í•„ë“œëª…ì€ ë°˜ë“œì‹œ 'file') -->
	<input id="file" type="file" accept="image/*" />
	<button id="run" type="button">OCR ì‹¤í–‰</button>

	<div id="out" aria-live="polite"></div>

	<script>
    // âœ… CSRF í† í° ì¶”ì¶œ(ìˆìœ¼ë©´ í—¤ë”ì— í¬í•¨, ì—†ìœ¼ë©´ í—¤ë” ìƒëµ)
    function getCsrf() {
      const tokenTag = document.querySelector('meta[name="_csrf"]');
      const headerTag = document.querySelector('meta[name="_csrf_header"]');
      return (tokenTag && headerTag && tokenTag.content && headerTag.content)
        ? { header: headerTag.content, token: tokenTag.content }
        : null;
    }

    document.getElementById('run').onclick = async () => {
      const out = document.getElementById('out');
      const f = document.getElementById('file').files?.[0];
      if (!f) { alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }

      const form = new FormData();
      form.append('file', f); // âš ï¸ ì„œë²„ @RequestParam("file")ì™€ ì¼ì¹˜í•´ì•¼ í•¨

      const opts = { method: 'POST', body: form, headers: {} };
      const csrf = getCsrf();
      if (csrf) opts.headers[csrf.header] = csrf.token; // âœ… ë³´ì•ˆ: CSRF í—¤ë” ì„¸íŒ…

      out.textContent = 'ì—…ë¡œë“œ ì¤‘...';
      try {
        const res = await fetch('/api/ocr/extract', opts);
        // (ì„ íƒ) ìƒíƒœì½”ë“œ ì²´í¬ë¥¼ ì¶”ê°€í•´ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸ ê°€ë…ì„± ê°œì„ 
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(`HTTP ${res.status} ${res.statusText}${text ? ' - ' + text : ''}`);
        }
        const json = await res.json(); // { resultCode, msg, data: { text, confidence } }
        out.textContent = JSON.stringify(json, null, 2);
      } catch (e) {
        out.textContent = 'ìš”ì²­ ì‹¤íŒ¨: ' + (e?.message || e);
      }
    };
  </script>
</body>
</html>
