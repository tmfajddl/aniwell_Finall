<!-- templates/usr/pet/ocr.html -->
<!-- âœ… í…ŒìŠ¤íŠ¸ ì—…ë¡œë“œ í˜ì´ì§€: íŒŒì¼ ì„ íƒ â†’ /api/ocr/extract ë¡œ POST ì „ì†¡ -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>OCR í…ŒìŠ¤íŠ¸</title>

<!-- âœ… (ê¶Œì¥) Spring Security CSRF ëŒ€ì‘: POST í˜¸ì¶œ ì‹œ í† í° í—¤ë”ë¡œ ì „ì†¡ -->
<!-- ğŸ”§ [ë³€ê²½] Security 6.x í™˜ê²½ì—ì„œ _csrfê°€ nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, í´ë˜ìŠ¤ëª…ìœ¼ë¡œ ì•ˆì „ ì ‘ê·¼ + ì¡°ê±´ë¶€ ë Œë”ë§ -->
<th:block th:with="csrf=${#request.getAttribute('org.springframework.security.web.csrf.CsrfToken')}"
	th:if="${csrf != null}">
	<meta name="_csrf" th:content="${csrf.token}" />
	<meta name="_csrf_header" th:content="${csrf.headerName}" />
</th:block>
<!-- ì°¸ê³ : ìœ„ ë¸”ë¡ì€ _csrfê°€ ì—†ì„ ë•ŒëŠ” ì•„ë¬´ê²ƒë„ ë Œë”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ Thymeleaf íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. -->

<style>
body {
	font-family: system-ui, Arial, sans-serif;
	padding: 16px;
}

#out {
	white-space: pre-wrap;
	border: 1px solid #ddd;
	padding: 12px;
	margin-top: 12px;
}
</style>
</head>
<body>
	<h2>ì˜ìˆ˜ì¦ OCR í…ŒìŠ¤íŠ¸</h2>

	<!-- âœ… íŒŒì¼ ì—…ë¡œë“œ UI (í•„ë“œëª…ì€ ë°˜ë“œì‹œ 'file') -->
	<input id="file" type="file" accept="image/*" />
	<button id="run" type="button">OCR ì‹¤í–‰</button>
	<button id="btnSaveOcr" type="button">OCR ì €ì¥</button>
	<div id="out" aria-live="polite"></div>

	<script>
  // =========================
  // âœ… ì „ì—­ ìƒíƒœ: ë§ˆì§€ë§‰ OCR í…ìŠ¤íŠ¸/íŒŒì¼ URL
  // =========================
  let __lastOcrText = null;      // OCR ì‹¤í–‰ ì„±ê³µ ì‹œ ì €ì¥
  let __uploadedFileUrl = null;  // (ì„ íƒ) ì´ë¯¸ì§€ ì—…ë¡œë“œ URL ë³´ê´€ìš©

  // =========================
  // âœ… CSRF ë©”íƒ€ì—ì„œ í† í° ì¶”ì¶œ (ì—†ìœ¼ë©´ null ë°˜í™˜)
  // =========================
  function getCsrf() {
    const tokenTag  = document.querySelector('meta[name="_csrf"]');
    const headerTag = document.querySelector('meta[name="_csrf_header"]');
    return (tokenTag && headerTag && tokenTag.content && headerTag.content)
      ? { header: headerTag.content, token: tokenTag.content }
      : null;
  }

  // =========================
  // âœ… URL ì¿¼ë¦¬ íŒŒì„œ (ì˜ˆ: /usr/pet/ocr?petId=1&visitId=10)
  // =========================
  function getQueryParam(name) {
    const p = new URLSearchParams(location.search);
    return p.get(name);
  }

  // =========================
  // âœ… DOM ì°¸ì¡°
  // =========================
  const $file = document.getElementById('file');
  const $out  = document.getElementById('out');

  // =========================
  // âœ… OCR ì‹¤í–‰: /api/ocr/extract ë¡œ íŒŒì¼ ì—…ë¡œë“œ
  // =========================
  document.getElementById('run').onclick = async () => {
    const f = $file.files?.[0];
    if (!f) { alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

    // 1) FormData êµ¬ì„± (ì„œë²„ @RequestParam("file")ì™€ í•„ë“œëª… ì¼ì¹˜)
    const form = new FormData();
    form.append('file', f);

    // 2) CSRF í—¤ë”(ìˆì„ ë•Œë§Œ)
    const headers = {};
    const csrf = getCsrf();
    if (csrf) headers[csrf.header] = csrf.token;

    // 3) ìš”ì²­
    $out.textContent = 'ì—…ë¡œë“œ ì¤‘...';
    try {
      const res = await fetch('/api/ocr/extract', { method: 'POST', body: form, headers });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText}${text ? ' - ' + text : ''}`);
      }
      const json = await res.json(); // { resultCode, msg, data1?, data?, text? ... }

      // 4) í™”ë©´ ì¶œë ¥
      $out.textContent = JSON.stringify(json, null, 2);

      // 5) í…ìŠ¤íŠ¸ ì¶”ì¶œ ë³´ê´€(ì„œë²„ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ì•ˆì „ íƒìƒ‰)
      __lastOcrText = (json?.data1?.text) || (json?.data?.text) || (json?.text) || null;
      if (!__lastOcrText) {
        console.warn('ì‘ë‹µì—ì„œ OCR í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
    } catch (e) {
      console.error(e);
      $out.textContent = 'ìš”ì²­ ì‹¤íŒ¨: ' + (e?.message || e);
    }
  };

  // =========================
  // âœ… OCR ì €ì¥: /api/ocr/save ë¡œ JSON POST
  // =========================
  async function saveOcr() {
    if (!__lastOcrText || !__lastOcrText.trim()) {
      alert('ì €ì¥í•  OCR í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [OCR ì‹¤í–‰]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      return;
    }

    // visitIdê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë°©ë¬¸ì— ë¬¸ì„œ ì¶”ê°€, ì—†ìœ¼ë©´ petIdë¡œ ìƒˆ visit ìƒì„±
    const petId   = getQueryParam('petId')   ? Number(getQueryParam('petId'))   : null;
    const visitId = getQueryParam('visitId') ? Number(getQueryParam('visitId')) : null;

    const payload = {
      text: __lastOcrText,
      visitId: visitId || null,
      petId: visitId ? null : petId,     // visitId ì—†ì„ ë•Œë§Œ petId ì‚¬ìš©
      docType: 'receipt',                // receipt | prescription | lab | diagnosis | other
      fileUrl: __uploadedFileUrl || null // ì„ íƒ
      // í•„ìš” ì‹œ visitDate/hospital/doctor/diagnosis/notes ì¶”ê°€
    };

    // CSRF í—¤ë”(ìˆì„ ë•Œë§Œ)
    const headers = { 'Content-Type': 'application/json' };
    const csrf = getCsrf();
    if (csrf) headers[csrf.header] = csrf.token;

    try {
      const res = await fetch('/api/ocr/save', {
        method: 'POST',
        headers,
        body: JSON.stringify(payload)
      });
      const json = await res.json();

      if (json?.resultCode?.startsWith('S-')) {
        const { visitId, documentId } = json.data || {};
        alert(`ì €ì¥ ì™„ë£Œ!\nvisitId=${visitId}, documentId=${documentId}`);
        // í•„ìš” ì‹œ ìƒì„¸ë¡œ ì´ë™:
        // location.href = `/usr/visit/detail?id=${visitId}`;
      } else {
        console.error('OCR ì €ì¥ ì‹¤íŒ¨:', json);
        alert(`ì €ì¥ ì‹¤íŒ¨: ${json?.msg || 'ì„œë²„ ì˜¤ë¥˜'}`);
      }
    } catch (e) {
      console.error(e);
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // =========================
  // âœ… ë²„íŠ¼ ë°”ì¸ë”©
  // =========================
  document.getElementById('btnSaveOcr')?.addEventListener('click', saveOcr);
</script>


</body>
</html>
