<!-- templates/usr/pet/ocr.html -->
<!-- âœ… í…ŒìŠ¤íŠ¸ ì—…ë¡œë“œ í˜ì´ì§€: íŒŒì¼ ì„ íƒ â†’ /api/ocr/extract ë¡œ POST ì „ì†¡ -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>OCR í…ŒìŠ¤íŠ¸</title>

<!-- âœ… (ê¶Œì¥) Spring Security CSRF ëŒ€ì‘: POST í˜¸ì¶œ ì‹œ í† í° í—¤ë”ë¡œ ì „ì†¡ -->
<!-- ğŸ”§ Security 6.x í™˜ê²½ì—ì„œ _csrfê°€ nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì•ˆì „ ì ‘ê·¼ + ì¡°ê±´ë¶€ ë Œë”ë§ -->
<th:block th:with="csrf=${#request.getAttribute('org.springframework.security.web.csrf.CsrfToken')}"
	th:if="${csrf != null}">
	<meta name="_csrf" th:content="${csrf.token}" />
	<meta name="_csrf_header" th:content="${csrf.headerName}" />
</th:block>
<!-- ì°¸ê³ : ìœ„ ë¸”ë¡ì€ _csrfê°€ ì—†ì„ ë• ì•„ë¬´ ê²ƒë„ ë Œë”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. -->

<style>
body {
	font-family: system-ui, Arial, sans-serif;
	padding: 16px;
}

#out {
	white-space: pre-wrap;
	border: 1px solid #ddd;
	padding: 12px;
	margin-top: 12px;
}

.btn {
	padding: 6px 10px;
	border: 1px solid #aaa;
	border-radius: 4px;
	background: #fff;
	cursor: pointer;
}

.btn:disabled {
	opacity: .6;
	cursor: not-allowed;
}
</style>
</head>
<body>
	<h2>ì˜ìˆ˜ì¦ OCR í…ŒìŠ¤íŠ¸</h2>

	<!-- âœ… íŒŒì¼ ì—…ë¡œë“œ UI (í•„ë“œëª…ì€ ë°˜ë“œì‹œ 'file') -->
	<input id="file" type="file" accept="image/*" />
	<button id="run" type="button" class="btn">OCR ì‹¤í–‰</button>
	<button id="btnSaveOcr" type="button" class="btn">OCR ì €ì¥</button>

	<div id="out" aria-live="polite"></div>

	<script>
    // =========================
    // âœ… ì „ì—­ ìƒíƒœ: ë§ˆì§€ë§‰ OCR í…ìŠ¤íŠ¸/íŒŒì¼ URL
    // =========================
    let __lastOcrText = null;      // OCR ì‹¤í–‰ ì„±ê³µ ì‹œ ì €ì¥
    let __uploadedFileUrl = null;  // ì„œë²„ê°€ ë°˜í™˜í•œ ì´ë¯¸ì§€ URL (ì—†ìœ¼ë©´ null â†’ í´ë°± ê²½ë¡œ ì‚¬ìš©)

    // =========================
    // âœ… CSRF ë©”íƒ€ì—ì„œ í† í° ì¶”ì¶œ (ì—†ìœ¼ë©´ null ë°˜í™˜)
    // =========================
    function getCsrf() {
      const tokenTag  = document.querySelector('meta[name="_csrf"]');
      const headerTag = document.querySelector('meta[name="_csrf_header"]');
      return (tokenTag && headerTag && tokenTag.content && headerTag.content)
        ? { header: headerTag.content, token: tokenTag.content }
        : null;
    }

    // =========================
    // âœ… URL ì¿¼ë¦¬ íŒŒì„œ (ì˜ˆ: /usr/pet/ocr?petId=1&visitId=10)
    // =========================
    function getQueryParam(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }

    // ìˆ«ì ë³€í™˜(ê³µë°±/ë¹ˆë¬¸ì â†’ null ì²˜ë¦¬) ìœ í‹¸
    function parseNumOrNull(v) {
      if (v == null) return null;
      const s = String(v).trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // =========================
    // âœ… DOM ì°¸ì¡°
    // =========================
    const $file = document.getElementById('file');
    const $out  = document.getElementById('out');
    const $run  = document.getElementById('run');
    const $save = document.getElementById('btnSaveOcr');

    // ë²„íŠ¼ ë¹„í™œì„±/í™œì„± í† ê¸€ ìœ í‹¸
    function toggleBusy(isBusy) {
      $run.disabled = isBusy;
      $save.disabled = isBusy;
    }

    // =========================
    // âœ… OCR ì‹¤í–‰: /api/ocr/extract ë¡œ íŒŒì¼ ì—…ë¡œë“œ
    // =========================
    $run.onclick = async () => {
      const f = $file.files?.[0];
      if (!f) { alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

      // 1) FormData êµ¬ì„± (ì„œë²„ @RequestParam("file")ì™€ í•„ë“œëª… ì¼ì¹˜)
      const form = new FormData();
      form.append('file', f);

      // 2) CSRF í—¤ë”(ìˆì„ ë•Œë§Œ)
      const headers = {};
      const csrf = getCsrf();
      if (csrf) headers[csrf.header] = csrf.token;

      // 3) ìš”ì²­
      $out.textContent = 'ì—…ë¡œë“œ ì¤‘...';
      toggleBusy(true);
      try {
        const res = await fetch('/api/ocr/extract', { method: 'POST', body: form, headers });
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(`HTTP ${res.status} ${res.statusText}${text ? ' - ' + text : ''}`);
        }
        const json = await res.json(); // { resultCode, msg, data1?, data?, text? ... }

        // 4) í™”ë©´ ì¶œë ¥(ë””ë²„ê·¸ ë³´ê¸° ì¢‹ê²Œ)
        $out.textContent = JSON.stringify(json, null, 2);

        // 5) í…ìŠ¤íŠ¸ + íŒŒì¼URL ì¶”ì¶œ ë³´ê´€(ì„œë²„ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ì•ˆì „ íƒìƒ‰)
        //    - text: data1.text â†’ data.text â†’ text
        //    - fileUrl: data1.fileUrl â†’ data.fileUrl (ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ null ìœ ì§€ â†’ í´ë°±)
        __lastOcrText     = (json?.data1?.text)    || (json?.data?.text)    || (json?.text) || null;
        __uploadedFileUrl = (json?.data1?.fileUrl) || (json?.data?.fileUrl) || __uploadedFileUrl || null;

        if (!__lastOcrText) {
          console.warn('ì‘ë‹µì—ì„œ OCR í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
      } catch (e) {
        console.error(e);
        $out.textContent = 'ìš”ì²­ ì‹¤íŒ¨: ' + (e?.message || e);
      } finally {
        toggleBusy(false);
      }
    };

    // =========================
    // âœ… OCR ì €ì¥: ì´ë¯¸ì§€+í…ìŠ¤íŠ¸ í•¨ê»˜ ì €ì¥
    // - fileUrlì´ ìˆìœ¼ë©´ JSON(/api/ocr/save)
    // - fileUrlì´ ì—†ìœ¼ë©´ ë©€í‹°íŒŒíŠ¸(/api/ocr/save-with-file) í´ë°±
    // =========================
    async function saveOcr() {
      if (!__lastOcrText || !__lastOcrText.trim()) {
        alert('ì €ì¥í•  OCR í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [OCR ì‹¤í–‰]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
        return;
      }

      // visitIdê°€ ìˆìœ¼ë©´ ê¸°ì¡´ ë°©ë¬¸ì— ë¬¸ì„œ ì¶”ê°€, ì—†ìœ¼ë©´ petIdë¡œ ìƒˆ visit ìƒì„±
      const petId   = parseNumOrNull(getQueryParam('petId'));
      const visitId = parseNumOrNull(getQueryParam('visitId'));

      // ê³µí†µ ë©”íƒ€ (í•„ìš” ì‹œ í™”ë©´ì—ì„œ ì…ë ¥ë°›ì•„ ì¶”ê°€ ê°€ëŠ¥)
      const docType = 'receipt';

      const csrf = getCsrf();
      toggleBusy(true);
      try {
        let json;

        if (__uploadedFileUrl) {
          // âœ… 1) fileUrl ë³´ìœ : JSONìœ¼ë¡œ ì €ì¥ (/api/ocr/save)
          const payload = {
            text: __lastOcrText,
            visitId: visitId || null,
            petId: visitId ? null : petId,
            docType,
            fileUrl: __uploadedFileUrl // ì„œë²„ê°€ ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ URL
            // visitDate/hospital/doctor/diagnosis/notes í•„ìš” ì‹œ ì¶”ê°€
          };
          const headers = { 'Content-Type': 'application/json' };
          if (csrf) headers[csrf.header] = csrf.token;

          const res = await fetch('/api/ocr/save', {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
          });
          json = await res.json();
        } else {
          // âœ… 2) fileUrl ë¯¸ë³´ìœ : ì´ë¯¸ì§€ íŒŒì¼ê¹Œì§€ í•¨ê»˜ ì—…ë¡œë“œ (/api/ocr/save-with-file)
          const f = $file.files?.[0];
          if (!f) { alert('íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  OCR ì‹¤í–‰ì„ í•´ì£¼ì„¸ìš”.'); toggleBusy(false); return; }

          const form = new FormData();
          form.append('file', f);                 // ì—…ë¡œë“œ ì´ë¯¸ì§€ (ì›ë³¸ ì €ì¥)
          form.append('text', __lastOcrText);     // ë¶„ì„ í…ìŠ¤íŠ¸
          if (visitId != null)          form.append('visitId', String(visitId));
          if (visitId == null && petId) form.append('petId', String(petId));
          form.append('docType', docType);
          // í•„ìš” ì‹œ visitDate/hospital/doctor/diagnosis/notes ì¶”ê°€ ê°€ëŠ¥

          const headers = {};
          if (csrf) headers[csrf.header] = csrf.token; // ë©€í‹°íŒŒíŠ¸ëŠ” Content-Type ìë™ ì§€ì •
          const res = await fetch('/api/ocr/save-with-file', {
            method: 'POST',
            headers,
            body: form
          });
          json = await res.json();
        }

        console.log('[OCR ì €ì¥ ì‘ë‹µ]', json); // ë””ë²„ê·¸

        if (json?.resultCode?.startsWith('S-')) {
          // âœ… ì‘ë‹µ ìŠ¬ë¡¯(data/data1/data2/data3) ëª¨ë‘ ì§€ì›
          const out = json.data ?? json.data1 ?? json.data2 ?? json.data3 ?? {};
          const { visitId: outVisitId, documentId, fileUrl } = out;
          // ì €ì¥ ì§í›„ ëŒë ¤ì¤€ fileUrl(ìˆìœ¼ë©´) ìµœì‹ ê°’ ì €ì¥í•´ ë‘ë©´ ì´í›„ ë¯¸ë¦¬ë³´ê¸°ì— ì‚¬ìš© ê°€ëŠ¥
          if (fileUrl && !__uploadedFileUrl) __uploadedFileUrl = fileUrl;

          alert(`ì €ì¥ ì™„ë£Œ!\nvisitId=${outVisitId}, documentId=${documentId}`);
          // í•„ìš” ì‹œ ìƒì„¸ë¡œ ì´ë™:
          // location.href = `/usr/visit/detail?id=${outVisitId}`;
        } else {
          console.error('OCR ì €ì¥ ì‹¤íŒ¨:', json);
          alert(`ì €ì¥ ì‹¤íŒ¨: ${json?.msg || 'ì„œë²„ ì˜¤ë¥˜'}`);
        }
      } catch (e) {
        console.error(e);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        toggleBusy(false);
      }
    }

    // =========================
    // âœ… ë²„íŠ¼ ë°”ì¸ë”©
    // =========================
    document.getElementById('btnSaveOcr')?.addEventListener('click', saveOcr);
  </script>
</body>
</html>
