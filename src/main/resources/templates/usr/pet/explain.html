<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>ë³´í˜¸ì ë¦¬í¬íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        :root{ --ink:#0f172a; --mut:#64748b; --bg:#f6f7fb; --card:#fff;
            --primary:#4f46e5; --ok:#16a34a; --high:#ef4444; --low:#0ea5e9; --warn:#f59e0b; --line:#e5e7eb; --zebra:#fafafa; }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--ink); font:14px/1.55 'Pretendard','Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto}
        .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
        .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
        .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
        h1{margin:0 0 12px;font-size:22px;letter-spacing:-.2px}
        button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--primary); color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(79,70,229,.18)}
        button.secondary{background:#e5e7eb;color:#111;box-shadow:none}
        button.small{padding:6px 10px;font-size:12px;border-radius:8px}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .hint{color:var(--mut);font-size:12px}
        .status{margin-left:auto;color:var(--mut);display:flex;align-items:center;gap:8px}
        .spinner{width:14px;height:14px;border:2px solid #e2e8f0;border-top-color:var(--primary); border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .tabs{display:flex;gap:6px}
        .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#f8fafc;cursor:pointer;font-weight:600}
        .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
        .view{border:1px solid var(--line);border-radius:14px;min-height:320px;background:#fff;overflow:auto;padding:0}
        .view.hidden{display:none}

        /* Report (A4) */
        .report-page{width:210mm;min-height:297mm;margin:0 auto;background:#fff;padding:18mm 16mm;border-radius:8px}
        .report-header{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;margin-bottom:14px}
        .brand{font-weight:900;font-size:18px;letter-spacing:-.3px;color:var(--primary)}
        .brand small{display:block;color:var(--mut);font-weight:600;font-size:12px;margin-top:2px}
        .meta{font-size:12px;color:var(--mut)}
        .section{margin:18px 0 0}
        .section h3{margin:0 0 10px;font-size:16px;letter-spacing:-.2px}
        table{width:100%;border-collapse:separate;border-spacing:0;font-size:12px}
        thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);text-align:left;padding:9px 10px;font-weight:800}
        tbody td{border-bottom:1px solid var(--line);padding:9px 10px}
        tbody tr:nth-child(odd){background:var(--zebra)}
        .muted{ color: var(--mut); }
        .tag{display:inline-flex;gap:6px;padding:3px 10px;border-radius:999px;font-weight:800;font-size:11px;border:1px solid var(--line)}
        .tag.ok  { color:#065f46; background:#ecfdf5; border-color:#d1fae5; }
        .tag.high{ color:#991b1b; background:#fef2f2; border-color:#fee2e2; }
        .tag.low { color:#0c4a6e; background:#eff6ff; border-color:#dbeafe; }
        .pet-card{display:grid;grid-template-columns:92px 1fr;gap:8px 14px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,#f8fafc,#fff)}
        .card-soft{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fcfcff}
        .md{font-size:13px;color:#111}
        .md h1,.md h2,.md h3{margin:14px 0 8px}
        .md p{margin:6px 0}
        .md ul{margin:6px 0 6px 18px}

        /* ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ */
        .doc-top{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:6px}
        .doc-list{border:1px solid var(--line);border-radius:12px;overflow:hidden}
        .doc-item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer;background:#fff}
        .doc-item:nth-child(odd){background:var(--zebra)}
        .doc-item:hover{background:#eef2ff}
        .doc-item.active{outline:2px solid #c7d2fe;background:#eef2ff}
        .doc-title{font-weight:800}
        .doc-meta{font-size:12px;color:var(--mut)}
        .empty{padding:12px;color:var(--mut)}
        .editbox{display:none;gap:6px;margin-top:6px}
        .editbox input{padding:6px 8px;border:1px solid var(--line);border-radius:8px;font:inherit}
        .actions{display:flex;gap:6px}

        @media print{
            body{background:#fff}
            .grid{display:block}
            .card{box-shadow:none}
            .tabs{display:none}
            .view{border:0}
            .report-page{border-radius:0;padding:12mm 12mm}
            thead th{position:static}
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="row" style="margin-bottom:8px">
        <h1>ë³´í˜¸ì ë¦¬í¬íŠ¸</h1>
        <span class="status" id="status"></span>
    </div>

    <div class="grid">
        <!-- ì¢Œì¸¡: ë¬¸ì„œ ëª©ë¡(ë³‘ì›ëª… ì¸ë¼ì¸ ìˆ˜ì •) -->
        <section class="card">
            <div class="doc-top">
                <h3 style="margin:0">ë¬¸ì„œ ëª©ë¡</h3>
                <span id="docCount" class="hint"></span>
            </div>
            <div id="docList" class="doc-list">
                <div class="empty">URLì— <b>?petId=1</b>ì²˜ëŸ¼ ì ‘ì†í•˜ë©´ ëª©ë¡ì´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.</div>
            </div>
        </section>

        <!-- ìš°ì¸¡: ì¶œë ¥ -->
        <section class="card">
            <div class="row" style="justify-content:space-between;margin-bottom:6px">
                <div class="row" style="gap:10px">
                    <h3 style="margin:0">ì¶œë ¥</h3>
                    <div class="tabs">
                        <div class="tab active" data-tab="report">Report</div>
                        <div class="tab" data-tab="md">Markdown</div>
                    </div>
                </div>
                <div class="row" style="gap:8px">
                    <button class="secondary" id="btnPdf" disabled>PDFë¡œ ì €ì¥</button>
                </div>
            </div>

            <div id="view-report" class="view"><div id="reportRoot" class="report-page"></div></div>
            <div id="view-md" class="view hidden"><div class="muted" style="padding:14px">ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
        </section>
    </div>
</div>

<script>
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const reportRoot = $('#reportRoot');
    const btnPdf = $('#btnPdf');

    const API = {
        list: (petId) => `/usr/pet/lab-docs?petId=${petId}&page=1&pageSize=100`,
        structured: (id) => `/api/ai/doc/${id}/structured`,
        explain: (id) => `/api/ai/doc/${id}/explain?detailed=true`,
    };

    function toast(msg, err){ statusEl.innerHTML = (err?'âš ï¸ ':'âœ… ') + msg; setTimeout(()=>statusEl.innerHTML='', 2200); }
    function setBusy(b, t){ statusEl.innerHTML = b ? `<span class="spinner"></span> ${t||'ë¡œë”© ì¤‘...'}` : ''; }
    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function txt(s){ return escapeHtml(s==null? '' : String(s)); }
    function switchTab(which){
        const views = {report: '#view-report', md:'#view-md'};
        Object.entries(views).forEach(([k,sel])=>{
            const el = $(sel);
            el.classList.toggle('hidden', k!==which);
        });
        document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===which));
    }
    document.querySelector('.tab[data-tab="report"]').onclick=()=>switchTab('report');
    document.querySelector('.tab[data-tab="md"]').onclick=()=>switchTab('md');

    function renderMarkdown(md){
        const viewMd = $('#view-md');
        if (window.marked && typeof marked.parse==='function') viewMd.innerHTML = marked.parse(md||'');
        else viewMd.innerHTML = '<pre style="padding:14px">'+escapeHtml(md||'')+'</pre>';
    }

    // í˜„ì¬ ë¬¸ì„œ ìºì‹œ
    const CURRENT = { id: null, structured: null, md: '' };

    // ë‚˜ì´ í‘œì‹œ
    function formatAge(pet, refDate){
        if (!pet) return '-';
        let y = toInt(pet.age);
        let m = toInt(pet.ageMonths ?? pet.age_months);
        if ((y == null || m == null) && pet.birthDate){
            const ref = refDate ? new Date(refDate) : new Date();
            const b   = new Date(pet.birthDate);
            if (!isNaN(b)) {
                let months = (ref.getFullYear()-b.getFullYear())*12 + (ref.getMonth()-b.getMonth());
                if (ref.getDate() < b.getDate()) months -= 1;
                if (months < 0) months = 0;
                if (y == null) y = Math.floor(months/12);
                if (m == null) m = months % 12;
            }
        }
        y = Math.max(0, y ?? 0); if (m != null) m = Math.max(0, Math.min(11, m));
        if ((y === 0 || pet.age == null) && (m ?? 0) > 0) return `${m}ê°œì›”`;
        if ((m ?? 0) > 0) return `${y}ì„¸ ${m}ê°œì›”`;
        return (pet.age == null ? '-' : `${y}ì„¸`);
        function toInt(v){ const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : null; }
    }

    function renderReport(obj, md){
        obj = obj||{};
        const doc  = obj.document||{};
        const pet  = obj.pet||{};
        const labs = Array.isArray(obj.labs)? obj.labs : [];
        const notes = (obj.meta&&obj.meta.notes)||'';

        const rows = labs.map(l=>{
            const lo  = (l.ref_low  ?? l.refLow  ?? null);  const loN = (lo!==null && lo!=='') ? Number(lo) : null;
            const hi  = (l.ref_high ?? l.refHigh ?? null);  const hiN = (hi!==null && hi!=='') ? Number(hi) : null;
            const val = (l.value    ?? null);               const vN  = (val!==null && val!=='')? Number(val): null;
            let flag='ok';
            if (vN!=null && (loN!=null || hiN!=null)){
                if (hiN!=null && vN>hiN) flag='high';
                else if (loN!=null && vN<loN) flag='low';
            }
            return { name:l.name||l.code||'', value:vN, unit:l.unit||'', lo:loN, hi:hiN, flag };
        });
        const abn = rows.filter(r=>r.flag!=='ok');
        const abnText = abn.length
            ? abn.map(r=>`${r.name}${r.value!=null?' '+r.value.toLocaleString():''}${r.unit?' '+r.unit:''} (${r.flag==='high'?'ìƒìŠ¹':'ì €í•˜'})`).join(', ')
            : 'íŠ¹ì´ ì†Œê²¬ ì—†ìŒ';

        const mdHtml = (window.marked && typeof marked.parse==='function') ? marked.parse(md||'') : '<pre>'+escapeHtml(md||'')+'</pre>';

        const now = new Date();
        const generatedAt = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

        reportRoot.innerHTML = `
      <div class="report-header">
        <div>
          <div class="brand">Aniwell Report<small>ë°˜ë ¤ë™ë¬¼ ë³´í˜¸ì ì„¤ëª…ì„œ</small></div>
          <div class="meta" style="margin-top:6px">
            ì˜ë£Œê¸°ê´€: <b id="providerName">${txt(doc.provider||'-')}</b><br/>
            ë¬¸ì„œì¼ì: ${txt(doc.date||'-')} Â· ìƒì„±ì‹œê°: ${txt(generatedAt)}
          </div>
        </div>
        <div class="pet-card">
          <div>ì´ë¦„</div><div>${txt(pet.name||'-')}</div>
          <div>ì¢…</div><div>${txt(pet.species||'-')}</div>
          <div>ë‚˜ì´</div><div>${formatAge(pet, doc.date)}</div>
          <div>ì„±ë³„</div><div>${txt(pet.sex||'-')}</div>
        </div>
      </div>

      <div class="section">
        <h3>ìš”ì•½</h3>
        <div class="card-soft" style="display:grid;grid-template-columns:120px 1fr;gap:8px 14px">
          <div><b>ì´ìƒ ê°œìˆ˜</b></div>
          <div>
            ${abn.length ? `<span class="tag high">ì´ìƒ ${abn.length}ê°œ</span>` : `<span class="tag ok">íŠ¹ì´ ì†Œê²¬ ì—†ìŒ</span>`}
            <span class="tag">ì´ ${rows.length}í•­ëª©</span>
          </div>
          <div><b>ì´ìƒ í•­ëª©</b></div><div>${txt(abnText)}</div>
          <div><b>ë©”ëª¨</b></div><div>${txt(notes||'-')}</div>
        </div>
      </div>

      <div class="section">
        <h3>ê²€ì‚¬ ê²°ê³¼</h3>
        ${rows.length ? `
        <div style="border:1px solid var(--line);border-radius:12px;overflow:hidden">
          <table>
            <thead>
              <tr>
                <th style="width:28%">í•­ëª©</th>
                <th style="width:18%">ê²°ê³¼</th>
                <th style="width:22%">ì°¸ê³ ë²”ìœ„</th>
                <th style="width:14%">íŒì •</th>
                <th>ë¹„ê³ </th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>{
            const ref = (r.lo!=null? r.lo.toLocaleString():'â€“') + ' ~ ' + (r.hi!=null? r.hi.toLocaleString():'â€“');
            const val = (r.value!=null? r.value.toLocaleString() + (r.unit? ' '+txt(r.unit):'') : '-');
            const badge = r.flag==='ok' ? '<span class="tag ok">ì •ìƒ</span>' : (r.flag==='high' ? '<span class="tag high">ìƒìŠ¹</span>' : '<span class="tag low">ì €í•˜</span>');
            return `
                  <tr>
                    <td>${txt(r.name)}</td>
                    <td>${val}</td>
                    <td>${ref}</td>
                    <td>${badge}</td>
                    <td class="muted"></td>
                  </tr>`;
        }).join('')}
            </tbody>
          </table>
        </div>` : `<div class="muted">í‘œì‹œí•  ê²€ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`}
      </div>

      <div class="section">
        <h3>AI ì„¤ëª…(ì‰¬ìš´ ì•ˆë‚´ì„œ)</h3>
        <div class="md">${mdHtml || '<div class="muted">AI ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'}</div>
        <div class="muted" style="margin-top:8px">â€» ë³¸ ë¬¸ì„œëŠ” ë³´í˜¸ì ì´í•´ë¥¼ ë•ê¸° ìœ„í•œ ì„¤ëª… ìë£Œì´ë©°, ìµœì¢… ì˜í•™ì  íŒë‹¨ì€ ë‹´ë‹¹ ìˆ˜ì˜ì‚¬ì˜ ì†Œê²¬ì„ ë”°ë¦…ë‹ˆë‹¤.</div>
      </div>
    `;
    }

    // ëª©ë¡ ë©”íƒ€(ë³‘ì›/ë‚ ì§œ ë³´ì™„)
    const DOC_META = new Map();

    async function loadDocsForPet(petId){
        if(!petId){ return; }
        setBusy(true, 'ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
        try{
            const payload = await fetch(API.list(petId)).then(r=>r.json());
            const rows = normalizeRows(payload);
            renderDocList(rows);
            $('#docCount').textContent = rows.length ? `ì´ ${rows.length}ê±´` : '';
            toast(`ëª©ë¡ ë¡œë“œ ì™„ë£Œ (${rows.length}ê±´)`);
        }catch(e){
            $('#docList').innerHTML = `<div class="empty">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(e)}</div>`;
            toast('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', true);
        }finally{
            setBusy(false);
        }
    }

    function normalizeRows(p){
        if (Array.isArray(p)) return p;
        if (p?.data?.rows) return p.data.rows;
        if (Array.isArray(p?.data)) return p.data;
        if (p?.rows) return p.rows;
        if (p?.result) return Array.isArray(p.result) ? p.result : [];
        return [];
    }

    function renderDocList(items){
        const box = $('#docList');
        if(!items || !items.length){
            box.innerHTML = `<div class="empty">í•´ë‹¹ í«ì˜ lab ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return;
        }

        box.innerHTML = items.map(raw=>{
            const it = {
                documentId: raw.documentId ?? raw.id ?? raw.document_id,
                visitId:    raw.visitId    ?? raw.visit_id,
                docType:    raw.docType    ?? raw.doc_type,
                fileUrl:    raw.fileUrl    ?? raw.file_url,
                hospitalName: raw.hospitalName ?? raw.hospital,
                visitDate:    raw.visitDate    ?? raw.visit_date ?? raw.visited_at
            };

            DOC_META.set(String(it.documentId), { hospitalName: it.hospitalName, visitDate: it.visitDate });

            const dateText = it.visitDate ? String(it.visitDate).slice(0,10) : '-'; // ë‚ ì§œë§Œ
            const title = `[${dateText}] <span class="hospital" data-id="${it.documentId}">${txt(it.hospitalName || 'ë³‘ì› ë¯¸ìƒ')}</span>`;

            return `
        <div class="doc-item" data-id="${it.documentId}">
          <div>
            <div class="doc-title">${title}
              <button class="secondary small edit-btn" data-id="${it.documentId}">ìˆ˜ì •</button>
            </div>
            <div class="doc-meta">ë¬¸ì„œ #${it.documentId} Â· visitId: ${it.visitId}</div>
            <div class="editbox" data-id="${it.documentId}">
              <input class="edit-input" data-id="${it.documentId}" type="text" value="${txt(it.hospitalName || '')}" placeholder="ë³‘ì›ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"/>
              <div class="actions">
                <button class="small save-btn" data-id="${it.documentId}">ì €ì¥</button>
                <button class="secondary small cancel-btn" data-id="${it.documentId}">ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
          <div class="doc-meta">${txt(it.docType || '')}</div>
        </div>`;
        }).join('');

        // ì´ë²¤íŠ¸ ìœ„ì„: í•œ ë²ˆ í´ë¦­ìœ¼ë¡œ ë¬¸ì„œ ì—´ë¦¼, ìˆ˜ì • UIëŠ” ì „íŒŒ ë§‰ìŒ
        box.onclick = (e)=>{
            const t = e.target;

            // ìˆ˜ì •/ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ ì²˜ë¦¬ (ë¬¸ì„œ ì—´ê¸° ì „íŒŒ ë§‰ê¸°)
            if (t.classList.contains('edit-btn')) {
                e.stopPropagation();
                const id = t.dataset.id;
                const eb = box.querySelector(`.editbox[data-id="${id}"]`);
                eb.style.display = 'flex';
                const inp = eb.querySelector('.edit-input');
                inp.focus();
                return;
            }
            if (t.classList.contains('save-btn')) {
                e.stopPropagation();
                const id = t.dataset.id;
                const eb = box.querySelector(`.editbox[data-id="${id}"]`);
                const inp = eb.querySelector('.edit-input');
                const name = inp.value.trim();
                // DOC_META ê°±ì‹ 
                const meta = DOC_META.get(String(id)) || {};
                meta.hospitalName = name;
                DOC_META.set(String(id), meta);
                // ë¦¬ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ê°±ì‹ 
                const label = box.querySelector(`.hospital[data-id="${id}"]`);
                if (label) label.textContent = name || 'ë³‘ì› ë¯¸ìƒ';
                eb.style.display = 'none';

                // í˜„ì¬ ì—´ë ¤ ìˆëŠ” ë¦¬í¬íŠ¸ë„ ê°±ì‹ 
                if (String(CURRENT.id) === String(id) && CURRENT.structured) {
                    CURRENT.structured.document = CURRENT.structured.document || {};
                    CURRENT.structured.document.provider = name || null;
                    renderReport(CURRENT.structured, CURRENT.md);
                }
                toast('ë³‘ì›ëª…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            if (t.classList.contains('cancel-btn')) {
                e.stopPropagation();
                const id = t.dataset.id;
                const eb = box.querySelector(`.editbox[data-id="${id}"]`);
                eb.style.display = 'none';
                return;
            }
            if (t.closest('.editbox')) {
                // í¸ì§‘ ì˜ì—­ ë‚´ë¶€ í´ë¦­ì€ ë¬¸ì„œ ì—´ê¸° ë°©ì§€
                e.stopPropagation();
                return;
            }

            // ğŸ‘‰ ì¼ë°˜ ì•„ì´í…œ í´ë¦­: ì¦‰ì‹œ ë¬¸ì„œ ì—´ê¸°(í•œ ë²ˆ í´ë¦­)
            const item = t.closest('.doc-item');
            if(item){ loadDoc(item.dataset.id); }
        };

        // í¸ì§‘ ì¸í’‹: Enter ì €ì¥, Esc ì·¨ì†Œ
        box.addEventListener('keydown', (e)=>{
            const inp = e.target;
            if (!inp.classList || !inp.classList.contains('edit-input')) return;
            const id = inp.dataset.id;
            if (e.key === 'Enter') {
                const saveBtn = box.querySelector(`.save-btn[data-id="${id}"]`);
                saveBtn?.click();
            } else if (e.key === 'Escape') {
                const cancelBtn = box.querySelector(`.cancel-btn[data-id="${id}"]`);
                cancelBtn?.click();
            }
        });
    }

    function norm(x){ return (x && typeof x==='object' && 'data' in x) ? x.data : x; }

    async function loadDoc(id){
        document.querySelectorAll('.doc-item').forEach(el=>el.classList.toggle('active', el.dataset.id==String(id)));
        setBusy(true,'ë¬¸ì„œ ë¡œë”© ì¤‘â€¦');

        try {
            // 1) structured
            const r1 = await fetch(API.structured(id));
            if(!r1.ok) throw new Error(`structured HTTP ${r1.status}`);
            let structured = norm(await r1.json());

            // ëª©ë¡ ë©”íƒ€ ë³´ì™„
            const meta = DOC_META.get(String(id)) || {};
            structured.document = structured.document || {};
            if(!structured.document.provider && meta.hospitalName){ structured.document.provider = meta.hospitalName; }
            if(!structured.document.date && meta.visitDate){ structured.document.date = String(meta.visitDate).slice(0,10); }

            // 2) explain(ì‹¤íŒ¨í•´ë„ ë Œë”)
            let md = '';
            try{
                const r2 = await fetch(API.explain(id));
                if(r2.ok){
                    const ex = norm(await r2.json());
                    md = ex?.markdown || '';
                }else{
                    console.warn('explain failed', r2.status);
                    toast(`ì„¤ëª… ë¡œë“œ ì‹¤íŒ¨(${r2.status})`, true);
                }
            }catch(e){
                console.warn('explain error', e);
                toast('ì„¤ëª… ë¡œë“œ ì‹¤íŒ¨', true);
            }

            // ìºì‹œ ë° ë Œë”
            CURRENT.id = id;
            CURRENT.structured = structured;
            CURRENT.md = md;

            renderMarkdown(md);
            renderReport(structured, md);
            btnPdf.disabled = !md || !md.trim().length ? true : false;

            switchTab('report');
            toast('ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ');
        } catch(e){
            console.error(e);
            toast('ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨: '+e.message, true);
        } finally {
            setBusy(false);
        }
    }

    btnPdf.onclick = async ()=>{
        if(!window.html2pdf){ toast('PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘', true); return; }
        switchTab('report');
        const obj = CURRENT.structured || {};
        const provider = (obj.document&&obj.document.provider)||'Report';
        const date = (obj.document&&obj.document.date)||new Date().toISOString().slice(0,10);
        const fileName = `${provider}_${date}_ì„¤ëª…ì„œ.pdf`.replace(/[^\wê°€-í£_.-]+/g,'_');

        const opt = {
            margin: [0,0,0,0],
            filename: fileName,
            image: { type:'jpeg', quality:0.98 },
            html2canvas: { scale: 2.5, useCORS: true },
            jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
            pagebreak: { mode: ['css','legacy'] }
        };
        await html2pdf().from(reportRoot).set(opt).save();
    };

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìë™ ë¡œë“œ
    (function initFromQuery(){
        const p=new URLSearchParams(location.search);
        const petId=p.get('petId');
        const docId=p.get('docId');
        if(petId){
            loadDocsForPet(Number(petId)).then(()=>{ if(docId){ loadDoc(Number(docId)); } });
        }
    })();
</script>
</body>
</html>
