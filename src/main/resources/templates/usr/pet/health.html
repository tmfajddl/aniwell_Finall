<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì‚¬ë£Œ ë¬´ê²Œ ë³€í™”ëŸ‰ ì°¨íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fdfae9; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #datePicker { margin-bottom: 1rem; }
  </style>
</head>
<body>
<h2>ì‚¬ë£Œ ë¬´ê²Œ ë³€í™”ëŸ‰</h2>

<!-- ë‚ ì§œ ì„ íƒ -->
<input type="date" id="datePicker" th:value="${#temporals.format(today, 'yyyy-MM-dd')}" />

<!-- ì°¨íŠ¸ -->
<canvas id="weightChart" width="800" height="400"></canvas>

<script th:inline="javascript">
  const petId = /*[[${petId}]]*/ 0;
  const todayStr = new Date().toISOString().split("T")[0];
  const dateInput = document.getElementById("datePicker");

  const labels = [];
  const deltas = [];
  const bgColors = [];
  const tooltipLabels = [];
  const rawData = [];
  let weightChart = null;
  let stompClient = null;
  let subscription = null;

  const ctx = document.getElementById('weightChart').getContext('2d');

  function renderChart(data) {
    labels.length = deltas.length = bgColors.length = tooltipLabels.length = 0;
    rawData.length = 0;

    if (!Array.isArray(data)) {
      console.error("âŒ ì„œë²„ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", data);
      alert("ë°ì´í„° í˜•ì‹ì´ ìž˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }

    rawData.push(...data);
    data.sort((a, b) => new Date(a.logDate) - new Date(b.logDate));

    for (let i = 1; i < data.length; i++) {
      const prev = data[i - 1];
      const curr = data[i];
      const diff = parseFloat(curr.foodWeight) - parseFloat(prev.foodWeight);
      const absDiff = Math.abs(diff).toFixed(2);
      const label = new Date(curr.logDate).toTimeString().slice(0, 5);

      labels.push(label);
      deltas.push(absDiff);
      const color = diff < 0 ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 165, 0, 0.2)';
      bgColors.push(color);
      tooltipLabels.push(diff < 0 ? `ì„­ì·¨: ${absDiff}g` : `ê¸‰ì‹: ${absDiff}g`);
    }

    if (!weightChart) {
      weightChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ì‚¬ë£Œ ë³€í™”ëŸ‰ (ì ˆëŒ€ê°’)',
            data: deltas,
            backgroundColor: bgColors,
            borderColor: bgColors.map(c => c.replace('0.2', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: false,
          scales: {
            y: { title: { display: true, text: 'g' }},
            x: { title: { display: true, text: 'ì‹œê°„ (HH:MM)' }}
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => tooltipLabels[context.dataIndex]
              }
            }
          }
        }
      });
    } else {
      weightChart.data.labels = labels;
      weightChart.data.datasets[0].data = deltas;
      weightChart.data.datasets[0].backgroundColor = bgColors;
      weightChart.data.datasets[0].borderColor = bgColors.map(c => c.replace('0.2', '1'));
      weightChart.update();
    }
  }

  function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
      console.log('ðŸ”Œ WebSocket ì—°ê²°ë¨');
      subscription = stompClient.subscribe(`/topic/health/${petId}`, (message) => {
        const newLog = JSON.parse(message.body);
        updateChartWithNewLog(newLog);
      });
    });
  }

  function disconnectWebSocket() {
    if (subscription) subscription.unsubscribe();
    if (stompClient) stompClient.disconnect();
  }

  function updateChartWithNewLog(newLog) {
    const last = rawData[rawData.length - 1];
    const diff = parseFloat(newLog.foodWeight) - parseFloat(last.foodWeight);
    const absDiff = Math.abs(diff).toFixed(2);
    const timeLabel = new Date(newLog.logDate).toTimeString().slice(0, 5);

    rawData.push(newLog);
    labels.push(timeLabel);
    deltas.push(absDiff);
    const color = diff < 0 ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 165, 0, 0.2)';
    bgColors.push(color);
    tooltipLabels.push(diff < 0 ? `ì„­ì·¨: ${absDiff}g` : `ê¸‰ì‹: ${absDiff}g`);

    weightChart.update();
  }

  function loadDataAndDraw(dateStr) {
    if (!dateStr) dateStr = todayStr;

    fetch(`/usr/pet/health/logs?petId=${petId}&date=${dateStr}`)
            .then(res => {
              if (!res.ok) {
                throw new Error("404 ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜");
              }
              return res.json();
            })
            .then(data => {
              renderChart(data);
              if (dateStr === todayStr) {
                connectWebSocket();
              } else {
                disconnectWebSocket();
              }
            })
            .catch(err => {
              console.error("ðŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
              alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            });
  }

  // âœ… ì´ˆê¸° ì‹¤í–‰
  window.addEventListener("DOMContentLoaded", () => {
    loadDataAndDraw(dateInput?.value || todayStr);

    dateInput.addEventListener("change", () => {
      disconnectWebSocket();
      loadDataAndDraw(dateInput.value);
    });
  });
</script>
</body>
</html>
