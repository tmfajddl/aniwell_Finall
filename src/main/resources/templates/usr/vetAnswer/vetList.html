<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>ìˆ˜ì˜ì‚¬ ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸</title>
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" th:href="@{/resource/css/common.css}">
	<link rel="stylesheet" th:href="@{/resource/css/global.css}">

</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9]">
	<div class="flex h-screen">
		<!-- Sidebar -->
		<div th:replace="common :: siteHeader"></div>

		<!-- Main content -->
		<main class="main_page min-h-screen flex-1 p-6 grid grid-cols-12 gap-4">

			<!-- âœ… ìƒë‹¨ ì œëª© -->
			<div class="col-span-12">
				<h1 class="text-3xl font-bold text-lime-800">ğŸ©º ìˆ˜ì˜ì‚¬ìš© ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸</h1>
			</div>

			<div class="col-span-6 space-y-4 overflow-y-auto h-[600px]">
				<h2 class="text-xl font-bold text-yellow-600 mb-2">ğŸ“– ë¯¸ë‹µë³€ ì§ˆë¬¸ ëª©ë¡</h2>
				<div th:each="qna : ${questions}" th:data-id="${qna.id}" th:data-title="${qna.title}"
					th:data-body="${qna.body}" th:data-answer="${qna.answer}" th:data-answered="${qna.answered}"
					th:classappend="${qna.answered} ? 'bg-yellow-50' : 'bg-yellow-50'" data-owner="others"
					class="rounded-xl shadow-md p-4 flex items-center justify-between hover:shadow-lg transition qna-item cursor-pointer">

					<div>
						<h3 class="text-lg font-semibold text-gray-800" th:text="${qna.title}">ì§ˆë¬¸ ì œëª©</h3>
						<p class="text-sm text-gray-600" th:text="'ì‘ì„±ì: ' + ${qna.memberName} + ' Â· ' + ${qna.regDate}">
							ì‘ì„±ì/ë‚ ì§œ</p>
					</div>
					<div>
						<span th:if="${qna.answered}"
							class="text-xs bg-green-200 text-green-800 px-3 py-1 rounded-full font-bold">ë‹µë³€ ì™„ë£Œ</span>
						<span th:unless="${qna.answered}"
							class="text-xs bg-red-200 text-red-800 px-3 py-1 rounded-full font-bold">ë¯¸ë‹µë³€</span>
					</div>
				</div>
				<div th:if="${#lists.isEmpty(questions)}" class="text-center text-gray-500 mt-4">
					ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
				</div>
			</div>


			<!-- âœ… ìš°ì¸¡: ë‚´ê°€ ë‹µë³€í•œ ì§ˆë¬¸ -->
			<div class="col-span-6 space-y-4 overflow-y-auto h-[600px]">
				<h2 class="text-xl font-bold text-yellow-600 mb-2">ğŸ™‹ ë‚´ê°€ ë‹µë³€í•œ ì§ˆë¬¸</h2>
				<div th:each="qna : ${myAnsweredQnas}"
					th:attr="data-id=${qna.id}, data-title=${qna.title}, data-body=${qna.body}, data-answer=${qna.answer}, data-answered=${qna.answered}, data-owner='mine'"
					class="qna-item rounded-xl shadow-md p-4 flex items-center justify-between bg-yellow-50 hover:shadow-lg transition">

					<div>
						<h3 class="text-lg font-semibold text-gray-800" th:text="${qna.title}">ì§ˆë¬¸ ì œëª©</h3>
						<p class="text-sm text-gray-600" th:text="${qna.regDate}">ë‚ ì§œ</p>
					</div>
					<div>
						<span class="text-xs bg-green-200 text-green-800 px-3 py-1 rounded-full font-bold">ë‹µë³€ ì™„ë£Œ</span>
					</div>
				</div>
				<div th:if="${#lists.isEmpty(myAnsweredQnas)}" class="text-center text-gray-500 mt-4">
					ë‹µë³€í•œ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
				</div>
			</div>

			<!-- âœ… QnA ìƒì„¸ ëª¨ë‹¬ -->
			<div id="qna-detail-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
				<div class="bg-white w-full max-w-xl rounded-xl shadow-xl p-6 relative">
					<button onclick="hideQnaModal()"
						class="absolute top-2 right-3 text-gray-500 hover:text-black text-2xl">&times;</button>

					<h2 class="text-2xl font-bold mb-4">ğŸ™‹ ì§ˆë¬¸ ìƒì„¸</h2>

					<input type="hidden" id="modal-qna-id">
					<input type="hidden" id="answer-id">

					<label class="font-semibold">ì œëª©</label>
					<input type="text" id="modal-qna-title" class="w-full p-2 rounded bg-gray-100 mb-3" readonly>

					<label class="font-semibold">ë‚´ìš©</label>
					<textarea id="modal-qna-body" class="w-full p-2 rounded bg-gray-100 mb-3" rows="4"
						readonly></textarea>

					<div id="vet-answer-area" class="mb-3 hidden">
						<label class="font-semibold">ğŸ’¬ ìˆ˜ì˜ì‚¬ ë‹µë³€</label>
						<textarea id="modal-qna-answer" class="w-full p-2 rounded bg-gray-100" readonly
							rows="2"></textarea>

					</div>

					<div class="flex items-center gap-2 mt-4">
						<input type="hidden" id="modal-qna-answered" disabled>
						<!-- ìƒíƒœ í…ìŠ¤íŠ¸ -->
						<div id="answer-status-badge" class="mt-4 text-lg"></div>

					</div>

					<div class="flex justify-end gap-2 mt-6">
						<button id="modal-answer-create"
							class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded hidden">ë“±ë¡</button>
						<button id="modal-answer-update"
							class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded hidden">ìˆ˜ì •</button>
						<button id="modal-answer-delete"
							class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">ì‚­ì œ</button>
					</div>

				</div>
			</div>


			<script>

				document.querySelectorAll('.qna-item').forEach(item => {
					item.addEventListener('click', () => {
						const id = item.dataset.id;
						const title = item.dataset.title;
						const body = item.dataset.body;
						const answer = item.dataset.answer;
						const answered = item.dataset.answered === 'true';

						showQnaDetailModal(id, title, body, answer, answered);
					});
				});
				function showQnaDetailModal(id, title, body, answer, answered, owner = 'others') {
					document.getElementById('answer-id').value = answer?.id ?? '';
					document.getElementById('modal-qna-id').value = id;
					document.getElementById('modal-qna-title').value = title;
					document.getElementById('modal-qna-body').value = body;
					document.getElementById('modal-qna-answered').checked = answered;

					const answerArea = document.getElementById('vet-answer-area');
					const answerBox = document.getElementById('modal-qna-answer');
					const createBtn = document.getElementById('modal-answer-create');
					const updateBtn = document.getElementById('modal-answer-update');
					const deleteBtn = document.getElementById('modal-answer-delete');
					const statusBadge = document.getElementById('answer-status-badge'); // âœ… ìƒíƒœ í…ìŠ¤íŠ¸ ì˜ì—­

					// ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ
					if (statusBadge) {
						if (answered) {
							statusBadge.innerHTML = 'âœ… <span class="font-medium text-green-700">ë‹µë³€ ì™„ë£Œ</span>';
						} else {
							statusBadge.innerHTML = 'â³ <span class="font-medium text-gray-700">ë‹µë³€ ëŒ€ê¸°</span>';
						}
					}

					// ê¸°ë³¸ ìƒíƒœ ì´ˆê¸°í™”
					createBtn.classList.add('hidden');
					updateBtn.classList.add('hidden');
					deleteBtn.classList.add('hidden');
					answerArea.classList.remove('hidden');

					if (owner === 'mine') {
						// ë‚´ê°€ ì‘ì„±í•œ ë‹µë³€ â†’ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
						answerBox.value = answer?.content ?? answer ?? ''; // ê°ì²´ì¼ ê²½ìš° ëŒ€ë¹„
						updateBtn.classList.remove('hidden');
						deleteBtn.classList.remove('hidden');
					} else {
						// ë¯¸ë‹µë³€ â†’ ë“±ë¡ë§Œ ê°€ëŠ¥
						answerBox.value = '';
						answerArea.classList.add('hidden');
						createBtn.classList.remove('hidden');
					}

					document.getElementById('qna-detail-modal').classList.remove('hidden');
				}




				document.querySelectorAll('.qna-item').forEach(item => {
					item.addEventListener('click', () => {
						const id = item.dataset.id;
						const title = item.dataset.title;
						const body = item.dataset.body;
						const answer = item.dataset.answer;
						const answered = item.dataset.answered === 'true';
						const owner = item.dataset.owner; // 'mine' or 'others'

						showQnaDetailModal(id, title, body, answer, answered, owner);
					});
				});


				function hideQnaModal() {
					document.getElementById('qna-detail-modal').classList.add('hidden');
				}

				let isRegisteringAnswer = false;

				document.getElementById('modal-answer-create').addEventListener('click', () => {
					const answerBox = document.getElementById('modal-qna-answer');
					const answerArea = document.getElementById('vet-answer-area');

					// ìµœì´ˆ í´ë¦­ ì‹œ textarea ë³´ì´ê¸°
					if (!isRegisteringAnswer) {
						answerArea.classList.remove('hidden');
						answerBox.removeAttribute('readonly');
						answerBox.classList.remove('bg-gray-100');
						answerBox.classList.add('bg-white');
						answerBox.focus();

						isRegisteringAnswer = true;
						return; // ë‘ ë²ˆì§¸ í´ë¦­ ì‹œ ì „ì†¡
					}

					// ë‘ ë²ˆì§¸ í´ë¦­ ì‹œ: ì„œë²„ ì „ì†¡
					const qnaId = document.getElementById('modal-qna-id').value;
					const answer = answerBox.value.trim();

					if (answer === '') {
						alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					fetch('/usr/vetAnswer/doWrite', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: `qnaId=${encodeURIComponent(qnaId)}&answer=${encodeURIComponent(answer)}`
					})
						.then(res => res.text())
						.then(jsCode => {
							location.reload();
						});
				});

				let isEditingAnswer = false;

				document.getElementById('modal-answer-update').addEventListener('click', () => {
					const answerBox = document.getElementById('modal-qna-answer');
					const updateBtn = document.getElementById('modal-answer-update');
					const qnaId = document.getElementById('modal-qna-id').value;

					// ì²˜ìŒ í´ë¦­ â†’ ìˆ˜ì • ëª¨ë“œ ì§„ì…
					if (!isEditingAnswer) {
						answerBox.removeAttribute('readonly');
						answerBox.classList.remove('bg-gray-100');
						answerBox.classList.add('bg-white');
						answerBox.focus();

						updateBtn.textContent = 'ì €ì¥';
						isEditingAnswer = true;
						return;
					}

					// ë‘ ë²ˆì§¸ í´ë¦­ â†’ ì„œë²„ë¡œ ì €ì¥ ìš”ì²­
					const newAnswer = answerBox.value.trim();

					if (newAnswer === '') {
						alert('ìˆ˜ì •í•  ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
						return;
					}

					const answerId = document.getElementById('answer-id').value;  // âœ… ë‹µë³€ ID

					fetch('/usr/vetAnswer/doModify', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: `qnaId=${encodeURIComponent(qnaId)}&answer=${encodeURIComponent(newAnswer)}`
					})

						.then(res => res.json())
						.then(data => {
							if (data.resultCode === 'S-1') {

								// ìˆ˜ì • ì™„ë£Œ â†’ ë‹¤ì‹œ ì½ê¸° ëª¨ë“œ
								answerBox.setAttribute('readonly', true);
								answerBox.classList.remove('bg-white');
								answerBox.classList.add('bg-gray-100');

								updateBtn.textContent = 'ìˆ˜ì •';
								isEditingAnswer = false;
								location.reload();
							} else {
								alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (data.msg || 'ì„œë²„ ì˜¤ë¥˜'));
							}
						});

				});

				document.getElementById('modal-answer-delete').addEventListener('click', () => {
					const qnaId = document.getElementById('modal-qna-id').value;
					const answer = document.getElementById('modal-qna-answer').value.trim();

					if (!confirm('ì •ë§ ì´ ë‹µë³€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

					fetch('/usr/vetAnswer/doDelete', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: `qnaId=${encodeURIComponent(qnaId)}`
					})

						.then(res => res.json())
						.then(data => {
							if (data.resultCode === 'S-1') {
								location.reload();
							} else {
								alert(data.msg);
							}
						});
				});



			</script>

		</main>

	</div>
</body>

</html>