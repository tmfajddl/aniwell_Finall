<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" th:href="@{/resource/css/common.css}">
<link rel="stylesheet" th:href="@{/resource/css/global.css}">
<title>í¬ë£¨ ëª¨ì§‘ ëª©ë¡</title>
</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] h-screen min-h-dvh min-w-[1400px]">
	<div class="flex h-screen w-full">
		<!-- Sidebar -->
		<div th:replace="~{common :: siteHeader}"></div>

		<!-- Main content -->
		<main class="main_page h-full overflow-y-auto min-h-dvh box-border flex-1 p-3">
			<div class="h-full w-full overflow-hidden">
				<div class="p-3 flex justify-around text-gray-800 grid grid-cols-12">
					<div class="col-span-3 p-3">
						<div id="crewAside"></div>
					</div>
					<div class="p-2 col-span-9 w-full flex flex-col mx-auto">
						<div class="h-[97%]">
							<div class="stickypb">
								<div class="w-full max-w-xl mx-auto">
									<!-- ğŸ”„ ê¸°ì¡´ <form>ì„ <div>ë¡œ ìœ ì§€ -->
									<div class="flex items-center bg-white border border-gray-200 shadow-sm rounded-full px-4 py-2 w-full">
										<!-- âœ… [ìˆ˜ì •] IME ì¡°í•©(í•œê¸€ ì…ë ¥) ì¤‘ Enter ë¬´ì‹œ + ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ + ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì™„ì „ ìœ„ì„ -->
										<input id="searchInput" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
											class="flex-1 text-sm text-gray-800 bg-transparent outline-none placeholder:text-gray-400"
											onkeydown="if(!event.isComposing && event.key==='Enter'){ event.preventDefault(); event.stopPropagation(); document.getElementById('searchBtn').click(); }" />

										<!-- âœ… [ì¶”ê°€] ë²„íŠ¼ì— id ë¶€ì—¬(Enterê°€ ì‹¤ì œë¡œ ì´ ë²„íŠ¼ì„ í´ë¦­í•˜ë„ë¡) -->
										<button id="searchBtn" type="button" class="ml-2 text-gray-500 hover:text-black" onclick="loadCrewList()">ğŸ”</button>
									</div>
								</div>

								<div class="text-center">
									<button onclick="openModal()"
										class="my-6 mb-3 px-7 py-2 rounded-xl text-center font-semibold shadow bg-[#e4f0b9] hover:bg-[#FEEEA4]">
										ë“±ë¡í•˜ê¸°</button>
								</div>
							</div>

							<!-- ëª¨ë‹¬ -->
							<div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-around bg-black bg-opacity-50">
								<div
									class="relative w-[90%] max-w-[1000px] h-[700px] bg-transparent flex rounded-2xl overflow-hidden shadow-2xl">

									<!-- ì™¼ìª½ ì—°ë…¸ë‘ ë°°ê²½ -->
									<div class="w-full h-full flex bg-gradient-to-b from-[#FCE9A3] to-[#E0C878]">
										<div class="w-[5%] text-center">
											<button onclick="closeModal()" class="text-3xl font-light text-gray-600 hover:text-black">&times;</button>
										</div>
										<!-- ì˜¤ë¥¸ìª½ ë‚´ìš© -->
										<div class="relative flex-1 bg-white rounded-l-3xl">
											<!-- ìƒë‹¨ íšŒìƒ‰ ë°” -->
											<div class="px-6 py-4 rounded-tr-2xl flex justify-between items-center">
												<h2 class="text-lg font-bold text-gray-800">í¬ë£¨ ë“±ë¡</h2>

											</div>

											<!-- iframe ë‚´ìš© -->
											<div class="p-4 h-[calc(100%-4rem)] w-[100%]">
												<iframe src="/usr/walkCrew/create" class="h-[100%] w-[100%] p-1 border-none"></iframe>
											</div>
										</div>
									</div>
								</div>
							</div>


							<div class="overflow-y-auto w-full h-[80vh] pb-1 shadow">
								<div id="crewListContainer" class="p-4 space-y-4"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dfd275f49b78960a0458d6f6294cbde2&libraries=services"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>
	navigator.geolocation.getCurrentPosition(async (position) => {
		const { latitude, longitude } = position.coords;
		const geocoder = new kakao.maps.services.Geocoder();

		// âœ… ì¢Œí‘œë¥¼ localStorageì— ì €ì¥
		localStorage.setItem("userLat", latitude);
		localStorage.setItem("userLng", longitude);
		
		geocoder.coord2RegionCode(longitude, latitude, (result, status) => {
			if (status === kakao.maps.services.Status.OK) {
				const city = result[0].region_1depth_name;
				const district = result[0].region_2depth_name;

				// âœ… 'H' íƒ€ì…ì˜ region_3depth_nameì„ ìš°ì„  ì‚¬ìš©
				const dongName = result.find(r => r.region_type === 'H')?.region_3depth_name
				              || result[0].region_3depth_name;
				
				console.log("ğŸ“ ì‹œ:", city, "êµ¬:", district);

				$.ajax({
					type: "GET",
					url: `/usr/walkCrew/getDongs`,
					data: { city, district },
					success: function (response) {
						console.log("âœ… ë™ ë¦¬ìŠ¤íŠ¸:", response);
						const dongs = (response.data && response.data.dongs) || (response.data1 && response.data1.dongs) || [];  // âœ… [ìˆ˜ì •] data/data1 ëª¨ë‘ ëŒ€ì‘

						localStorage.setItem("userCity", city);
						localStorage.setItem("userDistrict", district);
						
						
						// âœ… ì—¬ê¸°ì— ì •ë ¬ ì½”ë“œ ì¶”ê°€
						// âœ… ì• 2ê¸€ì ê¸°ì¤€ ì •ë ¬ ì½”ë“œë¡œ êµì²´
                   const dongPrefix = dongName.substring(0, 2).replace(/\s+/g, '').toLowerCase();

                   dongs.sort((a, b) => {
	               const aPrefix = a.substring(0, 2).replace(/\s+/g, '').toLowerCase();
	               const bPrefix = b.substring(0, 2).replace(/\s+/g, '').toLowerCase();

	               if (aPrefix === dongPrefix && bPrefix !== dongPrefix) return -1;
	               if (aPrefix !== dongPrefix && bPrefix === dongPrefix) return 1;
	               return 0;
                    });

						
						localStorage.setItem("userDongs", JSON.stringify(dongs));
						 localStorage.setItem("userDong", dongName);
						
						console.log("ğŸ” í˜„ì¬ ìœ„ì¹˜ ë™:", dongName);
						console.log("ğŸ“‹ ì •ë ¬ëœ ë™ ë¦¬ìŠ¤íŠ¸:", dongs);

						// âœ… ë™ë„¤ ë²„íŠ¼ HTML ìƒì„± (onclick ì¶”ê°€ë¨)
						const asideHTML = `
						  <aside class="bg-white p-6 shadow mx-auto h-[90%]">
						    <h2 class="text-lg font-semibold mb-4">${city}</h2>
						    <div class="text-xl font-semibold mb-4 border-b border-gray-300 pb-2">${district}</div>
						    <div class="h-[70vh] overflow-y-auto">
						      <ul class="grid grid-cols-2 gap-2 text-sm text-gray-700">
						        ${dongs.map((dong) => `
						          <li>
						            <button
						              class="w-full px-1 py-2 text-left bg-gray-100 hover:bg-yellow-200 rounded-lg transition duration-200 ease-in-out shadow-sm hover:shadow-md"
						              onclick="filterByDong('${dong}')"
						            >
						              ${dong}
						            </button>
						          </li>
						        `).join('')}
						      </ul>
						    </div>
						  </aside>
						`;
						$('#crewAside').html(asideHTML);
					},
					error: function (err) {
						console.error("âŒ ë™ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", err);
					}
				});
			}
		});
	});
</script>

	<script>
	function openModal() {
		document.getElementById('modal').classList.remove('hidden');
	}
	function closeModal() {
		document.getElementById('modal').classList.add('hidden');
	}
</script>

	<script>
  function filterByDong(dong) {
    localStorage.setItem("selectedDong", dong); // ğŸ”¹ ì„ íƒëœ ë™ ì €ì¥
    loadCrewList(); // ğŸ”¹ í•„í„°ë§ëœ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë”©
  }

  // âœ… [ìœ ì§€] ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ ë½
  let __crewLoading = false;

  function loadCrewList(skipDongFilter = false) {

    if (__crewLoading) return;     // â† ì¤‘ë³µ í˜¸ì¶œ ì°¨ë‹¨
    __crewLoading = true;

    /* âœ… [ìˆ˜ì •] ê³µë°± ê²€ìƒ‰ ì²˜ë¦¬ë¥¼ ìœ„í•´ trim ì ìš© */
    let query = ($('#searchInput').val() || '').trim(); // â† [ìˆ˜ì •] ê¸°ì¡´: const query = $('#searchInput').val();

    /* âœ… [ì¶”ê°€] ê²€ìƒ‰ì–´ê°€ ê³µë°±ì´ë©´ ì²« ë¡œë“œ(ì „ì²´ ë¦¬ìŠ¤íŠ¸)ì™€ ë™ì¼í•˜ê²Œ ë™ í•„í„° ì œê±° */
     if (!localStorage.getItem("selectedDong") && query === '') {
  skipDongFilter = true;  }
 
    const dong = skipDongFilter ? '' :
      (localStorage.getItem("selectedDong") || localStorage.getItem("userDong")); // ğŸ”¸ ì„ íƒëœ ë™ ê°€ì ¸ì˜¤ê¸°

    const lat = localStorage.getItem("userLat");
    const lng = localStorage.getItem("userLng");

    
 // âœ… íŒŒë¼ë¯¸í„°ë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±: ë¹„ì–´ ìˆìœ¼ë©´ 'í‚¤ ìì²´'ë¥¼ ë³´ë‚´ì§€ ì•ŠìŒ
    const params = { sortBy: 'createdAt' };
    if (query) params.query = query;                     // ê°’ ìˆì„ ë•Œë§Œ
    if (!skipDongFilter && dong) params.dong = dong;     // ë™ í•„í„° í™œì„± + ê°’ ìˆì„ ë•Œë§Œ
    
    // âœ… ì„œë²„ì— ê²€ìƒ‰ì–´ì™€ ë™ ë‘˜ ë‹¤ ì „ë‹¬
    $.ajax({
      url: '/usr/walkCrew/api/list',
      method: 'GET',
      dataType: 'json',
      data: {
        query: query || '',      // âœ… null ë°©ì§€
        dong: dong || '',        // âœ… null ë°©ì§€
        sortBy: 'createdAt'      // or 'title' / ê¸°ë³¸ ì •ë ¬ ê¸°ì¤€ ëª…ì‹œ
      }, 
      
      /* data: params, */
      
      success: function (response) {
        if (response.resultCode !== 'S-1') {
          alert('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + response.msg);
          return;
        }

        const crewList = (response.data1 && response.data1.crews)
        || (response.data && response.data.crews)
        || [];
        const container = $('#crewListContainer');
        container.empty();

        if (crewList.length === 0) {
          container.append('<p class="text-center text-gray-400">ë“±ë¡ëœ í¬ë£¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
          return;
        }

        crewList.forEach(crew => {
          const formattedDate = new Date(crew.createdAt).toLocaleDateString('ko-KR');

          // âœ… ì´ë¯¸ì§€ ì¶œë ¥ ì²˜ë¦¬
          const thumbnail = crew.imageUrl
            ? `<img src="${crew.imageUrl}" alt="í¬ë£¨ ì´ë¯¸ì§€" class="w-20 h-20 object-cover rounded-md shrink-0">`
            : `<div class="w-20 h-20 bg-center bg-cover rounded-md shrink-0"
                   style="background-image: url('/img/default-pet.png');"></div>`;

          const html = `
          <div class="bg-white rounded-lg shadow p-4 flex gap-4 items-start cursor-pointer"
               onclick="location.href='/usr/crewCafe/cafeHome?crewId=${crew.id}'">
            ${thumbnail}
            <div class="flex-1 space-y-2">
              <h3 class="text-lg font-bold">${crew.title}</h3>
              <p class="text-sm text-gray-700">${crew.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
              <div class="flex justify-between items-center gap-1 text-sm text-gray-600">
                <div>${crew.city || ''} ${crew.district || ''} ${crew.dong || ''}</div>
                <div class="text-xs text-gray-400">ì‘ì„±ì: ${crew.nickname || 'ìµëª…'} Â· ${formattedDate}</div>
              </div>
            </div>
          </div>`;
          container.append(html);
        });
      },
      error: function (err) {
        console.error('âŒ Ajax ì—ëŸ¬:', err);
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
      },
      complete: function () {
        __crewLoading = false;     // âœ… ë°˜ë“œì‹œ í•´ì œ (error/success ëª¨ë‘)
      }
    });
  }

  // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ë§Œ ë¶ˆëŸ¬ì˜¤ë„ë¡ ìœ ì§€
  $(document).ready(function () {
    // âŒ ìë™ ë™ë„¤ ì„¤ì • ì œê±°
    // localStorage.setItem("selectedDong", userDongs[0]); â† ì‚­ì œ

    // âœ… ë™ë„¤ ì •ë³´ëŠ” ìœ ì§€í•˜ì§€ë§Œ í•„í„°ë§ì€ í•˜ì§€ ì•ŠìŒ
    localStorage.removeItem("selectedDong"); // ğŸ‘‰ ë¬´ì¡°ê±´ ì‚­ì œ

    loadCrewList(true); // ğŸ”„ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
  });

  /* âœ… [ìˆ˜ì •] ì—”í„° ì…ë ¥ ì‹œ â€˜ë‹ë³´ê¸° í´ë¦­â€™ìœ¼ë¡œ ì™„ì „ ìœ„ì„ (ë²„íŠ¼ ë™ì‘ê³¼ 100% ë™ì¼ ê²½ë¡œ)
        - ê¸°ì¡´: ë™ í•„í„° ì œê±° í›„ loadCrewList(true) ì§ì ‘ í˜¸ì¶œ
        - ë³€ê²½: ë²„íŠ¼(#searchBtn)ì„ í´ë¦­ì‹œì¼œ í´ë¦­ê³¼ ë™ì¼ ë™ì‘ ë³´ì¥
        - ë²„íŠ¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ loadCrewList()ë¡œ í´ë°±
  */
  $(document).on('keydown', '#searchInput', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault(); // í¼ ì œì¶œ ë§‰ê¸°
      const btn = document.getElementById('searchBtn');
      if (btn) btn.click();        // âœ… ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ìœ„ì„(ë‹ë³´ê¸°ì™€ ë™ì¼)
      else loadCrewList();         // âœ… í´ë°± (UIì— ë²„íŠ¼ id ì—†ì„ ë•Œ)
    }
  });

</script>



	<script>
  // âœ… í˜„ì¬ ë¬¸ì„œê°€ ë¶€ëª¨ ëª¨ë‹¬ ë‚´ë¶€ì¼ ë•Œë§Œ ì‹œë„ (Cross-origin/undefined ì•ˆì „)
  try {
    if (window.parent && window.parent !== window
        && typeof window.parent.closeModal === 'function') {
      window.parent.closeModal();
    }
    if (window.parent && window.parent !== window
        && typeof window.parent.loadCrewList === 'function') {
      window.parent.loadCrewList();
    }
  } catch (e) {
    // ì½˜ì†”ì—ë§Œ ì°¸ê³  ë¡œê·¸ (ì„œë¹„ìŠ¤ ë™ì‘ì—” ì˜í–¥ ì—†ìŒ)
    console.debug('parent modal hooks not available:', e);
  }
</script>


</body>

</html>
