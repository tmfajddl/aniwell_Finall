<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" th:href="@{/resource/css/common.css}">
<title>í¬ë£¨ ëª¨ì§‘ ëª©ë¡</title>
</head>

<body class="bg-gradient-to-b from-[#e4f0b9] to-[#fcdca9] font-sans ">
	<div class="flex h-screen">
		<!-- Sidebar -->
		<div th:replace="common :: siteHeader"></div>

		<!-- Main content -->
		<main class="main_page min-h-screen flex-1 p-3">
			<div class="h-full w-full overflow-hidden">
				<div class="p-3 flex justify-around text-gray-800 grid grid-cols-12">
					<div class="col-span-3 p-3">
						<div id="crewAside"></div>

					</div>
					<div class="p-2 col-span-9 w-full flex flex-col mx-auto">
						<div class="h-[97%]">
							<div class="stickypb">
								<div class="w-full max-w-xl mx-auto">
									<div class="flex items-center bg-white border border-gray-200 shadow-sm rounded-full px-4 py-2">
										<form method="get" th:action="@{/usr/walkCrew/list}" class="flex w-full">
											<input type="text" name="query" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" th:value="${param.query}"
												class="flex-1 text-sm text-gray-800 bg-transparent outline-none placeholder:text-gray-400" />
											<button type="submit" class="ml-2 text-gray-500 hover:text-black">ğŸ”</button>
										</form>
									</div>
								</div>
								<div class="text-center">
									<button onclick="openModal()"
										class="my-6 mb-3 px-7 py-2 rounded-xl text-center font-semibold shadow bg-[#e4f0b9] hover:bg-[#FEEEA4]">
										ë“±ë¡í•˜ê¸°</button>
								</div>
							</div>

							<!-- ëª¨ë‹¬ -->
							<div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-around bg-black bg-opacity-50">
								<div
									class="relative w-[90%] max-w-[1000px] h-[700px] bg-transparent flex rounded-2xl overflow-hidden shadow-2xl">

									<!-- ì™¼ìª½ ì—°ë…¸ë‘ ë°°ê²½ -->
									<div class="w-full h-full flex bg-gradient-to-b from-[#FCE9A3] to-[#E0C878]">
										<div class="w-[5%] text-center">
											<button onclick="closeModal()" class="text-3xl font-light text-gray-600 hover:text-black">&times;</button>
										</div>
										<!-- ì˜¤ë¥¸ìª½ ë‚´ìš© -->
										<div class="relative flex-1 bg-white rounded-l-3xl">
											<!-- ìƒë‹¨ íšŒìƒ‰ ë°” -->
											<div class="px-6 py-4 rounded-tr-2xl flex justify-between items-center">
												<h2 class="text-lg font-bold text-gray-800">í¬ë£¨ ë“±ë¡</h2>

											</div>

											<!-- iframe ë‚´ìš© -->
											<div class="p-4 h-[calc(100%-4rem)] w-[100%]">
												<iframe src="/usr/walkCrew/create" class="h-[100%] w-[100%] p-1 border-none"></iframe>
											</div>
										</div>
									</div>
								</div>
							</div>


							<div class="overflow-y-auto w-full h-[80vh] pb-1 shadow">
								<div id="crewListContainer" class="p-4 space-y-4"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dfd275f49b78960a0458d6f6294cbde2&libraries=services"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		navigator.geolocation.getCurrentPosition(async (position) => {
			const {latitude, longitude} = position.coords;
			const geocoder = new kakao.maps.services.Geocoder();

			geocoder.coord2RegionCode(longitude, latitude, (result, status) => {
				if (status === kakao.maps.services.Status.OK) {
					const city = result[0].region_1depth_name;
					const district = result[0].region_2depth_name;


					console.log("ğŸ“ ì‹œ:", city, "êµ¬:", district);
					// ğŸ”¸ ë™ ë¦¬ìŠ¤íŠ¸ ìš”ì²­
					$.ajax({
						type: "GET",
						url: `/usr/walkCrew/getDongs`,
						data: {city, district},
						success: function (response) {
							console.log("âœ… ë™ ë¦¬ìŠ¤íŠ¸:", response);
							const dongs = response.data1.dongs;

							// ğŸ”¸ ë™ ë°°ì—´ì„ localStorageì— ì €ì¥ (JSON.stringify)
							localStorage.setItem("userCity", city);
							localStorage.setItem("userDistrict", district);
							localStorage.setItem("userDongs", JSON.stringify(dongs)); // ë°°ì—´ ì €ì¥

							// ğŸ”» ë™ì  HTML ìƒì„±
							const asideHTML = `
							  <aside class="bg-white p-6 shadow mx-auto h-[90%]]>
							    <h2 class="text-lg font-semibold mb-4">${city || 'ë¡œë”©ì¤‘'}</h2>
								<div class="text-xl font-semibold mb-4 border-b border-gray-300 pb-2">
								  ${district || 'ë¡œë”©ì¤‘'}
								</div>
								<div class="h-[70vh] overflow-y-auto">
							
							    <ul class="grid grid-cols-2 gap-2 text-sm text-gray-700">
							      ${dongs.map((dong) => `
							        <li>
							          <button
							            class="w-full px-1 py-2 text-left bg-gray-100 hover:bg-yellow-200 rounded-lg transition duration-200 ease-in-out shadow-sm hover:shadow-md"
							         
							          >
							            ${dong}
							          </button>
							        </li>
							      `).join('')}
							    </ul>
							    </div>
							  </aside>
							`;

							// ğŸ”» #crewAside ë‚´ë¶€ì— ë Œë”ë§
							$('#crewAside').html(asideHTML);
						},
						error: function (err) {
							console.error("âŒ ë™ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", err);
						}
					});
				}
			});
		});
	</script>
	<script>
		function openModal() {
			document.getElementById('modal').classList.remove('hidden');
		}
		function closeModal() {
			document.getElementById('modal').classList.add('hidden');
		}
	</script>

	<script>
	function loadCrewList() {
		const query = $('#searchInput').val();

		$.ajax({
			url: '/usr/walkCrew/api/list',
			method: 'GET',
			dataType: 'json',
			success: function (response) {
				if (response.resultCode !== 'S-1') {
					alert('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + response.msg);
					return;
				}

				const crewList = response.data1.crews;
				const container = $('#crewListContainer');
				container.empty();

				if (crewList.length === 0) {
					container.append('<p class="text-center text-gray-400">ë“±ë¡ëœ í¬ë£¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
					return;
				}

				crewList.forEach(crew => {
					if (query && !crew.title.includes(query) && !crew.description.includes(query)) return;

					const formattedDate = new Date(crew.createdAt).toLocaleDateString('ko-KR');

					// âœ… ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°ì—” <img>ë¡œ ì¶œë ¥, ì—†ìœ¼ë©´ íšŒìƒ‰ë°•ìŠ¤
					const thumbnail = crew.imageUrl
						? `<img src="${crew.imageUrl}" alt="í¬ë£¨ ì´ë¯¸ì§€" class="w-20 h-20 object-cover rounded-md shrink-0">`
						: `<div class="w-20 h-20 bg-gray-200 rounded-md shrink-0"></div>`;

					const html = `
						<div class="bg-white rounded-lg shadow p-4 flex gap-4 items-start cursor-pointer"
						     onclick="location.href='/usr/crewCafe/cafeHome?crewId=${crew.id}'">

						  <!-- âœ… ì´ë¯¸ì§€ or íšŒìƒ‰ë°•ìŠ¤ -->
						  ${thumbnail}

						  <div class="flex-1 space-y-2">
						    <h3 class="text-lg font-bold">${crew.title}</h3>
						    <p class="text-sm text-gray-700">${crew.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>

						    <div class="flex justify-between items-center gap-1 text-sm text-gray-600">
						      <div>${crew.city || ''} ${crew.district || ''} ${crew.dong || ''}</div>
							  <div class="text-xs text-gray-400">
							    ì‘ì„±ì: ${crew.nickname || 'ìµëª…'} Â· ${formattedDate}
							  </div>
						    </div>
						  </div>
						</div>
					`;
					container.append(html);
				});
			},
			error: function (err) {
				console.error('âŒ Ajax ì—ëŸ¬:', err);
				alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
			}
		});
	}

	$(document).ready(function () {
		loadCrewList();
	});
</script>

	<script>
		window.parent.closeModal(); // ëª¨ë‹¬ ë‹«ê¸°
		window.parent.loadCrewList(); // ëª¨ë‹¬ ë‹«ê³  ëª©ë¡ ê°±ì‹ 
	</script>



</body>

</html>